<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Studio Admin Dashboard - RinglyPro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .dashboard-header {
            background: white;
            border-bottom: 2px solid #e5e7eb;
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 1.5rem;
            color: #0a0a0a;
        }

        .stats-summary {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #6366f1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
        }

        /* Main Content - Horizontal Split */
        .dashboard-main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Left Panel - Orders List */
        .orders-panel {
            width: 400px;
            background: white;
            border-right: 2px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            background: #f8fafc;
        }

        .panel-header h2 {
            font-size: 1.125rem;
            color: #0a0a0a;
        }

        .orders-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .order-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .order-item:hover {
            border-color: #6366f1;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }

        .order-item.active {
            border-color: #6366f1;
            background: #f0f4ff;
        }

        .order-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .order-number {
            font-weight: 700;
            color: #0a0a0a;
        }

        .order-status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-processing {
            background: #fed7aa;
            color: #9a3412;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-awaiting_upload {
            background: #e0e7ff;
            color: #3730a3;
        }

        .order-customer {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .order-meta {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .approval-indicator {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .approval-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .dot-pending {
            background: #fbbf24;
        }

        .dot-approved {
            background: #22c55e;
        }

        .dot-rejected {
            background: #ef4444;
        }

        .dot-revision {
            background: #f59e0b;
        }

        /* Orders needing attention */
        .order-item.needs-attention {
            border-color: #f59e0b;
            border-width: 3px;
            background: #fffbeb;
        }

        .order-item.needs-attention:hover {
            border-color: #d97706;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .order-item.needs-attention.active {
            border-color: #d97706;
            background: #fef3c7;
        }

        .attention-badge {
            font-size: 1rem;
            margin-right: 0.25rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .attention-message {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #92400e;
        }

        /* Right Panel - Order Details */
        .details-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .details-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .order-detail-header {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .order-detail-title {
            font-size: 1.5rem;
            color: #0a0a0a;
            margin-bottom: 1rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .detail-item {
            padding: 0.75rem;
            background: #f8fafc;
            border-radius: 0.5rem;
        }

        .detail-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: #0a0a0a;
        }

        /* Photos Grid - Horizontal Layout */
        .photos-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.25rem;
            color: #0a0a0a;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .photos-horizontal-grid {
            display: flex;
            gap: 1.5rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .photo-card {
            flex: 0 0 400px;
            background: #f8fafc;
            border-radius: 0.75rem;
            padding: 1rem;
            border: 2px solid #e5e7eb;
        }

        .photo-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .photo-wrapper {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            background: white;
        }

        .photo-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-badge {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .badge-before {
            background: rgba(239, 68, 68, 0.9);
        }

        .badge-after {
            background: rgba(34, 197, 94, 0.9);
        }

        .photo-info {
            margin-bottom: 1rem;
        }

        .photo-filename {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0a0a0a;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }

        .photo-approval-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-revision {
            background: #fed7aa;
            color: #9a3412;
        }

        .photo-feedback {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #6366f1;
            margin-bottom: 1rem;
        }

        .feedback-label {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .feedback-text {
            font-size: 0.875rem;
            color: #0a0a0a;
            white-space: pre-wrap;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .upload-zone {
            position: relative;
            margin: 1.5rem 0;
        }

        .file-input {
            display: none;
        }

        .upload-label {
            display: block;
            padding: 3rem 2rem;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-label:hover {
            background: #f1f5f9;
            border-color: #6366f1;
        }

        .upload-label.drag-over {
            background: #e0e7ff;
            border-color: #6366f1;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0a0a0a;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: #64748b;
        }

        .selected-files-list {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .selected-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .selected-file-name {
            font-size: 0.875rem;
            color: #0a0a0a;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .selected-file-size {
            font-size: 0.75rem;
            color: #64748b;
            margin: 0 1rem;
        }

        .remove-file-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
        }

        .photo-meta {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        /* Before/After Upload Grid */
        .before-after-upload-grid {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .before-after-upload-item {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 2rem;
            align-items: center;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 0.75rem;
            border: 2px solid #e5e7eb;
        }

        .before-photo {
            text-align: center;
        }

        .before-photo img {
            width: 100%;
            max-width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #e5e7eb;
            margin: 0.5rem 0;
        }

        .photo-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .photo-name {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.5rem;
            word-break: break-all;
        }

        .arrow-separator {
            font-size: 2rem;
            color: #6366f1;
            font-weight: bold;
        }

        .after-photo-upload {
            text-align: center;
        }

        .upload-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 300px;
            height: 200px;
            margin: 0.5rem auto;
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-box:hover {
            background: #f1f5f9;
            border-color: #6366f1;
        }

        .upload-box .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .upload-box .upload-text {
            font-size: 0.875rem;
            color: #64748b;
            text-align: center;
            line-height: 1.4;
        }

        .upload-preview {
            margin: 0.5rem auto;
            max-width: 300px;
        }

        .upload-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #6366f1;
        }

        .upload-status-small {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            min-height: 1.5rem;
        }

        .enhanced-preview {
            width: 100%;
            max-width: 300px;
            margin: 0.5rem auto;
        }

        .enhanced-preview img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 2px solid #16a34a;
            margin-bottom: 0.5rem;
        }

        .enhanced-info {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .enhanced-status {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0a0a0a;
            margin-bottom: 0.25rem;
        }

        .customer-feedback-small {
            font-size: 0.75rem;
            color: #64748b;
            font-style: italic;
            margin-top: 0.25rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 0.25rem;
        }

        .btn-outline {
            background: white;
            border: 2px solid #6366f1;
            color: #6366f1;
        }

        .btn-outline:hover {
            background: #6366f1;
            color: white;
        }

        @media (max-width: 1024px) {
            .before-after-upload-item {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .arrow-separator {
                transform: rotate(90deg);
            }
        }

        /* Communications Section */
        .communications-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .comm-thread {
            max-height: 400px;
            overflow-y: auto;
        }

        .comm-item {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .comm-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .comm-from {
            font-weight: 600;
            color: #0a0a0a;
        }

        .comm-date {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .comm-subject {
            font-weight: 600;
            color: #6366f1;
            margin-bottom: 0.5rem;
        }

        .comm-message {
            font-size: 0.875rem;
            color: #64748b;
        }

        .comm-form {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e5e7eb;
        }

        .comm-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.875rem;
            resize: vertical;
            margin-bottom: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #6366f1;
            border: 2px solid #6366f1;
        }

        .btn-secondary:hover {
            background: #6366f1;
            color: white;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 1024px) {
            .dashboard-main {
                flex-direction: column;
            }

            .orders-panel {
                width: 100%;
                max-height: 40vh;
                border-right: none;
                border-bottom: 2px solid #e5e7eb;
            }

            .photos-horizontal-grid {
                flex-direction: column;
            }

            .photo-card {
                flex: 1 1 auto;
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1rem;
            }

            .stats-summary {
                gap: 1rem;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .orders-panel {
                max-height: 50vh;
            }

            .details-content {
                padding: 1rem;
            }

            .photo-comparison {
                grid-template-columns: 1fr;
            }
        }

        /* Completion Modal Styles */
        .completion-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .completion-modal-overlay.active {
            display: flex;
        }

        .completion-modal {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .completion-modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .completion-modal-header h2 {
            font-size: 1.25rem;
            color: #0a0a0a;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .completion-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .completion-modal-close:hover {
            background: #f1f5f9;
            color: #0a0a0a;
        }

        .completion-modal-body {
            padding: 2rem;
        }

        .completion-modal-info {
            background: #f0fdf4;
            border: 1px solid #22c55e;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .completion-modal-info p {
            color: #15803d;
            font-size: 0.875rem;
            margin: 0;
        }

        .completion-modal-label {
            font-weight: 600;
            color: #0a0a0a;
            margin-bottom: 0.5rem;
            display: block;
        }

        .completion-modal-required {
            color: #ef4444;
            margin-left: 0.25rem;
        }

        .completion-modal-textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .completion-modal-textarea:focus {
            outline: none;
            border-color: #6366f1;
        }

        .completion-modal-textarea::placeholder {
            color: #94a3b8;
        }

        .completion-modal-hint {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .completion-modal-footer {
            padding: 1.5rem 2rem;
            border-top: 2px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .completion-modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .completion-modal-btn-cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .completion-modal-btn-cancel:hover {
            background: #e2e8f0;
            color: #0a0a0a;
        }

        .completion-modal-btn-submit {
            background: #22c55e;
            color: white;
        }

        .completion-modal-btn-submit:hover {
            background: #16a34a;
        }

        .completion-modal-btn-submit:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .char-counter {
            text-align: right;
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .char-counter.warning {
            color: #f59e0b;
        }

        .char-counter.error {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <!-- Completion Modal -->
    <div class="completion-modal-overlay" id="completion-modal">
        <div class="completion-modal">
            <div class="completion-modal-header">
                <h2>üìß Complete Order & Notify Customer</h2>
                <button class="completion-modal-close" onclick="closeCompletionModal()">&times;</button>
            </div>
            <div class="completion-modal-body">
                <div class="completion-modal-info">
                    <p>‚úÖ All photos have been enhanced! Write a personalized message to the customer before completing this order.</p>
                </div>

                <label class="completion-modal-label">
                    Message to Customer<span class="completion-modal-required">*</span>
                </label>
                <textarea
                    class="completion-modal-textarea"
                    id="completion-message"
                    placeholder="Hi [Customer Name],

Great news! Your enhanced photos are ready for download.

We've carefully enhanced each photo with professional adjustments to lighting, colors, and detail. We hope you love the results!

If you have any questions or need any revisions, please don't hesitate to reach out.

Best regards,
The Photo Studio Team"
                    oninput="updateCharCounter()"
                ></textarea>
                <div class="char-counter" id="char-counter">0 / 50 minimum characters</div>
                <p class="completion-modal-hint">This message will be included in the completion email sent to the customer.</p>
            </div>
            <div class="completion-modal-footer">
                <button class="completion-modal-btn completion-modal-btn-cancel" onclick="closeCompletionModal()">Cancel</button>
                <button class="completion-modal-btn completion-modal-btn-submit" id="submit-completion-btn" onclick="submitOrderCompletion()" disabled>
                    Complete Order & Send Email
                </button>
            </div>
        </div>
    </div>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-content">
                <div class="header-title">
                    <img src="https://storage.googleapis.com/msgsndr/3lSeAHXNU9t09Hhp9oai/media/69175f336c431e834ac954b8.png" alt="RinglyPro" style="height: 40px;">
                    <h1>Photo Studio Admin Dashboard</h1>
                </div>
                <div class="stats-summary" id="stats-summary">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-total">-</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-pending">-</div>
                        <div class="stat-label">Pending Review</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-revisions">-</div>
                        <div class="stat-label">Revisions</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="dashboard-main">
            <!-- Left Panel: Orders List -->
            <div class="orders-panel">
                <div class="panel-header">
                    <h2>Active Orders</h2>
                </div>
                <div class="orders-list" id="orders-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Order Details -->
            <div class="details-panel">
                <div class="details-content" id="details-content">
                    <div class="empty-state">
                        <div class="empty-state-icon">üì∏</div>
                        <h3>Select an order to view details</h3>
                        <p style="margin-top: 0.5rem;">Choose an order from the list to see photos and communications</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let selectedOrderId = null;
        let designBriefs = {}; // Store design briefs by orderId

        // Get auth token
        function getAuthToken() {
            return localStorage.getItem('photoStudioAdminToken') || sessionStorage.getItem('photoStudioAdminToken');
        }

        // Load all orders
        async function loadOrders() {
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/photo-studio-admin-login?redirect=/photo-studio-admin-dashboard';
                    return;
                }

                const response = await fetch('/api/photo-studio/admin/all-orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Check for authentication errors
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('photoStudioAdminToken');
                    sessionStorage.removeItem('photoStudioAdminToken');
                    window.location.href = '/photo-studio-admin-login?redirect=/photo-studio-admin-dashboard';
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    allOrders = data.orders;
                    updateStats();
                    renderOrdersList();
                } else {
                    console.error('Failed to load orders:', data.error);
                    document.getElementById('orders-list').innerHTML =
                        '<div style="padding: 2rem; text-align: center; color: #ef4444;">Failed to load orders. Please refresh the page.</div>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orders-list').innerHTML =
                    '<div style="padding: 2rem; text-align: center; color: #ef4444;">Error loading orders. Please refresh the page.</div>';
            }
        }

        // Update stats
        function updateStats() {
            const total = allOrders.length;
            const pending = allOrders.reduce((acc, order) => {
                return acc + (order.enhanced_photos || []).filter(p => p.approval_status === 'pending').length;
            }, 0);
            const revisions = allOrders.reduce((acc, order) => {
                return acc + (order.enhanced_photos || []).filter(p => p.approval_status === 'revision_requested').length;
            }, 0);

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-revisions').textContent = revisions;
        }

        // Render orders list
        function renderOrdersList() {
            const container = document.getElementById('orders-list');

            if (allOrders.length === 0) {
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #94a3b8;">No orders found</div>';
                return;
            }

            container.innerHTML = allOrders.map(order => {
                const photos = order.enhanced_photos || [];
                const statusCounts = {
                    pending: photos.filter(p => p.approval_status === 'pending').length,
                    approved: photos.filter(p => p.approval_status === 'approved').length,
                    rejected: photos.filter(p => p.approval_status === 'rejected').length,
                    revision: photos.filter(p => p.approval_status === 'revision_requested').length
                };

                // Determine if order needs attention (processing orders, has revisions or rejections)
                // Completed orders should NOT be highlighted
                const isCompleted = order.order_status === 'completed';
                const isProcessing = order.order_status === 'processing';
                const needsAttention = !isCompleted && (isProcessing || statusCounts.revision > 0 || statusCounts.rejected > 0);
                const attentionClass = needsAttention ? 'needs-attention' : '';

                return `
                    <div class="order-item ${selectedOrderId === order.id ? 'active' : ''} ${attentionClass}" onclick="selectOrder(${order.id})">
                        <div class="order-item-header">
                            <span class="order-number">
                                ${needsAttention ? '<span class="attention-badge">‚ö†Ô∏è</span>' : ''}
                                Order #${order.id}
                            </span>
                            <span class="order-status-badge status-${order.order_status}">${order.order_status}</span>
                        </div>
                        <div class="order-customer">${order.customer_name || 'Unknown'}</div>
                        <div class="order-meta">${order.package_type.toUpperCase()} ‚Ä¢ ${photos.length} photos</div>
                        ${photos.length > 0 ? `
                            <div class="approval-indicator">
                                ${Array(statusCounts.pending).fill('<div class="approval-dot dot-pending"></div>').join('')}
                                ${Array(statusCounts.approved).fill('<div class="approval-dot dot-approved"></div>').join('')}
                                ${Array(statusCounts.rejected).fill('<div class="approval-dot dot-rejected"></div>').join('')}
                                ${Array(statusCounts.revision).fill('<div class="approval-dot dot-revision"></div>').join('')}
                            </div>
                        ` : ''}
                        ${needsAttention ? `
                            <div class="attention-message">
                                ${isProcessing ? 'üîÑ Processing' : ''}
                                ${isProcessing && (statusCounts.revision > 0 || statusCounts.rejected > 0) ? ' ‚Ä¢ ' : ''}
                                ${statusCounts.revision > 0 ? `${statusCounts.revision} revision${statusCounts.revision > 1 ? 's' : ''} requested` : ''}
                                ${statusCounts.revision > 0 && statusCounts.rejected > 0 ? ' ‚Ä¢ ' : ''}
                                ${statusCounts.rejected > 0 ? `${statusCounts.rejected} rejected` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Select order
        async function selectOrder(orderId) {
            selectedOrderId = orderId;
            renderOrdersList();
            await loadOrderDetails(orderId);
        }

        // Load order details
        async function loadOrderDetails(orderId) {
            const container = document.getElementById('details-content');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const token = getAuthToken();
                const response = await fetch(`/api/photo-studio/admin/order/${orderId}/details`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    renderOrderDetails(data.order, data.enhanced_photos, data.original_photos, data.communications);
                } else {
                    console.error('Failed to load order details:', data.error, data.details);
                    container.innerHTML = `<div style="padding: 2rem; text-align: center; color: #ef4444;">Failed to load order details: ${data.error || 'Unknown error'}${data.details ? ' - ' + data.details : ''}</div>`;
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #ef4444;">Failed to load order details</div>';
            }
        }

        // Render order details
        function renderOrderDetails(order, enhancedPhotos, originalPhotos, communications) {
            const container = document.getElementById('details-content');

            // Debug logging
            console.log('[Render] Order ID:', order.id);
            console.log('[Render] Enhanced photos count:', enhancedPhotos.length);
            console.log('[Render] Enhanced photos:', enhancedPhotos);
            console.log('[Render] Original photos count:', originalPhotos.length);

            container.innerHTML = `
                <div class="order-detail-header">
                    <h2 class="order-detail-title">Order #${order.id} - ${order.customer_name || 'Unknown'}</h2>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Customer Email</div>
                            <div class="detail-value"><a href="mailto:${order.customer_email}">${order.customer_email}</a></div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Package</div>
                            <div class="detail-value">${order.package_type.toUpperCase()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Order Date</div>
                            <div class="detail-value">${new Date(order.order_date).toLocaleDateString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status</div>
                            <div class="detail-value">${order.order_status}</div>
                        </div>
                    </div>
                </div>

                ${renderDesignBriefSection(order.id)}

                <div class="photos-section">
                    <h3 class="section-title">
                        <span style="font-size: 1.5rem;">üì§</span>
                        Customer Uploaded Photos
                    </h3>
                    <div class="photos-horizontal-grid">
                        ${originalPhotos.length > 0 ? originalPhotos.map(photo => `
                            <div class="photo-card">
                                <div class="photo-wrapper">
                                    <img src="${photo.storage_url}" alt="${photo.original_filename}" loading="lazy">
                                </div>
                                <div class="photo-info">
                                    <div class="photo-filename">${photo.original_filename}</div>
                                    <div class="photo-meta">${(photo.file_size / 1024 / 1024).toFixed(2)} MB</div>
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="downloadPhoto('${photo.storage_url}', '${photo.original_filename}')">
                                    ‚¨áÔ∏è Download
                                </button>
                            </div>
                        `).join('') : '<p style="color: #94a3b8;">No photos uploaded by customer yet</p>'}
                    </div>
                </div>

                <div class="upload-section">
                    <h3 class="section-title">
                        <span style="font-size: 1.5rem;">‚¨ÜÔ∏è</span>
                        Upload Enhanced Photos (Before & After)
                    </h3>
                    <p style="color: #64748b; margin-bottom: 1.5rem;">Upload enhanced versions for each customer photo. They will be displayed side-by-side for customer approval.</p>

                    ${originalPhotos.length > 0 ? `
                        <div class="before-after-upload-grid">
                            ${originalPhotos.map((photo, index) => {
                                // Find enhanced photo for this original
                                const enhanced = enhancedPhotos.find(e => e.original_photo_id === photo.id);
                                return `
                                <div class="before-after-upload-item">
                                    <div class="before-photo">
                                        <div class="photo-label">Original Photo ${index + 1}</div>
                                        <img src="${photo.storage_url}" alt="${photo.original_filename}" loading="lazy">
                                        <div class="photo-name">${photo.original_filename}</div>
                                        <button class="btn btn-sm" style="width: 100%; margin-top: 0.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;" onclick="enhancePhotoWithAI(${order.id}, ${photo.id})">
                                            üé® AI Enhance This Photo
                                        </button>
                                        <div id="ai-enhance-status-${order.id}-${photo.id}" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                                    </div>
                                    <div class="arrow-separator">‚Üí</div>
                                    <div class="after-photo-upload" id="after-container-${order.id}-${photo.id}">
                                        <div class="photo-label">Enhanced Version</div>
                                        ${enhanced ? `
                                            <div class="enhanced-preview" id="enhanced-preview-${order.id}-${photo.id}">
                                                <img src="${enhanced.storage_url}" alt="${enhanced.filename}" loading="lazy">
                                                <div class="enhanced-info">
                                                    <div class="enhanced-status">
                                                        ${enhanced.approval_status === 'approved' ? '‚úÖ Approved' :
                                                          enhanced.approval_status === 'rejected' ? '‚ùå Rejected' :
                                                          enhanced.approval_status === 'revision_requested' ? 'üîÑ Revision Requested' :
                                                          '‚è≥ Pending Review'}
                                                    </div>
                                                    <div class="photo-name">${enhanced.filename}</div>
                                                    ${enhanced.customer_feedback ? `<div class="customer-feedback-small">Customer: "${enhanced.customer_feedback}"</div>` : ''}
                                                </div>
                                                <button class="btn btn-secondary btn-sm" style="width: 100%; margin-top: 0.5rem;" onclick="downloadPhoto('${enhanced.storage_url}', '${enhanced.filename}')">
                                                    ‚¨áÔ∏è Download Current Version
                                                </button>
                                                <button class="btn btn-outline btn-sm" style="width: 100%; margin-top: 0.5rem;" onclick="showReplaceUpload(${order.id}, ${photo.id}, ${enhanced.id})">
                                                    üîÑ Upload Replacement
                                                </button>
                                            </div>
                                            <div id="replace-upload-${order.id}-${photo.id}" style="display: none;">
                                                <input type="file" id="replace-input-${order.id}-${photo.id}" class="file-input" accept="image/jpeg,image/jpg,image/png,image/webp" data-original-id="${photo.id}" data-enhanced-id="${enhanced.id}">
                                                <label for="replace-input-${order.id}-${photo.id}" class="upload-box" id="replace-box-${order.id}-${photo.id}">
                                                    <div class="upload-icon">üì∏</div>
                                                    <div class="upload-text">Click to upload<br>replacement photo</div>
                                                </label>
                                                <div id="replace-preview-container-${order.id}-${photo.id}" style="display: none;">
                                                    <div class="enhanced-preview">
                                                        <img id="replace-preview-img-${order.id}-${photo.id}" src="" alt="Preview" loading="lazy">
                                                    </div>
                                                    <button class="btn btn-primary btn-sm" id="replace-upload-btn-${order.id}-${photo.id}" style="width: 100%; margin-top: 0.5rem;" onclick="uploadReplacement(${order.id}, ${photo.id}, ${enhanced.id})">
                                                        Upload Replacement
                                                    </button>
                                                </div>
                                                <button class="btn btn-secondary btn-sm" style="width: 100%; margin-top: 0.5rem;" onclick="cancelReplace(${order.id}, ${photo.id})">
                                                    Cancel
                                                </button>
                                            </div>
                                        ` : `
                                            <input type="file" id="enhanced-input-${order.id}-${photo.id}" class="file-input" accept="image/jpeg,image/jpg,image/png,image/webp" data-original-id="${photo.id}">
                                            <label for="enhanced-input-${order.id}-${photo.id}" class="upload-box" id="upload-box-${order.id}-${photo.id}">
                                                <div class="upload-icon">üì∏</div>
                                                <div class="upload-text">Click to upload<br>enhanced version</div>
                                            </label>
                                            <div id="preview-container-${order.id}-${photo.id}" style="display: none;">
                                                <div class="enhanced-preview">
                                                    <img id="preview-img-${order.id}-${photo.id}" src="" alt="Preview" loading="lazy">
                                                </div>
                                                <button class="btn btn-primary btn-sm" id="upload-single-btn-${order.id}-${photo.id}" style="width: 100%; margin-top: 0.5rem;" onclick="uploadSingleEnhanced(${order.id}, ${photo.id})">
                                                    Upload Enhanced Version
                                                </button>
                                            </div>
                                        `}
                                        <div id="status-${order.id}-${photo.id}" class="upload-status-small"></div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        ${order.order_status === 'completed' ? `
                            <div style="margin-top: 2rem; padding: 1.5rem; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 0.75rem; text-align: center;">
                                <p style="color: #15803d; font-weight: 600; font-size: 1.125rem;">‚úÖ Order Completed</p>
                                <p style="color: #16a34a; margin-top: 0.5rem;">Customer has been notified and can download their enhanced photos.</p>
                            </div>
                        ` : originalPhotos.every(photo => enhancedPhotos.find(e => e.original_photo_id === photo.id)) ? `
                            <div style="margin-top: 2rem; padding: 1.5rem; background: #f0fdf4; border: 2px solid #22c55e; border-radius: 0.75rem; text-align: center;">
                                <p style="color: #15803d; font-weight: 600; margin-bottom: 1rem;">‚úÖ All photos have been enhanced!</p>
                                <button class="btn btn-primary" style="font-size: 1.125rem; padding: 1rem 2rem;" onclick="markOrderAsCompleted(${order.id})">
                                    üìß Mark Order as Completed & Notify Customer
                                </button>
                            </div>
                        ` : ''}
                    ` : '<p style="color: #94a3b8;">Customer has not uploaded any photos yet</p>'}
                </div>

                <div class="communications-section">
                    <h3 class="section-title">
                        <span style="font-size: 1.5rem;">üí¨</span>
                        Communications
                    </h3>
                    <div class="comm-thread">
                        ${communications.length > 0 ? communications.map(comm => `
                            <div class="comm-item">
                                <div class="comm-header">
                                    <span class="comm-from">${comm.from_type === 'customer' ? order.customer_name : 'Admin'}</span>
                                    <span class="comm-date">${new Date(comm.created_at).toLocaleString()}</span>
                                </div>
                                <div class="comm-subject">${comm.subject}</div>
                                <div class="comm-message">${comm.message}</div>
                            </div>
                        `).join('') : '<p style="color: #94a3b8;">No communications yet</p>'}
                    </div>
                    <div class="comm-form">
                        <h4 style="margin-bottom: 1rem;">Send Message to Customer</h4>
                        <textarea id="message-text" placeholder="Type your message to the customer..."></textarea>
                        <button class="btn btn-primary" onclick="sendMessage(${order.id}, '${order.customer_email}')">
                            Send Email to Customer
                        </button>
                    </div>
                </div>
            `;
        }

        // Send message to customer
        async function sendMessage(orderId, customerEmail) {
            const textarea = document.getElementById('message-text');
            const message = textarea.value.trim();

            if (!message) {
                alert('Please enter a message');
                return;
            }

            try {
                const token = getAuthToken();
                const response = await fetch(`/api/photo-studio/admin/order/${orderId}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Message sent successfully!');
                    textarea.value = '';
                    await loadOrderDetails(orderId);
                } else {
                    throw new Error(data.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message: ' + error.message);
            }
        }

        // Download photo - fixed to handle CORS and presigned URLs
        async function downloadPhoto(url, filename) {
            try {
                // Create a temporary link and trigger download
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || 'photo.jpg';
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Download error:', error);
                alert('Failed to download photo. The photo link may have expired. Please refresh the page.');
            }
        }

        // Upload single enhanced photo for a specific original photo
        async function uploadSingleEnhanced(orderId, originalPhotoId) {
            const fileInput = document.getElementById(`enhanced-input-${orderId}-${originalPhotoId}`);
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a photo to upload');
                return;
            }

            const uploadBtn = document.getElementById(`upload-single-btn-${orderId}-${originalPhotoId}`);
            const statusDiv = document.getElementById(`status-${orderId}-${originalPhotoId}`);

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            statusDiv.innerHTML = '<div style="color: #6366f1;">Uploading...</div>';

            const formData = new FormData();
            formData.append('photos', file);
            formData.append('original_photo_id', originalPhotoId);

            console.log('[Upload] Starting upload:', {
                orderId,
                originalPhotoId,
                filename: file.name,
                size: file.size,
                type: file.type
            });

            try {
                const token = getAuthToken();
                console.log('[Upload] Token exists:', !!token);

                const response = await fetch(`/api/photo-studio/admin/order/${orderId}/upload-enhanced`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                console.log('[Upload] Response status:', response.status);

                const data = await response.json();
                console.log('[Upload] Response data:', data);

                if (data.success) {
                    // Check if any uploads actually succeeded
                    const successCount = (data.uploads || []).filter(u => u.success).length;
                    console.log('[Upload] Success count:', successCount, 'of', (data.uploads || []).length);

                    if (successCount === 0) {
                        // Upload failed - log error details
                        console.error('[Upload] Upload failed despite success=true response');
                        console.error('[Upload] Upload results:', data.uploads);

                        const failedUpload = data.uploads.find(u => !u.success);
                        if (failedUpload) {
                            console.error('[Upload] Error message:', failedUpload.error);
                            console.error('[Upload] Error stack:', failedUpload.errorStack);
                            throw new Error(failedUpload.error || 'Database insert failed');
                        }
                        throw new Error('Upload failed - no files were saved');
                    }

                    statusDiv.innerHTML = '<div style="color: #16a34a;">‚úÖ Upload successful! Loading enhanced photo...</div>';

                    // Wait a moment then reload just this order's details to show the enhanced photo
                    setTimeout(() => {
                        console.log('[Upload] Reloading order details...');
                        loadOrderDetails(orderId);
                    }, 800);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('[Upload] Error:', error);
                statusDiv.innerHTML = `<div style="color: #991b1b;">‚ùå ${error.message}</div>`;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Enhanced';
            }
        }

        // Setup file input for enhanced photos upload
        function setupEnhancedUpload(orderId, originalPhotos) {
            if (!originalPhotos || originalPhotos.length === 0) return;

            originalPhotos.forEach(photo => {
                const fileInput = document.getElementById(`enhanced-input-${orderId}-${photo.id}`);
                const uploadBox = document.getElementById(`upload-box-${orderId}-${photo.id}`);
                const previewContainer = document.getElementById(`preview-container-${orderId}-${photo.id}`);
                const previewImg = document.getElementById(`preview-img-${orderId}-${photo.id}`);

                if (!fileInput) return;

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        fileInput.value = '';
                        return;
                    }

                    // Show preview in same frame (hide upload box, show preview)
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        previewImg.src = event.target.result;
                        uploadBox.style.display = 'none';
                        previewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                });
            });
        }

        // Track which order is being completed
        let pendingCompletionOrderId = null;

        // Default message template for order completion
        const defaultCompletionMessage = 'Hi,\n\nGreat news! Your enhanced photos are ready for download.\nWe\'ve carefully enhanced each photo with professional adjustments to lighting, colors, and detail. We hope you love the results!\n\nRegards, PixlyPro Design Team';

        // Show the completion modal
        function markOrderAsCompleted(orderId) {
            pendingCompletionOrderId = orderId;
            document.getElementById('completion-message').value = defaultCompletionMessage;
            updateCharCounter();
            document.getElementById('completion-modal').classList.add('active');
        }

        // Close the completion modal
        function closeCompletionModal() {
            document.getElementById('completion-modal').classList.remove('active');
            pendingCompletionOrderId = null;
        }

        // Update character counter and enable/disable submit button
        function updateCharCounter() {
            const textarea = document.getElementById('completion-message');
            const counter = document.getElementById('char-counter');
            const submitBtn = document.getElementById('submit-completion-btn');
            const charCount = textarea.value.trim().length;
            const minChars = 50;

            counter.textContent = `${charCount} / ${minChars} minimum characters`;

            if (charCount < minChars) {
                counter.className = 'char-counter error';
                submitBtn.disabled = true;
            } else {
                counter.className = 'char-counter';
                submitBtn.disabled = false;
            }
        }

        // Submit order completion with message
        async function submitOrderCompletion() {
            const message = document.getElementById('completion-message').value.trim();

            if (message.length < 50) {
                alert('Please write a message of at least 50 characters to the customer.');
                return;
            }

            if (!pendingCompletionOrderId) {
                alert('Error: No order selected');
                return;
            }

            const submitBtn = document.getElementById('submit-completion-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Completing...';

            try {
                const token = getAuthToken();
                const response = await fetch(`/api/photo-studio/admin/order/${pendingCompletionOrderId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ completion_message: message })
                });

                const data = await response.json();

                if (data.success) {
                    closeCompletionModal();
                    alert('‚úÖ Order marked as completed! Customer has been notified via email with your message.');
                    // Reload order details and orders list
                    await loadOrderDetails(pendingCompletionOrderId);
                    await loadOrders();
                } else {
                    throw new Error(data.error || 'Failed to complete order');
                }
            } catch (error) {
                console.error('Error completing order:', error);
                alert('Failed to mark order as completed: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Complete Order & Send Email';
            }
        }

        // Close modal when clicking outside
        document.getElementById('completion-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCompletionModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('completion-modal').classList.contains('active')) {
                closeCompletionModal();
            }
        });

        // Show replace upload interface
        function showReplaceUpload(orderId, originalPhotoId, enhancedId) {
            // Hide the current enhanced photo preview
            const previewDiv = document.getElementById(`enhanced-preview-${orderId}-${originalPhotoId}`);
            const replaceDiv = document.getElementById(`replace-upload-${orderId}-${originalPhotoId}`);

            if (previewDiv && replaceDiv) {
                previewDiv.style.display = 'none';
                replaceDiv.style.display = 'block';

                // Setup file input listener
                setupReplaceFileInput(orderId, originalPhotoId);
            }
        }

        // Cancel replace and show original enhanced photo again
        function cancelReplace(orderId, originalPhotoId) {
            const previewDiv = document.getElementById(`enhanced-preview-${orderId}-${originalPhotoId}`);
            const replaceDiv = document.getElementById(`replace-upload-${orderId}-${originalPhotoId}`);

            if (previewDiv && replaceDiv) {
                previewDiv.style.display = 'block';
                replaceDiv.style.display = 'none';

                // Clear file input
                const fileInput = document.getElementById(`replace-input-${orderId}-${originalPhotoId}`);
                if (fileInput) {
                    fileInput.value = '';
                }

                // Hide preview
                const previewContainer = document.getElementById(`replace-preview-container-${orderId}-${originalPhotoId}`);
                const uploadBox = document.getElementById(`replace-box-${orderId}-${originalPhotoId}`);
                if (previewContainer && uploadBox) {
                    previewContainer.style.display = 'none';
                    uploadBox.style.display = 'flex';
                }
            }
        }

        // Setup replace file input
        function setupReplaceFileInput(orderId, originalPhotoId) {
            const fileInput = document.getElementById(`replace-input-${orderId}-${originalPhotoId}`);
            const uploadBox = document.getElementById(`replace-box-${orderId}-${originalPhotoId}`);
            const previewContainer = document.getElementById(`replace-preview-container-${orderId}-${originalPhotoId}`);
            const previewImg = document.getElementById(`replace-preview-img-${orderId}-${originalPhotoId}`);

            if (!fileInput) return;

            // Remove any existing listeners
            const newFileInput = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(newFileInput, fileInput);

            newFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file');
                    newFileInput.value = '';
                    return;
                }

                // Show preview
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewImg.src = event.target.result;
                    uploadBox.style.display = 'none';
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        }

        // Upload replacement photo
        async function uploadReplacement(orderId, originalPhotoId, oldEnhancedId) {
            const fileInput = document.getElementById(`replace-input-${orderId}-${originalPhotoId}`);
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a photo to upload');
                return;
            }

            const uploadBtn = document.getElementById(`replace-upload-btn-${orderId}-${originalPhotoId}`);
            const statusDiv = document.getElementById(`status-${orderId}-${originalPhotoId}`);

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            statusDiv.innerHTML = '<div style="color: #6366f1;">Uploading replacement...</div>';

            const formData = new FormData();
            formData.append('photos', file);
            formData.append('original_photo_id', originalPhotoId);
            formData.append('replace_enhanced_id', oldEnhancedId); // Tell backend to delete old one

            try {
                const token = getAuthToken();

                const response = await fetch(`/api/photo-studio/admin/order/${orderId}/upload-enhanced`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    const successCount = (data.uploads || []).filter(u => u.success).length;

                    if (successCount === 0) {
                        const failedUpload = data.uploads.find(u => !u.success);
                        throw new Error(failedUpload?.error || 'Upload failed');
                    }

                    statusDiv.innerHTML = '<div style="color: #16a34a;">‚úÖ Replacement uploaded! Reloading...</div>';

                    // Reload order details to show new enhanced photo
                    setTimeout(() => {
                        loadOrderDetails(orderId);
                    }, 800);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('[Replace Upload] Error:', error);
                statusDiv.innerHTML = `<div style="color: #991b1b;">‚ùå ${error.message}</div>`;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Replacement';
            }
        }

        // Call setup after rendering order details
        const originalRenderOrderDetails = window.renderOrderDetails;
        window.renderOrderDetails = function(order, enhancedPhotos, originalPhotos, communications) {
            const result = originalRenderOrderDetails(order, enhancedPhotos, originalPhotos, communications);
            setTimeout(() => setupEnhancedUpload(order.id, originalPhotos), 100);
            loadDesignBrief(order.id); // Load design brief for selected order
            return result;
        };

        // ===== DESIGN BRIEF FUNCTIONS =====

        // Load design brief for an order
        async function loadDesignBrief(orderId) {
            try {
                const token = getAuthToken();
                const response = await fetch(`/api/photo-studio/order/${orderId}/brief`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success && data.brief) {
                    designBriefs[orderId] = data.brief;
                    updateDesignBriefDisplay(orderId);
                }
            } catch (error) {
                console.error('Error loading design brief:', error);
            }
        }

        // Render design brief section
        function renderDesignBriefSection(orderId) {
            return `
                <div class="photos-section" id="design-brief-section-${orderId}">
                    <h3 class="section-title">
                        <span style="font-size: 1.5rem;">üìã</span>
                        Design Brief
                    </h3>
                    <div id="design-brief-content-${orderId}" style="color: #94a3b8;">
                        Loading design brief...
                    </div>
                </div>
            `;
        }

        // Update design brief display
        function updateDesignBriefDisplay(orderId) {
            const container = document.getElementById(`design-brief-content-${orderId}`);
            if (!container) return;

            const brief = designBriefs[orderId];

            if (!brief) {
                container.innerHTML = '<p style="color: #94a3b8;">Customer has not completed their design brief yet.</p>';
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <!-- Brief Details -->
                    <div style="display: grid; gap: 1rem; background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; font-size: 0.875rem;">
                            <div>
                                <div style="font-weight: 600; color: #0a0a0a; margin-bottom: 0.25rem;">Business</div>
                                <div style="color: #64748b;">${brief.business_name} (${brief.business_type})</div>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #0a0a0a; margin-bottom: 0.25rem;">Design Need</div>
                                <div style="color: #64748b;">${brief.primary_design_need}</div>
                            </div>
                            ${brief.location_city || brief.location_country ? `
                            <div>
                                <div style="font-weight: 600; color: #0a0a0a; margin-bottom: 0.25rem;">Location</div>
                                <div style="color: #64748b;">${[brief.location_city, brief.location_country].filter(Boolean).join(', ')}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #0a0a0a; margin-bottom: 0.25rem;">Design Goal</div>
                            <div style="color: #64748b;">${brief.design_goal}</div>
                        </div>
                        ${brief.brand_colors || brief.key_offers_or_items ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                            ${brief.brand_colors ? `
                            <div>
                                <div style="font-weight: 600; color: #0a0a0a; margin-bottom: 0.25rem;">Brand Colors</div>
                                <div style="color: #64748b;">${brief.brand_colors}</div>
                            </div>
                            ` : ''}
                            ${brief.key_offers_or_items ? `
                            <div>
                                <div style="font-weight: 600; color: #0a0a0a; margin-bottom: 0.25rem;">Key Offers / Menu Items</div>
                                <div style="color: #64748b; white-space: pre-wrap;">${brief.key_offers_or_items.substring(0, 200)}${brief.key_offers_or_items.length > 200 ? '...' : ''}</div>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>

                    <!-- AI Generation Tools -->
                    <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 0.5rem; padding: 1.5rem;">
                        <h4 style="color: #1e40af; margin-bottom: 1rem; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.25rem;">ü§ñ</span>
                            AI Design Assistant
                        </h4>
                        <p style="color: #1e3a8a; font-size: 0.875rem; margin-bottom: 1rem;">
                            Generate copy and content for this customer's design project based on their brief.
                        </p>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button onclick="generateAIContent(${orderId}, 'menu')" class="action-btn" style="background: #6366f1; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                                Generate Menu Copy
                            </button>
                            <button onclick="generateAIContent(${orderId}, 'flyer')" class="action-btn" style="background: #8b5cf6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                                Generate Flyer Copy
                            </button>
                            <button onclick="generateAIContent(${orderId}, 'social')" class="action-btn" style="background: #ec4899; color: white; padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; font-weight: 500;">
                                Generate Social Media
                            </button>
                        </div>
                        <div id="ai-output-${orderId}" style="margin-top: 1rem; display: none;">
                            <!-- AI output will be displayed here -->
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate AI content
        async function generateAIContent(orderId, mode) {
            try {
                const outputDiv = document.getElementById(`ai-output-${orderId}`);
                outputDiv.style.display = 'block';
                outputDiv.innerHTML = '<div style="padding: 1rem; background: white; border-radius: 0.375rem; text-align: center;"><div class="spinner" style="border: 3px solid #f3f4f6; border-top: 3px solid #6366f1; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 0.5rem;"></div><p style="color: #64748b; font-size: 0.875rem;">Generating ${mode} content with AI...</p></div>';

                const token = getAuthToken();
                const response = await fetch(`/api/photo-studio/admin/order/${orderId}/ai/generate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mode })
                });

                const data = await response.json();

                if (data.success) {
                    displayAIOutput(orderId, mode, data);
                } else {
                    throw new Error(data.error || 'AI generation failed');
                }
            } catch (error) {
                console.error('AI generation error:', error);
                const outputDiv = document.getElementById(`ai-output-${orderId}`);
                outputDiv.innerHTML = `<div style="padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.375rem;"><p style="color: #991b1b; font-size: 0.875rem;">‚ùå ${error.message}</p></div>`;
            }
        }

        // Display AI output
        function displayAIOutput(orderId, mode, data) {
            const outputDiv = document.getElementById(`ai-output-${orderId}`);
            let html = '<div style="padding: 1.5rem; background: white; border-radius: 0.375rem; border: 1px solid #e5e7eb;">';

            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">`;
            html += `<h5 style="color: #0a0a0a; font-size: 0.9375rem; font-weight: 600; margin: 0;">Generated ${mode.charAt(0).toUpperCase() + mode.slice(1)} Content</h5>`;
            html += `<button onclick="copyAIOutput('ai-content-${orderId}')" style="background: #10b981; color: white; padding: 0.375rem 0.75rem; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem;">Copy</button>`;
            html += `</div>`;

            html += `<div id="ai-content-${orderId}" style="background: #f8fafc; padding: 1rem; border-radius: 0.375rem; font-family: monospace; font-size: 0.8125rem; line-height: 1.6; white-space: pre-wrap; max-height: 400px; overflow-y: auto;">${JSON.stringify(data.content, null, 2)}</div>`;

            html += `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; font-size: 0.75rem; color: #64748b;">`;
            html += `<div>Model: ${data.model || 'N/A'}</div>`;
            html += `<div>Tokens: ${data.tokensUsed || 'N/A'}</div>`;
            html += `</div>`;

            html += '</div>';

            outputDiv.innerHTML = html;
        }

        // Copy AI output to clipboard
        function copyAIOutput(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Content copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy content');
            });
        }

        // AI Enhance Photo
        async function enhancePhotoWithAI(orderId, photoId) {
            const statusDiv = document.getElementById(`ai-enhance-status-${orderId}-${photoId}`);
            const button = event.target;

            try {
                // Show loading state
                button.disabled = true;
                button.innerHTML = '‚è≥ Enhancing with AI...';
                statusDiv.innerHTML = '<div style="color: #6366f1; font-size: 0.875rem;">üé® AI is enhancing your photo...</div>';

                const token = getAuthToken();
                const response = await fetch(`/api/photo-studio/admin/order/${orderId}/photo/${photoId}/ai-enhance`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.innerHTML = `
                        <div style="background: #f0fdf4; border: 1px solid #86efac; padding: 0.75rem; border-radius: 0.375rem; font-size: 0.875rem;">
                            <div style="color: #15803d; font-weight: 600; margin-bottom: 0.5rem;">‚úÖ Enhancement Complete!</div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="downloadPhoto('${data.enhancedUrl}', 'enhanced-${photoId}.jpg')" style="flex: 1; background: #10b981; color: white; padding: 0.5rem; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                    ‚¨áÔ∏è Download Enhanced
                                </button>
                                <button onclick="autoUploadEnhanced(${orderId}, ${photoId}, '${data.enhancedUrl}')" style="flex: 1; background: #6366f1; color: white; padding: 0.5rem; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 0.75rem; font-weight: 500;">
                                    üì§ Upload to Order
                                </button>
                            </div>
                        </div>
                    `;
                    button.innerHTML = 'üé® AI Enhance This Photo';
                    button.disabled = false;

                    // Show preview
                    const photoContainer = button.closest('.before-photo');
                    const existingPreview = photoContainer.querySelector('.ai-enhanced-preview');
                    if (existingPreview) {
                        existingPreview.remove();
                    }

                    const preview = document.createElement('div');
                    preview.className = 'ai-enhanced-preview';
                    preview.style.cssText = 'margin-top: 0.5rem; border: 2px solid #10b981; border-radius: 0.5rem; overflow: hidden;';
                    preview.innerHTML = `
                        <div style="background: #10b981; color: white; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 600; text-align: center;">AI Enhanced Preview</div>
                        <img src="${data.enhancedUrl}" alt="AI Enhanced" style="width: 100%; display: block;">
                    `;
                    statusDiv.insertAdjacentElement('beforebegin', preview);
                } else {
                    throw new Error(data.error || 'Enhancement failed');
                }
            } catch (error) {
                console.error('AI enhancement error:', error);
                statusDiv.innerHTML = `<div style="color: #dc2626; font-size: 0.875rem;">‚ùå ${error.message}</div>`;
                button.innerHTML = 'üé® AI Enhance This Photo';
                button.disabled = false;
            }
        }

        // Auto-upload enhanced photo from AI
        async function autoUploadEnhanced(orderId, photoId, enhancedUrl) {
            try {
                const statusDiv = document.getElementById(`ai-enhance-status-${orderId}-${photoId}`);
                statusDiv.innerHTML = '<div style="color: #6366f1; font-size: 0.875rem;">üì§ Uploading enhanced photo...</div>';

                // Download the enhanced image from URL
                const imageResponse = await fetch(enhancedUrl);
                const imageBlob = await imageResponse.blob();
                const imageFile = new File([imageBlob], `enhanced-${photoId}.jpg`, { type: 'image/jpeg' });

                // Upload to server
                const formData = new FormData();
                formData.append('photos', imageFile);
                formData.append('original_photo_id', photoId);

                const token = getAuthToken();
                const uploadResponse = await fetch(`/api/photo-studio/admin/order/${orderId}/upload-enhanced`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await uploadResponse.json();

                if (data.success) {
                    statusDiv.innerHTML = '<div style="color: #15803d; font-size: 0.875rem;">‚úÖ Enhanced photo uploaded successfully!</div>';
                    // Reload order details to show the new enhanced photo
                    setTimeout(() => {
                        loadOrderDetails(orderId);
                    }, 1500);
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                console.error('Auto-upload error:', error);
                alert('Failed to upload enhanced photo: ' + error.message);
            }
        }

        // Load orders on page load
        window.addEventListener('DOMContentLoaded', loadOrders);

        // Refresh every 30 seconds
        setInterval(loadOrders, 30000);
    </script>
</body>
</html>
