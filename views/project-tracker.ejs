<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker - RinglyPro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 span {
            font-size: 28px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #f3f4f6;
            border: none;
            border-radius: 10px;
            color: #4b5563;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #e5e7eb;
        }

        /* Projects List */
        .projects-grid {
            display: grid;
            gap: 20px;
        }

        .project-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            cursor: pointer;
            transition: all 0.3s;
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .project-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .project-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: #fef3c7; color: #92400e; }
        .status-in_progress { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-on_hold { background: #fee2e2; color: #991b1b; }

        .project-description {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .project-progress {
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
            margin-top: 6px;
        }

        .project-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #9ca3af;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Project Detail View */
        .project-detail {
            display: none;
        }

        .project-detail.active {
            display: block;
        }

        .detail-header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .detail-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .detail-description {
            color: #6b7280;
            margin-bottom: 16px;
        }

        /* Milestones */
        .milestones-container {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .milestones-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .milestone {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #f9fafb;
            cursor: pointer;
        }

        .milestone-header:hover {
            background: #f3f4f6;
        }

        .milestone-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .milestone-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .milestone-icon.pending { background: #fef3c7; }
        .milestone-icon.in_progress { background: #dbeafe; }
        .milestone-icon.completed { background: #d1fae5; }
        .milestone-icon.blocked { background: #fee2e2; }

        .milestone-name {
            font-weight: 500;
        }

        .milestone-toggle {
            color: #9ca3af;
            transition: transform 0.2s;
        }

        .milestone.expanded .milestone-toggle {
            transform: rotate(180deg);
        }

        .milestone-content {
            display: none;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .milestone.expanded .milestone-content {
            display: block;
        }

        .milestone-description {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .admin-notes {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px 16px;
            margin-bottom: 16px;
            border-radius: 0 8px 8px 0;
        }

        .admin-notes-label {
            font-size: 11px;
            font-weight: 600;
            color: #92400e;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .admin-notes-text {
            color: #78350f;
            font-size: 14px;
        }

        /* Messages */
        .messages-section {
            margin-top: 20px;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
        }

        .messages-title {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 12px;
        }

        .messages-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .message {
            display: flex;
            margin-bottom: 12px;
        }

        .message.from-admin {
            justify-content: flex-start;
        }

        .message.from-client {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.from-admin .message-bubble {
            background: #f3f4f6;
            border-bottom-left-radius: 4px;
        }

        .message.from-client .message-bubble {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-meta {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
        }

        .message-form {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            resize: none;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 16px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-size: 20px;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .empty-state p {
            color: #6b7280;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Priority badges */
        .priority-badge {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .priority-low { background: #d1fae5; color: #065f46; }
        .priority-medium { background: #dbeafe; color: #1e40af; }
        .priority-high { background: #fed7aa; color: #9a3412; }
        .priority-urgent { background: #fecaca; color: #991b1b; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><span>üìã</span> Project Tracker</h1>
            <a href="/" class="back-btn">
                ‚Üê Back to Dashboard
            </a>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="spinner"></div>
            <p>Loading your projects...</p>
        </div>

        <!-- Projects List View -->
        <div class="projects-list" id="projectsList" style="display: none;">
            <div class="projects-grid" id="projectsGrid">
                <!-- Projects will be loaded here -->
            </div>
        </div>

        <!-- Project Detail View -->
        <div class="project-detail" id="projectDetail">
            <div class="detail-header" id="detailHeader">
                <!-- Project header will be loaded here -->
            </div>
            <div class="milestones-container">
                <h3 class="milestones-title">
                    <span>üéØ</span> Milestones
                </h3>
                <div id="milestonesList">
                    <!-- Milestones will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentView = 'list'; // 'list' or 'detail'
        let projects = [];
        let currentProject = null;

        // Get auth token
        function getToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format time
        function formatTime(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load projects
        async function loadProjects() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/projects', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    projects = data.projects;
                    renderProjectsList();
                } else {
                    console.error('Failed to load projects:', data.error);
                }
            } catch (error) {
                console.error('Error loading projects:', error);
            }

            document.getElementById('loadingState').style.display = 'none';
        }

        // Render projects list
        function renderProjectsList() {
            const grid = document.getElementById('projectsGrid');
            const listView = document.getElementById('projectsList');

            if (projects.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No Projects Yet</h3>
                        <p>You don't have any active projects at the moment.</p>
                    </div>
                `;
            } else {
                grid.innerHTML = projects.map(project => `
                    <div class="project-card" onclick="viewProject(${project.id})">
                        <div class="project-header">
                            <div class="project-title">
                                ${escapeHtml(project.title)}
                                <span class="priority-badge priority-${project.priority}">${project.priority}</span>
                            </div>
                            <span class="project-status status-${project.status}">
                                ${project.status.replace('_', ' ')}
                            </span>
                        </div>
                        ${project.description ? `<p class="project-description">${escapeHtml(project.description)}</p>` : ''}
                        <div class="project-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${project.progress}%"></div>
                            </div>
                            <div class="progress-text">
                                <span>${project.progress}% Complete</span>
                                <span>${project.completedMilestones} of ${project.totalMilestones} milestones</span>
                            </div>
                        </div>
                        <div class="project-meta">
                            <span class="meta-item">üìÖ Created: ${formatDate(project.created_at)}</span>
                            ${project.estimated_completion ? `<span class="meta-item">üéØ Due: ${formatDate(project.estimated_completion)}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            }

            listView.style.display = 'block';
            document.getElementById('projectDetail').classList.remove('active');
            currentView = 'list';
        }

        // View single project
        async function viewProject(projectId) {
            const token = getToken();

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    currentProject = data.project;
                    renderProjectDetail();
                } else {
                    console.error('Failed to load project:', data.error);
                }
            } catch (error) {
                console.error('Error loading project:', error);
            }
        }

        // Render project detail
        function renderProjectDetail() {
            const project = currentProject;
            const header = document.getElementById('detailHeader');
            const milestonesList = document.getElementById('milestonesList');

            header.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <button onclick="backToList()" class="back-btn" style="margin-bottom: 16px;">‚Üê Back to Projects</button>
                        <h2>${escapeHtml(project.title)}</h2>
                        ${project.description ? `<p class="detail-description">${escapeHtml(project.description)}</p>` : ''}
                    </div>
                    <span class="project-status status-${project.status}">${project.status.replace('_', ' ')}</span>
                </div>
                <div class="project-progress" style="margin-top: 16px;">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${project.progress}%"></div>
                    </div>
                    <div class="progress-text">
                        <span>${project.progress}% Complete</span>
                        <span>${project.completedMilestones} of ${project.totalMilestones} milestones</span>
                    </div>
                </div>
            `;

            if (!project.milestones || project.milestones.length === 0) {
                milestonesList.innerHTML = `
                    <div class="empty-state" style="padding: 30px;">
                        <p>No milestones have been added yet.</p>
                    </div>
                `;
            } else {
                milestonesList.innerHTML = project.milestones.map((milestone, index) => `
                    <div class="milestone" id="milestone-${milestone.id}">
                        <div class="milestone-header" onclick="toggleMilestone(${milestone.id})">
                            <div class="milestone-title-row">
                                <div class="milestone-icon ${milestone.status}">
                                    ${milestone.status === 'completed' ? '‚úì' : milestone.status === 'in_progress' ? '‚è≥' : milestone.status === 'blocked' ? '‚ö†' : (index + 1)}
                                </div>
                                <span class="milestone-name">${escapeHtml(milestone.title)}</span>
                                <span class="project-status status-${milestone.status}" style="font-size: 10px; padding: 3px 8px;">
                                    ${milestone.status.replace('_', ' ')}
                                </span>
                            </div>
                            <span class="milestone-toggle">‚ñº</span>
                        </div>
                        <div class="milestone-content">
                            ${milestone.description ? `<p class="milestone-description">${escapeHtml(milestone.description)}</p>` : ''}
                            ${milestone.due_date ? `<p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">üìÖ Due: ${formatDate(milestone.due_date)}</p>` : ''}
                            ${milestone.admin_notes ? `
                                <div class="admin-notes">
                                    <div class="admin-notes-label">üìå Admin Notes</div>
                                    <div class="admin-notes-text">${escapeHtml(milestone.admin_notes)}</div>
                                </div>
                            ` : ''}
                            <div class="messages-section">
                                <div class="messages-title">üí¨ Discussion</div>
                                <div class="messages-list" id="messages-${milestone.id}">
                                    ${renderMessages(milestone.messages || [])}
                                </div>
                                <form class="message-form" onsubmit="sendMessage(event, ${milestone.id})">
                                    <textarea class="message-input" id="input-${milestone.id}" placeholder="Type your message..." rows="2"></textarea>
                                    <button type="submit" class="send-btn">Send</button>
                                </form>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('projectsList').style.display = 'none';
            document.getElementById('projectDetail').classList.add('active');
            currentView = 'detail';
        }

        // Render messages
        function renderMessages(messages) {
            if (!messages || messages.length === 0) {
                return '<p style="color: #9ca3af; font-size: 13px; text-align: center; padding: 20px;">No messages yet. Start the conversation!</p>';
            }

            return messages.map(msg => `
                <div class="message ${msg.is_admin ? 'from-admin' : 'from-client'}">
                    <div class="message-bubble">
                        <div>${escapeHtml(msg.message)}</div>
                        <div class="message-meta">
                            ${msg.author ? `${msg.author.first_name || 'Admin'} ‚Ä¢ ` : ''}${formatDate(msg.created_at)} ${formatTime(msg.created_at)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle milestone expansion
        function toggleMilestone(milestoneId) {
            const milestone = document.getElementById(`milestone-${milestoneId}`);
            milestone.classList.toggle('expanded');
        }

        // Send message
        async function sendMessage(event, milestoneId) {
            event.preventDefault();

            const input = document.getElementById(`input-${milestoneId}`);
            const message = input.value.trim();

            if (!message) return;

            const token = getToken();

            try {
                const response = await fetch(`/api/projects/${currentProject.id}/milestones/${milestoneId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (data.success) {
                    // Add message to the list
                    const messagesList = document.getElementById(`messages-${milestoneId}`);
                    const newMessageHtml = `
                        <div class="message from-client">
                            <div class="message-bubble">
                                <div>${escapeHtml(data.message.message)}</div>
                                <div class="message-meta">
                                    You ‚Ä¢ ${formatDate(data.message.created_at)} ${formatTime(data.message.created_at)}
                                </div>
                            </div>
                        </div>
                    `;

                    // Check if it was empty state
                    if (messagesList.innerHTML.includes('No messages yet')) {
                        messagesList.innerHTML = newMessageHtml;
                    } else {
                        messagesList.innerHTML += newMessageHtml;
                    }

                    // Scroll to bottom
                    messagesList.scrollTop = messagesList.scrollHeight;

                    // Clear input
                    input.value = '';
                } else {
                    alert('Failed to send message: ' + data.error);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message');
            }
        }

        // Back to list
        function backToList() {
            renderProjectsList();
            currentProject = null;
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadProjects);
    </script>
</body>
</html>
