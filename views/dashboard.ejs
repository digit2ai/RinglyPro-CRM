<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="RinglyPro - AI-Powered Phone Receptionist Service">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="RinglyPro">

    <title>RinglyPro CRM - Dashboard</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://assets.cdn.filesafe.space/3lSeAHXNU9t09Hhp9oai/media/68e1ca42554f6a328ff4f6a5.png">
    <link rel="apple-touch-icon" href="https://assets.cdn.filesafe.space/3lSeAHXNU9t09Hhp9oai/media/68e1ca42554f6a328ff4f6a5.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f3f4f6;
            color: #111827;
            line-height: 1.5;
        }

        /* Low Balance Alert Banner */
        .low-balance-alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 4px solid #dc2626;
            padding: 1rem;
            margin: 0;
            display: none;
            align-items: center;
            gap: 0.75rem;
        }

        .low-balance-alert.show {
            display: flex;
        }

        .low-balance-alert svg {
            width: 1.5rem;
            height: 1.5rem;
            color: #dc2626;
            flex-shrink: 0;
        }

        .low-balance-alert-content {
            flex: 1;
        }

        .low-balance-alert-content h3 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 0.25rem;
        }

        .low-balance-alert-content p {
            font-size: 0.8125rem;
            color: #7f1d1d;
        }

        .low-balance-alert button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .low-balance-alert button:hover {
            background: #b91c1c;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .header-content {
            padding: 1rem;
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .header-top h1 {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .username {
            font-size: 0.875rem;
            color: #4b5563;
            font-weight: 500;
        }

        .header-minutes-btn {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .header-minutes-btn:hover {
            background: #7c3aed;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
        }

        .install-app-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .install-app-btn:hover {
            background: #059669;
        }

        .install-app-btn.hidden {
            display: none;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .training-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .training-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
        }

        /* Rachel Toggle Card */
        .rachel-card {
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            border: 2px solid #3b82f6;
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .rachel-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .rachel-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.active {
            background: #10b981;
        }

        .status-dot.inactive {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .rachel-text h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.125rem;
        }

        .rachel-text p {
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 3rem;
            height: 1.5rem;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d1d5db;
            transition: 0.3s;
            border-radius: 1.5rem;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 1.125rem;
            width: 1.125rem;
            left: 0.1875rem;
            bottom: 0.1875rem;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(1.5rem);
        }

        /* Quick Actions */
        .quick-actions {
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn svg {
            width: 1.25rem;
            height: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .btn-sms {
            background: #3b82f6;
        }

        .btn-sms:hover {
            background: #2563eb;
        }

        .btn-call {
            background: #10b981;
        }

        .btn-call:hover {
            background: #059669;
        }

        .btn-credits {
            background: #8b5cf6;
        }

        .btn-credits:hover {
            background: #7c3aed;
        }

        .btn-copilot {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
        }

        .btn-copilot:hover {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(30, 58, 138, 0.4);
        }

        .btn-share {
            background: #f97316;
        }

        .btn-share:hover {
            background: #ea580c;
        }

        .btn-ivr {
            background: #06b6d4;
        }

        .btn-ivr:hover {
            background: #0891b2;
        }

        .btn-projects {
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
        }

        .btn-projects:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%);
        }

        .credit-amount {
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.125rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .nav-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .nav-tab.active {
            color: #3b82f6;
            background: #eff6ff;
            border-bottom-color: #3b82f6;
        }

        .nav-tab svg {
            width: 1rem;
            height: 1rem;
            display: inline;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .tab-badge {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.125rem 0.5rem;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 1rem;
            min-width: 1.25rem;
            text-align: center;
        }

        .nav-tab.active .tab-badge {
            background: #dc2626;
        }

        /* Content Area */
        .content {
            padding: 1rem;
            padding-bottom: 5rem;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .section-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-refresh {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-refresh:hover {
            background: #059669;
        }

        .btn-refresh:active {
            transform: scale(0.95);
        }

        .btn-refresh.refreshing svg {
            animation: spin 1s linear infinite;
        }

        .btn-refresh:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Appointment Card */
        .appointment-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .appointment-main {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .appointment-info {
            flex: 1;
        }

        .appointment-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .appointment-info p {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .appointment-time {
            text-align: right;
            margin-left: 1rem;
        }

        .appointment-time .time {
            font-size: 1.125rem;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 0.25rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #fed7aa;
            color: #9a3412;
        }

        /* Deposit Badge Styles */
        .deposit-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .deposit-pending {
            background: #fef3c7;
            color: #b45309;
            border: 1px solid #f59e0b;
        }

        .deposit-pending:hover {
            background: #fcd34d;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }

        .deposit-confirmed {
            background: #d1fae5;
            color: #065f46;
            cursor: default;
        }

        .appointment-actions {
            background: #f9fafb;
            padding: 0.5rem 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .appointment-actions button {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            color: white;
        }

        .appointment-actions button svg {
            width: 0.875rem;
            height: 0.875rem;
        }

        .appointment-actions .btn-text {
            background: #3b82f6;
        }

        .appointment-actions .btn-call-apt {
            background: #10b981;
        }

        .appointment-actions .btn-confirm-apt {
            background: #8b5cf6;
        }

        .appointment-actions .btn-confirm-apt:hover {
            background: #7c3aed;
        }

        .appointment-actions .btn-confirm-apt.confirmed {
            background: #d1fae5;
            color: #065f46;
            cursor: default;
        }

        .appointment-actions .btn-delete-apt {
            background: #ef4444;
        }

        .appointment-actions .btn-delete-apt:hover {
            background: #dc2626;
        }

        /* View Toggle Buttons */
        .view-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .view-toggle button {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            background: transparent;
            color: #6b7280;
            transition: all 0.2s;
        }

        .view-toggle button:hover {
            background: #e5e7eb;
        }

        .view-toggle button.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .view-toggle button svg {
            width: 1rem;
            height: 1rem;
        }

        /* Calendar Grid View */
        .calendar-grid-container {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .calendar-header-cell {
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            color: #374151;
            border-right: 1px solid #e5e7eb;
        }

        .calendar-header-cell:last-child {
            border-right: none;
        }

        .calendar-header-cell .day-name {
            color: #6b7280;
            text-transform: uppercase;
            font-size: 0.625rem;
            letter-spacing: 0.05em;
        }

        .calendar-header-cell .day-date {
            font-size: 1rem;
            margin-top: 0.125rem;
        }

        .calendar-header-cell.today {
            background: #dbeafe;
        }

        .calendar-header-cell.today .day-date {
            background: #3b82f6;
            color: white;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 0.25rem;
        }

        .calendar-body {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            max-height: 600px;
            overflow-y: auto;
        }

        .time-column {
            display: flex;
            flex-direction: column;
        }

        .time-slot-label {
            height: 60px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
            border-right: 1px solid #e5e7eb;
        }

        .day-column {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e5e7eb;
            position: relative;
        }

        .day-column:last-child {
            border-right: none;
        }

        .time-slot {
            height: 60px;
            border-bottom: 1px solid #f3f4f6;
            position: relative;
            padding: 0.125rem;
        }

        .time-slot:hover {
            background: #f9fafb;
        }

        .calendar-event {
            position: absolute;
            left: 2px;
            right: 2px;
            background: #dbeafe;
            border-left: 3px solid #3b82f6;
            border-radius: 0.25rem;
            padding: 0.25rem 0.375rem;
            font-size: 0.6875rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
        }

        .calendar-event:hover {
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            z-index: 10;
        }

        .calendar-event.voice-booking {
            background: #dbeafe;
            border-left-color: #3b82f6;
        }

        /* AI Voice Booking - Pending (RED - needs confirmation) */
        .calendar-event.voice-booking-pending {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        /* AI Voice Booking - Confirmed (GREEN) */
        .calendar-event.voice-booking-confirmed {
            background: #dcfce7;
            border-left-color: #22c55e;
        }

        .calendar-event.ghl-sync {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        /* Calendar-specific colors for GHL busy slots */
        .calendar-event.hyperbaric-busy {
            background: #ffedd5;
            border-left-color: #f97316;
        }

        .calendar-event.recovery-busy {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .calendar-event.cryotherapy-busy {
            background: #dcfce7;
            border-left-color: #22c55e;
        }

        .calendar-event.pending-deposit {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .calendar-event .event-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #1e40af;
        }

        .calendar-event .event-time {
            font-size: 0.625rem;
            color: #3b82f6;
        }

        .calendar-event.voice-booking .event-title {
            color: #1e40af;
        }

        /* AI Voice Booking - Pending text colors (RED) */
        .calendar-event.voice-booking-pending .event-title {
            color: #991b1b;
        }

        .calendar-event.voice-booking-pending .event-time {
            color: #dc2626;
        }

        /* AI Voice Booking - Confirmed text colors (GREEN) */
        .calendar-event.voice-booking-confirmed .event-title {
            color: #166534;
        }

        .calendar-event.voice-booking-confirmed .event-time {
            color: #16a34a;
        }

        .calendar-event.ghl-sync .event-title {
            color: #065f46;
        }

        .calendar-event.ghl-sync .event-time {
            color: #10b981;
        }

        /* Hyperbaric busy slot text colors (Orange) */
        .calendar-event.hyperbaric-busy .event-title {
            color: #9a3412;
        }

        .calendar-event.hyperbaric-busy .event-time {
            color: #ea580c;
        }

        /* Recovery busy slot text colors (Red) */
        .calendar-event.recovery-busy .event-title {
            color: #991b1b;
        }

        .calendar-event.recovery-busy .event-time {
            color: #dc2626;
        }

        /* Cryotherapy busy slot text colors (Green) */
        .calendar-event.cryotherapy-busy .event-title {
            color: #166534;
        }

        .calendar-event.cryotherapy-busy .event-time {
            color: #16a34a;
        }

        .calendar-event.pending-deposit .event-title {
            color: #92400e;
        }

        .calendar-event.pending-deposit .event-time {
            color: #b45309;
        }

        /* GHL Calendar Cards View */
        .ghl-cards-container {
            padding: 1rem;
        }

        .ghl-cards-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ghl-last-updated {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .ghl-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .ghl-calendar-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .ghl-calendar-card.hyperbaric {
            border-top: 4px solid #f97316;
        }

        .ghl-calendar-card.cryotherapy {
            border-top: 4px solid #22c55e;
        }

        .ghl-calendar-card.recovery {
            border-top: 4px solid #ef4444;
        }

        .ghl-card-header {
            padding: 1rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .ghl-card-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .ghl-card-header .calendar-id {
            font-size: 0.7rem;
            color: #9ca3af;
            font-family: monospace;
        }

        .ghl-card-header .open-hours {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .ghl-card-body {
            padding: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .ghl-date-row {
            display: flex;
            align-items: flex-start;
            padding: 0.5rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .ghl-date-row:last-child {
            border-bottom: none;
        }

        .ghl-date-row.closed {
            background: #f9fafb;
            color: #9ca3af;
        }

        .ghl-date-label {
            width: 80px;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.8rem;
            color: #374151;
        }

        .ghl-date-label .day-name {
            font-size: 0.7rem;
            color: #9ca3af;
            font-weight: 400;
        }

        .ghl-slots-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .ghl-slots-row {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        .ghl-slots-row .label {
            width: 50px;
            flex-shrink: 0;
            font-weight: 500;
        }

        .ghl-slots-row.free .label {
            color: #16a34a;
        }

        .ghl-slots-row.busy .label {
            color: #dc2626;
        }

        .ghl-slots-row .slots {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .ghl-slot-badge {
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .ghl-slot-badge.free {
            background: #dcfce7;
            color: #166534;
        }

        .ghl-slot-badge.busy {
            background: #fee2e2;
            color: #991b1b;
        }

        .ghl-closed-badge {
            background: #f3f4f6;
            color: #6b7280;
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
        }

        /* Week Navigation */
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .calendar-nav button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            background: white;
            cursor: pointer;
            color: #374151;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .calendar-nav .current-week {
            font-weight: 600;
            color: #111827;
        }

        .calendar-nav .today-btn {
            padding: 0.375rem 0.75rem;
            width: auto;
            font-size: 0.875rem;
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .calendar-nav .today-btn:hover {
            background: #eff6ff;
        }

        /* Empty slot indicator */
        .no-appointments-week {
            grid-column: 2 / -1;
            padding: 2rem;
            text-align: center;
            color: #6b7280;
        }

        /* Communication Card */
        .comm-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .comm-card-content {
            display: flex;
            gap: 0.75rem;
        }

        .comm-icon {
            padding: 0.5rem;
            border-radius: 9999px;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .comm-icon.sms {
            background: #dbeafe;
            color: #2563eb;
        }

        .comm-icon.call {
            background: #d1fae5;
            color: #059669;
        }

        .comm-info {
            flex: 1;
        }

        .comm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .comm-header h4 {
            font-size: 0.9375rem;
            font-weight: 600;
        }

        .comm-header .time {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .comm-info p {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .comm-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
        }

        .comm-badge.received {
            background: #dbeafe;
            color: #1e40af;
        }

        .comm-badge.sent {
            background: #e5e7eb;
            color: #374151;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 1rem;
            opacity: 0.5;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message Cards */
        .message-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message-card.unread {
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
            font-weight: 500;
        }

        .message-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .message-header:hover {
            background: #f9fafb;
        }

        .message-info {
            flex: 1;
        }

        .message-info h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #111827;
        }

        .message-info p {
            font-size: 0.8125rem;
            color: #6b7280;
            margin-bottom: 0.125rem;
        }

        .message-preview {
            font-size: 0.875rem;
            color: #374151;
            margin-top: 0.5rem;
            line-height: 1.4;
            max-height: 2.8em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .message-toggle {
            width: 1.5rem;
            height: 1.5rem;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .message-card.expanded .message-toggle {
            transform: rotate(180deg);
        }

        .message-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border-top: 1px solid #e5e7eb;
        }

        .message-card.expanded .message-body {
            max-height: 500px;
        }

        .message-content {
            padding: 1rem;
            font-size: 0.875rem;
            line-height: 1.6;
            color: #374151;
            background: #f9fafb;
        }

        .message-actions {
            background: #f3f4f6;
            padding: 0.75rem 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .btn-reply-sms {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            transition: background 0.2s;
        }

        .btn-reply-sms:hover {
            background: #2563eb;
        }

        .btn-reply-sms svg {
            width: 1rem;
            height: 1rem;
        }

        .btn-call-back {
            background: #10b981;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            transition: background 0.2s;
        }

        .btn-call-back:hover {
            background: #059669;
        }

        .btn-call-back svg {
            width: 1rem;
            height: 1rem;
        }

        .btn-call-back:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* SMS compose form CSS removed - using device SMS app instead */

        /* Settings Modal - Tabs */
        .settings-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
            gap: 0;
        }

        .settings-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .settings-tab:hover {
            color: #111827;
            background: #f9fafb;
        }

        .settings-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        /* CRM Integration Form Styles */
        .crm-section {
            margin-bottom: 2rem;
            padding: 1.25rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: #f9fafb;
        }

        .crm-section h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .crm-section .crm-logo {
            width: 24px;
            height: 24px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-family: monospace;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group .form-hint {
            display: block;
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.375rem;
        }

        .key-status {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.625rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
        }

        .key-status.configured {
            background: #d1fae5;
            color: #065f46;
        }

        .key-status.not-configured {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Calendar Settings Modal */
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .setting-label {
            flex: 1;
        }

        .setting-title {
            display: block;
            font-weight: 600;
            font-size: 0.875rem;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .setting-description {
            display: block;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .divider {
            height: 1px;
            background: #e5e7eb;
            margin: 1rem 0;
        }

        .section-heading {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin: 1rem 0 0.75rem 0;
        }

        .day-setting {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: #f9fafb;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .day-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: #111827;
        }

        .day-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .time-group {
            display: flex;
            flex-direction: column;
        }

        .time-group label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .time-group input[type="time"] {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .time-group input[type="time"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .time-group input[type="time"]:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #374151;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .btn-save {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-save:hover {
            background: #2563eb;
        }

        .btn-save:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-calendar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-calendar:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653b8b 100%);
        }

        /* Date Filter Tabs */
        .filter-tab {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            color: #6b7280;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-tab:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .filter-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Contact Search Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: flex-end;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            width: 100%;
            max-height: 80vh;
            border-radius: 1rem 1rem 0 0;
            overflow: hidden;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 2rem;
            height: 2rem;
        }

        .modal-body {
            padding: 1rem;
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input-wrapper svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 1.25rem;
            height: 1.25rem;
            color: #9ca3af;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .contact-item:hover {
            background: #f9fafb;
        }

        .contact-avatar {
            width: 2.5rem;
            height: 2.5rem;
            background: #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .contact-avatar svg {
            width: 1.5rem;
            height: 1.5rem;
            color: #6b7280;
        }

        .contact-details h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #111827;
        }

        .contact-details p {
            font-size: 0.875rem;
            color: #6b7280;
        }

        /* Credits Modal Styles */
        .credits-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .credits-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .credits-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .credits-modal-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .credits-modal-header h2 {
            margin: 0;
            font-size: 24px;
            color: #1f2937;
        }

        .credits-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .credits-modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .credits-modal-body {
            padding: 24px;
        }

        /* Current Balance Display */
        .current-balance-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .current-balance-display h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        .current-balance-display .balance-amount {
            font-size: 36px;
            font-weight: bold;
            margin: 0;
        }

        .balance-stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            font-size: 14px;
        }

        .balance-stat {
            opacity: 0.9;
        }

        /* Package Selection */
        .package-selection {
            margin-bottom: 24px;
        }

        .package-selection h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: #1f2937;
        }

        .package-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .package-option {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .package-option:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .package-option.selected {
            border-color: #667eea;
            background: #eef2ff;
        }

        .package-amount {
            font-size: 28px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .package-minutes {
            font-size: 14px;
            color: #6b7280;
        }

        .package-rate {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* Payment Form */
        .payment-form {
            margin-top: 24px;
        }

        .payment-form h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stripe-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: linear-gradient(135deg, #635bff 0%, #5469d4 100%);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .stripe-badge svg {
            width: 14px;
            height: 14px;
        }

        #card-element {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            background: white;
        }

        #card-element.StripeElement--focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #card-errors {
            color: #ef4444;
            font-size: 14px;
            margin-top: 8px;
            min-height: 20px;
        }

        /* Buttons */
        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-pay {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-pay:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-pay:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-cancel {
            flex: 0 0 auto;
            background: white;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: #f9fafb;
        }

        /* Loading State */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }

        /* Success Message */
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* Appointment Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1100;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }

        .modal .modal-content {
            position: relative;
            background: white;
            border-radius: 12px;
            z-index: 2;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .modal .modal-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 0;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.9375rem;
            color: #1f2937;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input:disabled {
            background: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .error-message {
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            .package-grid {
                grid-template-columns: 1fr;
            }

            .balance-stats {
                flex-direction: column;
                gap: 8px;
            }

            .form-row {
                grid-template-columns: 1fr !important;
            }

            .modal .modal-content {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
        }

        @media (min-width: 640px) {
            .modal-overlay {
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                max-width: 28rem;
                border-radius: 0.75rem;
            }
        }

        /* Footer Styles */
        .app-footer {
            background: #1f2937;
            color: #9ca3af;
            padding: 2rem 1.5rem;
            margin-top: 3rem;
            border-top: 1px solid #374151;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .footer-branding {
            margin-bottom: 1rem;
        }

        .footer-logo {
            height: 160px;
            width: auto;
            margin-bottom: 0.75rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .footer-branding h3 {
            color: #f3f4f6;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .footer-branding p {
            font-size: 0.875rem;
            color: #9ca3af;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: #60a5fa;
            text-decoration: none;
            font-size: 0.875rem;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        .footer-contact {
            margin: 1.5rem 0;
            font-size: 0.875rem;
        }

        .footer-contact p {
            margin: 0.25rem 0;
        }

        .footer-contact a {
            color: #60a5fa;
            text-decoration: none;
        }

        .footer-contact a:hover {
            text-decoration: underline;
        }

        .footer-copyright {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #374151;
        }

        @media (max-width: 768px) {
            .footer-links {
                flex-direction: column;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Low Balance Alert Banner -->
    <div class="low-balance-alert" id="lowBalanceAlert">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div class="low-balance-alert-content">
            <h3>Low Balance Warning</h3>
            <p id="lowBalanceMessage">Only X tokens remaining. Recharge now to avoid service interruption.</p>
        </div>
        <button onclick="showCreditsInfo()">Recharge</button>
    </div>

    <!-- Header with Rachel Toggle -->
    <div class="header">
        <div class="header-content">
            <div class="header-top">
                <div></div>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <a href="https://api.leadconnectorhq.com/widget/bookings/missed-call-text-back-bde9451d-56fc-4189-bf4e-beb0f6661258-7e52ccdb-45c2-4ce8-99f6-a7bf13669fc4-3cc62e97-695d-4cf4-85ba-9f47ac4af26f" target="_blank" class="training-btn">
                        <svg style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Book Free Training
                    </a>
                    <button class="logout-btn" onclick="logout()">
                        <svg style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.25rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        Logout
                    </button>
                </div>
            </div>
            
            <!-- AI Assistant Toggle Card with Logo and Business Name -->
            <div class="rachel-card">
                <div class="rachel-toggle-row">
                    <div class="rachel-info">
                        <img src="https://assets.cdn.filesafe.space/3lSeAHXNU9t09Hhp9oai/media/68e1ceaedd63a48d8059af0a.png" alt="RinglyPro" style="height: 40px; width: 40px; border-radius: 8px; margin-right: 10px;">
                        <div class="rachel-text">
                            <h3 style="display: flex; align-items: center; gap: 6px;"><span id="businessNameDisplay">RinglyPro</span></h3>
                            <p style="display: flex; align-items: center; gap: 4px;"><span class="status-dot active" id="rachelStatusDot" style="width: 8px; height: 8px;"></span> <span id="rachelStatusText">Checking status...</span></p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="rachelToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <div class="action-grid">
            <button class="action-btn btn-copilot" onclick="openMCPCopilot()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
                Business Copilot
                <div class="credit-amount" style="background: #60a5fa;">AI</div>
            </button>
<!-- SMS/Dial button removed - functionality moved to Contacts card -->
            <button class="action-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);" onclick="openContactsModal()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                Contacts
                <div class="credit-amount" id="contactsCount" style="background: #8b5cf6;">0</div>
            </button>
            <button class="action-btn btn-calendar" onclick="openSettings()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Settings
            </button>
            <button class="action-btn btn-share" onclick="shareReferralLink()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                </svg>
                Share
                <div class="credit-amount" id="referralCount" style="background: #10b981;">0</div>
            </button>
            <!-- IVR, Projects, User Guide buttons removed for Client 15 -->
            <button class="action-btn" onclick="showCreditsInfo()" style="background: linear-gradient(135deg, #10b981, #059669);">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Tokens
                <div class="credit-amount" id="tokensCardAmount" style="background: #10b981;">0</div>
            </button>
            <button class="action-btn" onclick="openAnalyticsModal()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Analytics
            </button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-tab="today">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Calendar
        </button>
        <button class="nav-tab" data-tab="messages">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
            </svg>
            Messages
            <span id="messagesBadge" class="tab-badge" style="display: none;">0</span>
        </button>
    </div>

    <!-- Content Area -->
    <div class="content">
        <!-- Calendar / Appointments -->
        <div class="content-section active" id="todaySection">
            <div class="section-header" style="flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <!-- Calendar Header with icon - Only shown for Client 15 -->
                    <div id="calendarHeaderClient15" style="display: none; align-items: center; gap: 0.5rem;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20" style="color: #4F46E5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span style="font-weight: 600; font-size: 1rem; color: #111827;">Calendar</span>
                    </div>
                    <!-- Schedule Header - Only shown for non-Client 15 -->
                    <div id="scheduleHeaderOthers" style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20" style="color: #4F46E5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span style="font-weight: 600; font-size: 1rem; color: #111827;">Schedule</span>
                    </div>
                    <!-- Hidden elements for backward compatibility -->
                    <div id="viewToggleButtons" style="display: none;">
                        <button id="listViewBtn" style="display: none;"></button>
                        <button id="calendarViewBtn" style="display: none;"></button>
                    </div>
                    <!-- Refresh Button - Only shown for Client 15 -->
                    <button id="refreshAppointmentsBtn" onclick="refreshClient15Appointments()" class="btn-refresh" style="display: none;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Refresh
                    </button>
                    <button onclick="openAppointmentModal()" class="btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        New Appointment
                    </button>
                </div>
            </div>
            <!-- List View (shown for Client 15) -->
            <div id="appointmentsList" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading appointments...</p>
                </div>
            </div>
            <!-- Calendar Grid View (shown for Client 15) -->
            <div id="calendarView" style="display: none;">
                <div class="calendar-grid-container">
                    <div class="calendar-nav">
                        <button onclick="navigateCalendarWeek(-1)" title="Previous Week">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button class="today-btn" onclick="navigateCalendarWeek(0)">Today</button>
                        <button onclick="navigateCalendarWeek(1)" title="Next Week">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        <span class="current-week" id="currentWeekLabel">Dec 30 - Jan 5</span>
                    </div>
                    <div class="calendar-header" id="calendarHeader">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <div class="calendar-body" id="calendarBody">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <!-- Schedule View (GHL Calendar Cards) - Default View -->
            <div id="ghlCardsView" style="display: block;">
                <div class="ghl-cards-container">
                    <div class="ghl-cards-header">
                        <button onclick="refreshGHLCards()" class="btn-refresh" id="refreshGHLCardsBtn">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                            Refresh
                        </button>
                        <span class="ghl-last-updated" id="ghlLastUpdated"></span>
                    </div>
                    <div class="ghl-cards-grid" id="ghlCardsGrid">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading GHL calendars...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages Section -->
        <div class="content-section" id="messagesSection">
            <div class="section-header">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <!-- View Toggle -->
                    <div style="display: flex; background: #f3f4f6; border-radius: 0.5rem; padding: 2px;">
                        <button id="voicemailsViewBtn" onclick="switchMessagesView('voicemails')" style="padding: 0.4rem 0.75rem; border-radius: 0.4rem; border: none; cursor: pointer; font-size: 0.8rem; background: #3b82f6; color: white; transition: all 0.2s;">
                            Voicemails
                        </button>
                        <button id="conversationsViewBtn" onclick="switchMessagesView('conversations')" style="padding: 0.4rem 0.75rem; border-radius: 0.4rem; border: none; cursor: pointer; font-size: 0.8rem; background: transparent; color: #6b7280; transition: all 0.2s;">
                            Conversations
                        </button>
                    </div>
                    <button onclick="refreshMessages()" class="btn-refresh" id="refreshMessagesBtn" style="display: flex; align-items: center; gap: 0.5rem;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        <span id="refreshBtnText">Refresh</span>
                    </button>
                </div>
            </div>

            <!-- Voicemails View -->
            <div id="messagesList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading messages...</p>
                </div>
            </div>

            <!-- Conversations View (GHL Synced) -->
            <div id="conversationsList" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading conversations...</p>
                </div>
            </div>
        </div>

        <!-- Conversation Detail Modal -->
        <div id="conversationModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                    <div>
                        <h3 id="conversationContactName" style="margin: 0;">Contact Name</h3>
                        <p id="conversationContactPhone" style="margin: 0; font-size: 0.875rem; color: #6b7280;"></p>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="ghlSyncIndicator" style="display: none; background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                            GHL Synced
                        </span>
                        <button onclick="syncConversationWithGHL()" id="syncGHLBtn" style="padding: 0.4rem 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem;">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                            Sync GHL
                        </button>
                        <button onclick="closeConversationModal()" style="background: none; border: none; cursor: pointer; padding: 0.5rem;">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="conversationMessages" style="flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Messages will be rendered here -->
                </div>
                <div style="padding: 1rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.5rem;">
                    <input type="text" id="conversationReplyInput" placeholder="Type a message..." style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem;">
                    <button onclick="sendConversationReply()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Communications - DEPRECATED: Replaced by messagesSection -->
        <!-- <div class="content-section" id="communicationsSection">
            <div class="section-header">
                <h2>Recent Communications</h2>
            </div>
            <div id="communicationsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading communications...</p>
                </div>
            </div>
        </div> -->
    </div>

    <!-- Contact Search Modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Select Contact</h3>
                <button class="close-modal" onclick="closeContactSearch()"></button>
            </div>
            <div class="modal-body">
                <div class="search-input-wrapper">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input type="text" class="search-input" id="contactSearch" placeholder="Type name or phone number..." oninput="searchContacts()">
                </div>
                <div id="contactResults">
                    <p style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Recent Contacts</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal (formerly Calendar Settings) -->
    <div class="modal-overlay" id="calendarModal" style="align-items: center; justify-content: center;">
        <div class="modal-content" style="max-width: 95vw; width: 900px; max-height: 95vh; border-radius: 0.75rem; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-modal" onclick="closeSettings()"></button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <!-- Integrations Content -->
                <div id="crmTabContent">
                    <!-- Integration Links (at top for easy access) -->
                    <div style="position: relative; z-index: 100;">
                        <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1.5rem; color: #1f2937;">Integration Settings</h4>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">Click any card to configure that integration:</p>

                        <!-- Integration Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <!-- RinglyPro Calendar -->
                            <a href="/settings/calendar" target="_blank" rel="noopener" style="display: block; padding: 1rem; background: #f5f5f7; border: 2px solid #1d1d1f; border-radius: 0.5rem; text-decoration: none; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <img src="https://assets.cdn.filesafe.space/3lSeAHXNU9t09Hhp9oai/media/68e1ceaedd63a48d8059af0a.png" alt="RinglyPro" width="24" height="24" style="border-radius: 4px;">
                                    <span style="font-weight: 600; color: #1d1d1f;">RinglyPro Calendar</span>
                                    <span style="font-size: 0.75rem; color: #9ca3af;"></span>
                                </div>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0;">Appointment booking schedule</p>
                            </a>

                            <!-- WhatsApp -->
                            <a href="/settings/whatsapp" target="_blank" rel="noopener" style="display: block; padding: 1rem; background: #f0fdf4; border: 2px solid #25D366; border-radius: 0.5rem; text-decoration: none; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="#25D366"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                                    <span style="font-weight: 600; color: #166534;">WhatsApp</span>
                                    <span style="font-size: 0.75rem; color: #9ca3af;"></span>
                                </div>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0;">AI lead response & booking</p>
                            </a>

                            <!-- GoHighLevel -->
                            <a href="/settings/ghl" target="_blank" rel="noopener" style="display: block; padding: 1rem; background: #fff7ed; border: 2px solid #ff6b35; border-radius: 0.5rem; text-decoration: none; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#ff6b35"/><path d="M7 12h10M12 7v10" stroke="white" stroke-width="2.5" stroke-linecap="round"/></svg>
                                    <span style="font-weight: 600; color: #ea580c;">GoHighLevel</span>
                                    <span style="font-size: 0.75rem; color: #9ca3af;"></span>
                                </div>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0;">CRM & workflow automation</p>
                            </a>

                            <!-- SendGrid -->
                            <a href="/settings/sendgrid" target="_blank" rel="noopener" style="display: block; padding: 1rem; background: #eff6ff; border: 2px solid #1a82e2; border-radius: 0.5rem; text-decoration: none; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" fill="#1a82e2"/><path d="M8 8h8v8H8V8z" fill="#fff"/><path d="M8 8h4v4H8V8z" fill="#1a82e2"/><path d="M12 12h4v4h-4v-4z" fill="#1a82e2"/></svg>
                                    <span style="font-weight: 600; color: #1d4ed8;">SendGrid</span>
                                    <span style="font-size: 0.75rem; color: #9ca3af;"></span>
                                </div>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0;">Email marketing</p>
                            </a>

                            <!-- Zelle -->
                            <a href="/settings/zelle" target="_blank" rel="noopener" style="display: block; padding: 1rem; background: #faf5ff; border: 2px solid #6d1ed4; border-radius: 0.5rem; text-decoration: none; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="11" fill="#6d1ed4"/><path d="M7 9h10l-6 6h6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <span style="font-weight: 600; color: #7c3aed;">Zelle</span>
                                    <span style="font-size: 0.75rem; color: #9ca3af;"></span>
                                </div>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0;">Deposit collection</p>
                            </a>

                            <!-- Business Settings -->
                            <a href="/settings/business" target="_blank" rel="noopener" style="display: block; padding: 1rem; background: #f0fdf4; border: 2px solid #10b981; border-radius: 0.5rem; text-decoration: none; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#10b981"/><path d="M12 4v4M12 16v4M4 12h4M16 12h4" stroke="white" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="3" stroke="white" stroke-width="2"/></svg>
                                    <span style="font-weight: 600; color: #059669;">Business Settings</span>
                                    <span style="font-size: 0.75rem; color: #9ca3af;"></span>
                                </div>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0;">Business info & deposit requirements</p>
                            </a>
                        </div>
                    </div>

                    <!-- Outbound Voicemail Section (below integrations) -->
                    <form id="crmSettingsForm">
                        <div class="crm-section" style="border-top: 1px solid #e5e7eb; margin-top: 1.5rem; padding-top: 1.5rem;">
                            <h4>
                                <span class="crm-logo"></span>
                                Outbound Voicemail Message
                            </h4>

                            <div class="form-group">
                                <label for="outboundVoicemailMessage">Custom Voicemail Message</label>
                                <textarea
                                    id="outboundVoicemailMessage"
                                    name="outbound_voicemail_message"
                                    rows="6"
                                    maxlength="1000"
                                    placeholder="Enter your custom voicemail message here... Leave blank to use the default RinglyPro message."
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-family: inherit; font-size: 0.875rem; resize: vertical; min-height: 150px;"
                                ></textarea>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                                    <span class="form-hint">Message that plays when calling leads from Business Collector (max 1000 characters)</span>
                                    <span id="voicemailCharCount" style="font-size: 0.75rem; color: #6b7280;">0 / 1000</span>
                                </div>
                            </div>

                            <!-- TCPA Compliance Warning -->
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
                                <p style="font-size: 0.75rem; color: #92400e; margin: 0 0 0.5rem 0; font-weight: 700;">
                                     TCPA COMPLIANCE REQUIRED
                                </p>
                                <p style="font-size: 0.75rem; color: #78350f; margin: 0; line-height: 1.6;">
                                    Your custom message <strong>MUST include</strong> the phrase:<br>
                                    <span style="background: #fff; padding: 0.25rem 0.5rem; border-radius: 0.25rem; display: inline-block; margin-top: 0.5rem; font-weight: 600;">
                                        "This message is for informational purposes only"
                                    </span>
                                    <br><br>
                                    This is required by the Telephone Consumer Protection Act (TCPA) for cold calling compliance. Without this phrase, your message will not be saved.
                                </p>
                            </div>

                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
                                <p style="font-size: 0.75rem; color: #374151; margin: 0 0 0.5rem 0; font-weight: 600;">
                                    Default Message:
                                </p>
                                <p style="font-size: 0.75rem; color: #6b7280; margin: 0; line-height: 1.5; font-style: italic;">
                                    "Hi, this is Lina from RinglyPro.com, calling with a quick business update. RinglyPro offers a free AI receptionist that helps small businesses answer calls, book appointments, and send automatic follow-ups  so you never miss a lead, even after hours. <strong style="color: #374151;">This message is for informational purposes only</strong>, and there's no obligation or payment required. If you'd like to learn more, you can visit RinglyPro.com or call us back at 813-212-4888. If you'd prefer not to receive future informational updates, you can reply stop or call the same number and we'll remove you. Thanks for your time, and have a great day."
                                </p>
                            </div>

                            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 1rem; line-height: 1.5;">
                                <strong>Note:</strong> Custom messages use Twilio Polly voice. Default message uses ElevenLabs Rachel Premium voice.
                            </p>

                            <!-- Save Button for Voicemail -->
                            <div class="modal-actions" style="margin-top: 1.5rem;">
                                <button type="submit" class="btn-save" id="saveCrmBtn">Save Voicemail Message</button>
                            </div>
                        </div>
                    </form>

                    <!-- Close Button -->
                    <div class="modal-actions" style="margin-top: 1.5rem;">
                        <button type="button" class="btn-cancel" onclick="closeSettings()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- IVR Settings Modal -->
    <div class="modal-overlay" id="ivrModal" style="align-items: center; justify-content: center;">
        <div class="modal-content" style="max-width: 95vw; width: 800px; max-height: 95vh; border-radius: 0.75rem; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h3>IVR Settings</h3>
                <button class="close-modal" onclick="closeIVRSettings()"></button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                <form id="ivrSettingsForm">
                    <!-- Global Enable/Disable Toggle -->
                    <div class="setting-row">
                        <label class="setting-label">
                            <span class="setting-title">Enable IVR (Call Transfer)</span>
                            <span class="setting-description">Allow Rachel/Lina to offer call transfer options to your team</span>
                        </label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="ivrEnabled">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="divider"></div>

                    <!-- Instructions -->
                    <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <p style="margin: 0; font-size: 0.875rem; color: #374151;">
                            <strong>How it works:</strong> When enabled, Rachel or Lina will offer callers the option to be transferred to one of your departments. Configure up to 3 transfer options below.
                        </p>
                    </div>

                    <!-- Department Configuration -->
                    <h4 class="section-heading">Transfer Options (Max 3)</h4>

                    <!-- Department 1 -->
                    <div class="ivr-department">
                        <div class="setting-row" style="align-items: flex-start;">
                            <div style="flex: 1;">
                                <label class="form-label">Department Name</label>
                                <input type="text" id="dept1Name" class="form-input" placeholder="e.g., Sales, Support, Manager" maxlength="50">
                            </div>
                            <label class="toggle-switch" style="margin-left: 1rem; margin-top: 1.75rem;">
                                <input type="checkbox" id="dept1Enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="dept1Phone" class="form-input" placeholder="+1 (555) 123-4567" maxlength="20">
                        </div>
                    </div>

                    <div class="divider" style="margin: 1.5rem 0;"></div>

                    <!-- Department 2 -->
                    <div class="ivr-department">
                        <div class="setting-row" style="align-items: flex-start;">
                            <div style="flex: 1;">
                                <label class="form-label">Department Name</label>
                                <input type="text" id="dept2Name" class="form-input" placeholder="e.g., Sales, Support, Manager" maxlength="50">
                            </div>
                            <label class="toggle-switch" style="margin-left: 1rem; margin-top: 1.75rem;">
                                <input type="checkbox" id="dept2Enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="dept2Phone" class="form-input" placeholder="+1 (555) 123-4567" maxlength="20">
                        </div>
                    </div>

                    <div class="divider" style="margin: 1.5rem 0;"></div>

                    <!-- Department 3 -->
                    <div class="ivr-department">
                        <div class="setting-row" style="align-items: flex-start;">
                            <div style="flex: 1;">
                                <label class="form-label">Department Name</label>
                                <input type="text" id="dept3Name" class="form-input" placeholder="e.g., Sales, Support, Manager" maxlength="50">
                            </div>
                            <label class="toggle-switch" style="margin-left: 1rem; margin-top: 1.75rem;">
                                <input type="checkbox" id="dept3Enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div style="margin-top: 0.75rem;">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" id="dept3Phone" class="form-input" placeholder="+1 (555) 123-4567" maxlength="20">
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeIVRSettings()">Cancel</button>
                        <button type="submit" class="btn-save" id="saveIVRBtn">Save IVR Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Credits Purchase Modal -->
    <div id="creditsModal" class="credits-modal">
        <div class="credits-modal-content">
            <div class="credits-modal-header">
                <h2>Add Tokens</h2>
                <button class="credits-modal-close" onclick="closeCreditsModal()">&times;</button>
            </div>

            <div class="credits-modal-body">
                <!-- Current Balance -->
                <div class="current-balance-display">
                    <h3>Token Balance</h3>
                    <p class="balance-amount" id="modalBalance">0 tokens</p>
                    <div class="balance-stats">
                        <div class="balance-stat">
                            <strong id="modalFreeMinutes">0</strong> free tokens used
                        </div>
                        <div class="balance-stat">
                            <strong id="modalPaidMinutes">0</strong> purchased tokens
                        </div>
                    </div>
                </div>

                <!-- Package Selection -->
                <div class="package-selection">
                    <h3>Select Token Package</h3>
                    <div class="package-grid">
                        <div class="package-option" onclick="selectPackage(10)" data-amount="10">
                            <div class="package-amount">$10</div>
                            <div class="package-minutes">200 tokens</div>
                            <div class="package-rate">$0.05/token</div>
                        </div>
                        <div class="package-option" onclick="selectPackage(20)" data-amount="20">
                            <div class="package-amount">$20</div>
                            <div class="package-minutes">400 tokens</div>
                            <div class="package-rate">$0.05/token</div>
                        </div>
                        <div class="package-option" onclick="selectPackage(50)" data-amount="50">
                            <div class="package-amount">$50</div>
                            <div class="package-minutes">1,000 tokens</div>
                            <div class="package-rate">$0.05/token</div>
                        </div>
                        <div class="package-option" onclick="selectPackage(100)" data-amount="100">
                            <div class="package-amount">$100</div>
                            <div class="package-minutes">2,000 tokens</div>
                            <div class="package-rate">$0.05/token</div>
                        </div>
                    </div>
                </div>

                <!-- Payment Form -->
                <div class="payment-form">
                    <h3>
                        Payment Details
                        <span class="stripe-badge">
                            <svg fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                            SECURED BY STRIPE
                        </span>
                    </h3>
                    <div id="card-element"></div>
                    <div id="card-errors" role="alert"></div>
                </div>

                <!-- Success Message -->
                <div id="successMessage" class="success-message">
                    Payment successful! Your tokens have been added.
                </div>

                <!-- Actions -->
                <div class="modal-actions">
                    <button id="payButton" class="btn-pay" onclick="processPayment()" disabled>
                        Select a package to continue
                    </button>
                    <button class="btn-cancel" onclick="closeCreditsModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Creation Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-overlay" onclick="closeAppointmentModal()"></div>
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Create New Appointment</h2>
                <button class="modal-close" onclick="closeAppointmentModal()">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <form id="appointmentForm">
                    <!-- Customer Information -->
                    <div class="form-section">
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Customer Information</h3>

                        <div class="form-group">
                            <label for="customerName">Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="customerName" class="form-input" placeholder="John Doe" required>
                        </div>

                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="customerPhone">Phone <span style="color: #ef4444;">*</span></label>
                                <input type="tel" id="customerPhone" class="form-input" placeholder="+1 (555) 000-0000" required>
                            </div>

                            <div class="form-group">
                                <label for="customerEmail">Email</label>
                                <input type="email" id="customerEmail" class="form-input" placeholder="john@example.com">
                            </div>
                        </div>
                    </div>

                    <!-- Appointment Date & Time -->
                    <div class="form-section" style="margin-top: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Date & Time</h3>

                        <div class="form-group">
                            <label for="appointmentDate">Date <span style="color: #ef4444;">*</span></label>
                            <input type="date" id="appointmentDate" class="form-input" required onchange="loadAvailableTimeSlots()">
                        </div>

                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="appointmentStartTime">Start Time <span style="color: #ef4444;">*</span></label>
                                <select id="appointmentStartTime" class="form-input" required disabled onchange="updateEndTimeOptions()">
                                    <option value="">Select a date first</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="appointmentEndTime">End Time <span style="color: #ef4444;">*</span></label>
                                <select id="appointmentEndTime" class="form-input" required disabled>
                                    <option value="">Select start time first</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Notes -->
                    <div class="form-section" style="margin-top: 1.5rem;">
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: #374151;">Additional Information</h3>

                        <div class="form-group">
                            <label for="appointmentNotes">Purpose / Notes</label>
                            <textarea id="appointmentNotes" class="form-input" rows="3" placeholder="Appointment reason, special requests, etc."></textarea>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="appointmentLoadingSlots" class="loading-indicator" style="display: none; text-align: center; padding: 1rem; color: #6b7280;">
                        <i class="fas fa-spinner fa-spin"></i> Loading available time slots...
                    </div>

                    <!-- Error Message -->
                    <div id="appointmentError" class="error-message" style="display: none; background: #fee2e2; color: #991b1b; padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem;">
                    </div>

                    <!-- Success Message -->
                    <div id="appointmentSuccess" class="success-message" style="display: none;">
                        Appointment created successfully!
                    </div>

                    <!-- Actions -->
                    <div class="modal-actions" style="margin-top: 1.5rem;">
                        <button type="submit" id="createAppointmentBtn" class="btn-primary" style="padding: 0.75rem 1.5rem;">
                            Create Appointment
                        </button>
                        <button type="button" class="btn-cancel" onclick="closeAppointmentModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Contacts Modal - Full Screen -->
    <div id="contactsModal" class="modal">
        <div class="modal-overlay" onclick="closeContactsModal()"></div>
        <div class="modal-content" style="width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh; margin: 0; border-radius: 0; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>Contacts</h2>
                <button class="modal-close" onclick="closeContactsModal()">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                <!-- Search and Filter -->
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;">
                    <input type="text" id="contactSearchInput" placeholder="Search contacts by name, phone, or email..."
                           style="flex: 1; min-width: 300px; padding: 0.875rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;"
                           oninput="filterContacts()">
                    <select id="contactSourceFilter" onchange="filterContacts()"
                            style="padding: 0.875rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem;">
                        <option value="all">All Sources</option>
                        <option value="ringlypro">RinglyPro</option>
                        <option value="ghl">GHL</option>
                    </select>
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        Showing <span id="contactsShowing" style="font-weight: 600;">0</span> of <span id="contactsTotal" style="font-weight: 600;">0</span> contacts
                    </div>
                </div>

                <!-- Loading State -->
                <div id="contactsLoading" style="text-align: center; padding: 3rem; color: #6b7280;">
                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                    Loading contacts...
                </div>

                <!-- Error State -->
                <div id="contactsError" style="display: none; background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                </div>

                <!-- Contacts List -->
                <div id="contactsList" style="display: none;">
                    <div id="contactsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                        <!-- Contacts will be rendered here -->
                    </div>
                </div>

                <!-- Empty State -->
                <div id="contactsEmpty" style="display: none; text-align: center; padding: 3rem; color: #6b7280;">
                    <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem; opacity: 0.5;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <p style="font-size: 1.1rem;">No contacts found</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Contact Modal -->
    <div id="editContactModal" class="modal">
        <div class="modal-overlay" onclick="closeEditContact()"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Edit Contact</h2>
                <button class="modal-close" onclick="closeEditContact()">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="editContactForm" onsubmit="saveContact(event)">
                    <input type="hidden" id="editContactId">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">First Name</label>
                            <input type="text" id="editFirstName"
                                   style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Last Name</label>
                            <input type="text" id="editLastName"
                                   style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Phone</label>
                        <input type="tel" id="editPhone"
                               style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Email</label>
                        <input type="email" id="editEmail"
                               style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">Tags (comma separated)</label>
                        <input type="text" id="editTags" placeholder="tag1, tag2, tag3"
                               style="width: 100%; padding: 0.625rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
                    </div>

                    <div id="editContactError" style="display: none; background: #fee2e2; color: #991b1b; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem;">
                    </div>

                    <div id="editContactSuccess" style="display: none; background: #d1fae5; color: #065f46; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; font-size: 0.875rem;">
                    </div>

                    <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                        <button type="button" onclick="closeEditContact()"
                                style="padding: 0.625rem 1.25rem; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer;">
                            Cancel
                        </button>
                        <button type="submit" id="editContactSubmitBtn"
                                style="padding: 0.625rem 1.25rem; background: #8b5cf6; color: white; border: none; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer;">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Contact Conversation History Modal -->
    <div id="contactConversationModal" class="modal">
        <div class="modal-overlay" onclick="closeContactConversation()"></div>
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
                <div>
                    <h3 id="contactConvName" style="margin: 0; font-size: 1.1rem;">Contact Name</h3>
                    <p id="contactConvPhone" style="margin: 0; font-size: 0.875rem; color: #6b7280;"></p>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <span id="contactGhlBadge" style="display: none; background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                        GHL Linked
                    </span>
                    <button onclick="syncContactConversationWithGHL()" id="contactSyncGHLBtn" style="padding: 0.4rem 0.75rem; background: #f59e0b; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; gap: 0.25rem;">
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Sync GHL
                    </button>
                    <button class="modal-close" onclick="closeContactConversation()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Contact Info Summary -->
            <div id="contactInfoSummary" style="padding: 0.75rem 1rem; background: #f9fafb; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.8rem; color: #6b7280;">
                    <span id="contactConvEmail"></span>
                    <span id="contactConvTags"></span>
                    <span id="contactConvSource"></span>
                </div>
            </div>
            <!-- Conversation Messages -->
            <div id="contactConvMessages" style="flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; min-height: 300px;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading conversation history...</p>
                </div>
            </div>
            <!-- Reply Input -->
            <div style="padding: 1rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.5rem; flex-shrink: 0;">
                <input type="text" id="contactConvReplyInput" placeholder="Type a message..." style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem;">
                <button onclick="sendContactConvReply()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 500;">
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- Analytics Modal - Full Window -->
    <div id="analyticsModal" class="modal">
        <div class="modal-overlay" onclick="closeAnalyticsModal()"></div>
        <div class="modal-content" style="width: 95vw; max-width: 1400px; height: 90vh; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2>Analytics Dashboard</h2>
                <button class="modal-close" onclick="closeAnalyticsModal()">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                <!-- Time Period Selector -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; justify-content: center;">
                    <button onclick="loadAnalytics('today')" id="analyticsBtn-today" class="analytics-period-btn active"
                            style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f59e0b; color: white; cursor: pointer; font-size: 1rem; font-weight: 500;">
                        Today
                    </button>
                    <button onclick="loadAnalytics('week')" id="analyticsBtn-week" class="analytics-period-btn"
                            style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; cursor: pointer; font-size: 1rem; font-weight: 500;">
                        This Week
                    </button>
                    <button onclick="loadAnalytics('month')" id="analyticsBtn-month" class="analytics-period-btn"
                            style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: white; cursor: pointer; font-size: 1rem; font-weight: 500;">
                        This Month
                    </button>
                </div>

                <!-- Loading State -->
                <div id="analyticsLoading" style="text-align: center; padding: 3rem; color: #6b7280;">
                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                    Loading analytics...
                </div>

                <!-- Analytics Content -->
                <div id="analyticsContent" style="display: none;">
                    <!-- Primary Metrics - Top Row -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold;" id="statTotalCalls">0</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Total Calls</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold;" id="statAppointments">0</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Appointments Booked</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold;" id="statAfterHoursCalls">0</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">After-Hours Calls</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold;" id="statAfterHoursBookings">0</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">After-Hours Bookings</div>
                        </div>
                    </div>

                    <!-- Secondary Metrics - Second Row -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold;" id="statTokensAvailable">0</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Tokens Available</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold;" id="statTokenAvgRate">0</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Token Avg Rate/Call</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center;">
                            <div style="font-size: 2.5rem; font-weight: bold;" id="statAvgConvTime">0:00</div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Avg Conversation Time</div>
                        </div>
                    </div>

                    <!-- Detailed Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                        <!-- Call Details -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem;">
                            <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%;"></span>
                                Call Breakdown
                            </h3>
                            <div style="display: grid; gap: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.5rem;">
                                    <span style="color: #6b7280;">Answered Calls</span>
                                    <span style="font-weight: 600; color: #10b981;" id="statAnsweredCalls">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.5rem;">
                                    <span style="color: #6b7280;">Missed Calls</span>
                                    <span style="font-weight: 600; color: #ef4444;" id="statMissedCalls">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.5rem;">
                                    <span style="color: #6b7280;">Incoming Calls</span>
                                    <span style="font-weight: 600; color: #1f2937;" id="statIncoming">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.5rem;">
                                    <span style="color: #6b7280;">Outgoing Calls</span>
                                    <span style="font-weight: 600; color: #1f2937;" id="statOutgoing">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Time & Messages -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem;">
                            <h3 style="font-size: 1rem; font-weight: 600; color: #374151; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%;"></span>
                                Time & Messages
                            </h3>
                            <div style="display: grid; gap: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.5rem;">
                                    <span style="color: #6b7280;">Total Call Duration</span>
                                    <span style="font-weight: 600; color: #1f2937;" id="statDuration">0 min</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.5rem;">
                                    <span style="color: #6b7280;">Avg Call Duration</span>
                                    <span style="font-weight: 600; color: #1f2937;" id="statAvgDuration">0 min</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.5rem;">
                                    <span style="color: #6b7280;">Messages Received</span>
                                    <span style="font-weight: 600; color: #1f2937;" id="statMessagesIn">0</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.5rem;">
                                    <span style="color: #6b7280;">Messages Sent</span>
                                    <span style="font-weight: 600; color: #1f2937;" id="statMessagesOut">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Answer Rate Progress Bar -->
                    <div style="margin-top: 1.5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <span style="font-size: 1rem; font-weight: 600; color: #374151;">Answer Rate</span>
                            <span style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="statAnswerRate">0%</span>
                        </div>
                        <div style="background: #e5e7eb; border-radius: 9999px; height: 12px; overflow: hidden;">
                            <div id="answerRateBar" style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-content">
            <div class="footer-branding">
                <img src="https://assets.cdn.filesafe.space/3lSeAHXNU9t09Hhp9oai/media/68e1d01be1be509a4f79755b.png" alt="RinglyPro" class="footer-logo">
                <p>AI-Powered Phone Receptionist Service</p>
            </div>

            <div class="footer-links">
                <a href="https://ringlypro.com/privacy" target="_blank">Privacy Policy</a>
                <a href="https://ringlypro.com/terms" target="_blank">Terms of Service</a>
                <a href="https://ringlypro.com/support" target="_blank">Support</a>
                <a href="https://ringlypro.com/docs" target="_blank">Documentation</a>
            </div>

            <div class="footer-contact">
                <p><strong>Customer Service:</strong></p>
                <p><a href="tel:+18886103810">(888) 610-3810</a></p>
                <p><a href="mailto:info@digit2ai.com">info@digit2ai.com</a></p>
            </div>

            <div class="footer-copyright">
                <p>RinglyPro is a service of Digit2ai LLC.  All rights reserved.</p>
                <p style="margin-top: 0.5rem;">All registered trademarks herein are the property of their respective owners.</p>
            </div>
        </div>
    </footer>

    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }

        // Extract CLIENT_ID from JWT token in localStorage
        function getClientIdFromToken() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return null;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));

                console.log('JWT Payload:', payload);
                console.log('clientId from payload:', payload.clientId);

                // Display username in header
                const usernameDisplay = document.getElementById('username-display');
                if (usernameDisplay) {
                    if (payload.firstName && payload.lastName) {
                        usernameDisplay.textContent = `Welcome, ${payload.firstName} ${payload.lastName}`;
                    } else if (payload.businessName) {
                        usernameDisplay.textContent = `Welcome, ${payload.businessName}`;
                    } else if (payload.email) {
                        usernameDisplay.textContent = `Welcome, ${payload.email}`;
                    }
                }

                return payload.clientId;
            } catch (error) {
                console.error('Invalid token:', error);
                window.location.href = '/login';
                return null;
            }
        }

        // Fetch client ID from backend if not in JWT (for legacy tokens)
        async function fetchClientIdFromBackend() {
            try {
                const response = await authenticatedFetch('/api/client/my-client');
                const data = await response.json();
                if (data.success && data.client && data.client.id) {
                    console.log('Fetched clientId from backend:', data.client.id);
                    return data.client.id;
                }
                console.error('Failed to fetch client ID from backend:', data.error);
                return null;
            } catch (error) {
                console.error('Error fetching client ID from backend:', error);
                return null;
            }
        }

        let CLIENT_ID = getClientIdFromToken();
        let currentAction = '';
        let dashboardData = null;
        let authToken = localStorage.getItem('token');
        let creditsData = null;
        let allAppointments = []; // Store all appointments for filtering
        let currentDaysFilter = 7; // Default to 7 days

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            if (!authToken) {
                window.location.href = '/login';
                return;
            }

            // If CLIENT_ID is not in JWT token, fetch it from backend
            if (!CLIENT_ID) {
                console.log('CLIENT_ID not in JWT, fetching from backend...');
                CLIENT_ID = await fetchClientIdFromBackend();
                if (!CLIENT_ID) {
                    console.error('Could not retrieve client ID. Some features may not work.');
                    // Show warning to user
                    const warningEl = document.createElement('div');
                    warningEl.style.cssText = 'background: #FEF3C7; color: #92400E; padding: 10px; text-align: center; font-weight: 500;';
                    warningEl.textContent = 'Your session may be outdated. Please log out and log back in for full functionality.';
                    document.body.insertBefore(warningEl, document.body.firstChild);
                }
            }

            loadRachelStatus();
            loadDashboard();
            loadCreditsBalance();
            loadMessages(); // Load messages independently (fixes loading issue)
            loadReferralStats(); // Load referral statistics
            loadProjectsCount(); // Load active projects count
            setupTabSwitching();
            setupRachelToggle();

            // Start auto-refresh for messages
            startMessagesAutoRefresh();
        });

        // PWA Install functionality
        let deferredPrompt;

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('beforeinstallprompt event fired');
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Button is visible by default, no need to show
        });

        // Install PWA function
        function installPWA() {
            const installBtn = document.getElementById('installAppBtn');

            // Check if we have the install prompt (Android Chrome, Desktop Chrome/Edge)
            if (deferredPrompt) {
                console.log(' Triggering AUTOMATIC install prompt');
                // Show the native browser install prompt - THIS DOES THE AUTOMATIC INSTALL
                deferredPrompt.prompt();

                // Wait for the user to respond to the prompt
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log(' User accepted! App installing automatically...');
                        // Hide the install button after installation
                        if (installBtn) {
                            installBtn.classList.add('hidden');
                        }
                    } else {
                        console.log(' User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                });
                return;
            }

            // Check if iOS (doesn't support automatic prompt)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

            if (isIOS && !isInStandaloneMode) {
                // Show iOS-specific instructions
                showIOSInstallInstructions();
                return;
            }

            // For other browsers that don't support the prompt
            alert('To install RinglyPro:\n\n' +
                  ' Android: Tap Menu ()  Install App\n' +
                  ' Desktop: Look for install icon () in address bar\n' +
                  ' iOS: Tap Share ()  Add to Home Screen');
        }

        // Show iOS install instructions in a better modal
        function showIOSInstallInstructions() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:1rem;';
            modal.innerHTML = `
                <div style="background:white;border-radius:1rem;padding:2rem;max-width:400px;text-align:center;">
                    <h2 style="margin:0 0 1rem 0;color:#1f2937;font-size:1.5rem;">Install RinglyPro</h2>
                    <p style="color:#6b7280;margin-bottom:1.5rem;">To add this app to your iPhone home screen:</p>
                    <div style="text-align:left;color:#374151;line-height:2;font-size:0.95rem;">
                        <p style="margin:0.5rem 0;"><strong>1.</strong> Tap the <strong>Share button</strong> <svg style="width:1.2rem;height:1.2rem;display:inline-block;vertical-align:middle;" fill="currentColor" viewBox="0 0 20 20"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/></svg> at the bottom</p>
                        <p style="margin:0.5rem 0;"><strong>2.</strong> Scroll down and tap <strong>"Add to Home Screen"</strong></p>
                        <p style="margin:0.5rem 0;"><strong>3.</strong> Tap <strong>"Add"</strong> in the top right corner</p>
                        <p style="margin:0.5rem 0;"><strong>4.</strong> Done! RinglyPro icon will appear on your home screen</p>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()"
                            style="margin-top:1.5rem;background:#10b981;color:white;border:none;padding:0.75rem 2rem;border-radius:0.5rem;font-size:1rem;font-weight:600;cursor:pointer;">
                        Got it!
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            const installBtn = document.getElementById('installAppBtn');
            if (installBtn) {
                installBtn.classList.add('hidden');
            }
        });

        // Hide button if already running as installed app
        window.addEventListener('DOMContentLoaded', () => {
            const installBtn = document.getElementById('installAppBtn');
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                console.log('App is already installed, hiding install button');
                if (installBtn) {
                    installBtn.classList.add('hidden');
                }
            }
        });

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Helper function to make authenticated API calls
        async function authenticatedFetch(url, options = {}) {
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${authToken}`
            };
            
            const response = await fetch(url, { ...options, headers });
            
            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
                return null;
            }
            
            return response;
        }

        // Load Token Balance
        async function loadCreditsBalance() {
            try {
                const response = await authenticatedFetch(`/api/tokens/balance`);
                if (!response) return;

                const data = await response.json();

                if (data.success) {
                    const tokensBalance = data.balance || 0;
                    const tokensUsed = data.usedThisMonth || 0;
                    const packageType = data.package || 'free';
                    const monthlyAllocation = data.monthlyAllocation || 100;

                    // Display total tokens in the Tokens card
                    const tokensCardEl = document.getElementById('tokensCardAmount');
                    if (tokensCardEl) {
                        tokensCardEl.textContent = tokensBalance.toLocaleString();
                    }

                    // Check for low balance (< 50 tokens)
                    if (tokensBalance < 50) {
                        const alert = document.getElementById('lowBalanceAlert');
                        const message = document.getElementById('lowBalanceMessage');
                        message.textContent = `Only ${tokensBalance} tokens remaining. Recharge now to avoid service interruption.`;
                        alert.classList.add('show');
                    } else {
                        document.getElementById('lowBalanceAlert').classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('Error loading token balance:', error);
                const tokensCardEl = document.getElementById('tokensCardAmount');
                if (tokensCardEl) {
                    tokensCardEl.textContent = 'N/A';
                }
            }
        }

        // Load Rachel Status and Business Name
        async function loadRachelStatus() {
            try {
                const response = await authenticatedFetch(`/api/client/rachel-status/${CLIENT_ID}`);
                if (!response) return;

                const data = await response.json();

                if (data.success) {
                    updateRachelUI(data.client.rachel_enabled);
                    document.getElementById('rachelToggle').checked = data.client.rachel_enabled;

                    // Update business name display
                    const businessNameEl = document.getElementById('businessNameDisplay');
                    if (businessNameEl && data.client.business_name) {
                        businessNameEl.textContent = data.client.business_name;
                    }
                }
            } catch (error) {
                console.error('Error loading Rachel status:', error);
                document.getElementById('rachelStatusText').textContent = 'Status unavailable';
            }
        }

        // Update Rachel UI
        function updateRachelUI(enabled) {
            const dot = document.getElementById('rachelStatusDot');
            const text = document.getElementById('rachelStatusText');

            if (!dot || !text) {
                console.warn('Rachel UI elements not found');
                return;
            }

            if (enabled) {
                dot.classList.add('active');
                dot.classList.remove('inactive');
                text.textContent = 'Handling calls';
            } else {
                dot.classList.remove('active');
                dot.classList.add('inactive');
                text.textContent = 'Disabled';
            }
        }

        // Setup Rachel Toggle
        function setupRachelToggle() {
            document.getElementById('rachelToggle').addEventListener('change', async (e) => {
                const enabled = e.target.checked;
                
                try {
                    const response = await authenticatedFetch(`/api/client/rachel-status/${CLIENT_ID}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rachel_enabled: enabled })
                    });
                    
                    if (!response) return;
                    const data = await response.json();
                    
                    if (data.success) {
                        updateRachelUI(enabled);
                        await showForwardingInstructions(enabled);
                    } else {
                        e.target.checked = !enabled;
                        alert('Failed to update Rachel status');
                    }
                } catch (error) {
                    console.error('Error toggling Rachel:', error);
                    e.target.checked = !enabled;
                    alert('Error updating Rachel status');
                }
            });
        }

        // Show forwarding instructions when toggle changes
        async function showForwardingInstructions(enabled) {
            try {
                let carrier = localStorage.getItem('carrier_preference');

                if (!carrier) {
                    carrier = await promptForCarrier();
                    if (!carrier) return;
                    localStorage.setItem('carrier_preference', carrier);
                }

                const response = await authenticatedFetch(`/api/call-forwarding/setup/${carrier}/${CLIENT_ID}`);
                if (!response) return;
                const data = await response.json();

                if (data.success && data.setup && data.setup.recommended) {
                    const businessPhone = data.client.business_phone;
                    const carrierName = data.carrier.name;

                    if (enabled) {
                        // ACTIVATION instructions
                        const activateCode = data.setup.recommended.activate;
                        showForwardingModal(
                            ' Rachel AI Activated!',
                            `To forward calls from your business phone to Rachel AI:`,
                            carrierName,
                            businessPhone,
                            activateCode,
                            'activate'
                        );
                    } else {
                        // DEACTIVATION instructions
                        const deactivateCode = data.setup.recommended.deactivate;
                        showForwardingModal(
                            ' Rachel AI Deactivated',
                            `To stop forwarding calls to Rachel AI:`,
                            carrierName,
                            businessPhone,
                            deactivateCode,
                            'deactivate'
                        );
                    }
                }
            } catch (error) {
                console.error('Error getting forwarding instructions:', error);
            }
        }

        // Helper function to dial a forwarding code
        function dialForwardingCode(code) {
            console.log('dialForwardingCode called with:', code);

            if (window.nativeApp && window.nativeApp.dialCode) {
                console.log('Using native bridge to dial code');
                window.nativeApp.dialCode(code);
            } else {
                console.log('Using tel: link fallback');
                const link = document.createElement('a');
                link.href = 'tel:' + code;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Show forwarding instructions in a modal with clickable dial link
        function showForwardingModal(title, subtitle, carrier, businessPhone, forwardCode, action) {
            // Remove any existing modal
            const existingModal = document.getElementById('forwardingModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal HTML
            const modal = document.createElement('div');
            modal.id = 'forwardingModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    max-width: 500px;
                    width: 100%;
                    padding: 24px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <h2 style="margin: 0 0 8px 0; font-size: 24px; color: #1f2937;">${title}</h2>
                    <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px;">${subtitle}</p>

                    <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="margin-bottom: 12px;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Carrier</div>
                            <div style="font-weight: 600; color: #1f2937;">${carrier}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Business Phone</div>
                            <div style="font-weight: 600; color: #1f2937;">${businessPhone}</div>
                        </div>
                    </div>

                    <div style="background: ${action === 'activate' ? '#eff6ff' : '#fef2f2'}; border: 2px solid ${action === 'activate' ? '#3b82f6' : '#ef4444'}; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="font-size: 13px; font-weight: 600; color: ${action === 'activate' ? '#1e40af' : '#991b1b'}; margin-bottom: 12px;">
                             Tap code to dial:
                        </div>
                        <div onclick="dialForwardingCode('${forwardCode}')" style="
                            display: block;
                            background: ${action === 'activate' ? '#3b82f6' : '#ef4444'};
                            color: white;
                            padding: 20px;
                            border-radius: 10px;
                            text-align: center;
                            font-size: 28px;
                            font-weight: bold;
                            letter-spacing: 3px;
                            font-family: 'Courier New', monospace;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            margin-bottom: 12px;
                            cursor: pointer;
                            user-select: all;
                            -webkit-user-select: all;
                            transition: transform 0.1s;
                        " onmousedown="this.style.transform='scale(0.98)'" onmouseup="this.style.transform='scale(1)'">
                            ${forwardCode}
                        </div>
                        <button onclick="
                            const code = '${forwardCode}';
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                navigator.clipboard.writeText(code).then(() => {
                                    const btn = event.target;
                                    const originalText = btn.innerHTML;
                                    btn.innerHTML = ' Copied! Now open your phone dialer and paste';
                                    btn.style.background = '#22c55e';
                                    setTimeout(() => {
                                        btn.innerHTML = originalText;
                                        btn.style.background = '${action === 'activate' ? '#1e40af' : '#991b1b'}';
                                    }, 3000);
                                });
                            } else {
                                alert('Code: ' + code + '\\n\\nLong-press the code above to copy it, then paste into your phone dialer.');
                            }
                        " style="
                            width: 100%;
                            padding: 14px;
                            background: ${action === 'activate' ? '#1e40af' : '#991b1b'};
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 15px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                        ">
                             Copy Code to Clipboard (iOS)
                        </button>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 12px; text-align: center; line-height: 1.5;">
                            <strong>RinglyPro App:</strong> Tap code above to dial automatically<br>
                            <strong>Web Browser:</strong> Use copy button if tap doesn't work
                        </div>
                    </div>

                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 12px; color: #78350f;">
                            <strong>Note:</strong> Wait for a confirmation tone after dialing. This confirms the ${action === 'activate' ? 'activation' : 'deactivation'} was successful.
                        </div>
                    </div>

                    <button onclick="document.getElementById('forwardingModal').remove()" style="
                        width: 100%;
                        padding: 14px;
                        background: #1f2937;
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: background 0.2s;
                    " onmouseover="this.style.background='#374151'" onmouseout="this.style.background='#1f2937'">
                        Got it!
                    </button>

                    <div style="text-align: center; margin-top: 12px;">
                        <button onclick="localStorage.removeItem('carrier_preference'); document.getElementById('forwardingModal').remove(); alert('Carrier preference cleared. You\\'ll be asked to select again next time.');" style="
                            background: none;
                            border: none;
                            color: #6b7280;
                            font-size: 12px;
                            cursor: pointer;
                            text-decoration: underline;
                            padding: 8px;
                        ">
                            Change Carrier
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Prompt user to select their carrier
        async function promptForCarrier() {
            const carriers = [
                { code: 'att', name: 'AT&T' },
                { code: 'verizon', name: 'Verizon' },
                { code: 'tmobile', name: 'T-Mobile' },
                { code: 'sprint', name: 'Sprint/T-Mobile' },
                { code: 'uscellular', name: 'US Cellular' },
                { code: 'boost', name: 'Boost Mobile' },
                { code: 'metro', name: 'Metro by T-Mobile' },
                { code: 'visible', name: 'Visible' },
                { code: 'cricketwireless', name: 'Cricket Wireless' }
            ];

            return new Promise((resolve) => {
                // Create modal
                const modal = document.createElement('div');
                modal.id = 'carrierSelectionModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                `;

                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 16px;
                        padding: 32px;
                        max-width: 400px;
                        width: 100%;
                        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    ">
                        <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 700; color: #1f2937;">
                             Select Your Phone Carrier
                        </h3>
                        <p style="margin: 0 0 24px 0; color: #6b7280; font-size: 14px;">
                            Choose your mobile carrier to get the correct call forwarding instructions.
                        </p>

                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                Carrier
                            </label>
                            <select id="carrierDropdown" style="
                                width: 100%;
                                padding: 12px 16px;
                                font-size: 15px;
                                border: 2px solid #3b82f6;
                                border-radius: 8px;
                                background: white;
                                color: #1f2937;
                                cursor: pointer;
                                outline: none;
                                font-family: inherit;
                            ">
                                <option value="">-- Select a carrier --</option>
                                ${carriers.map(c => `<option value="${c.code}">${c.name}</option>`).join('')}
                            </select>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button id="confirmCarrier" style="
                                flex: 1;
                                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                font-size: 15px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s;
                            " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                Confirm
                            </button>
                            <button id="cancelCarrier" style="
                                flex: 1;
                                background: #f3f4f6;
                                color: #6b7280;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                font-size: 15px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.2s;
                            " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const dropdown = document.getElementById('carrierDropdown');
                const confirmBtn = document.getElementById('confirmCarrier');
                const cancelBtn = document.getElementById('cancelCarrier');

                // Focus dropdown
                dropdown.focus();

                confirmBtn.onclick = () => {
                    const selectedCarrier = dropdown.value;
                    if (!selectedCarrier) {
                        dropdown.style.borderColor = '#ef4444';
                        dropdown.focus();
                        return;
                    }
                    modal.remove();
                    resolve(selectedCarrier);
                };

                cancelBtn.onclick = () => {
                    modal.remove();
                    resolve(null);
                };

                // Allow clicking outside to cancel
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(null);
                    }
                };

                // Reset border color on change
                dropdown.onchange = () => {
                    dropdown.style.borderColor = '#3b82f6';
                };
            });
        }

        // ==================== REFERRAL SYSTEM ====================

        // Load referral statistics
        async function loadReferralStats() {
            try {
                const response = await authenticatedFetch(`/api/referral/${CLIENT_ID}`);
                if (!response) {
                    console.log('No response from referral API - using fallback');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    const countBadge = document.getElementById('referralCount');
                    if (countBadge) {
                        countBadge.textContent = data.stats.totalReferrals || 0;
                    }

                    // Store referral link globally for sharing
                    window.REFERRAL_LINK = data.client.referralLink;
                    window.REFERRAL_CODE = data.client.referralCode;
                }
            } catch (error) {
                console.error('Error loading referral stats:', error);
                // Don't fail silently - keep the default 0 count
                const countBadge = document.getElementById('referralCount');
                if (countBadge) {
                    countBadge.textContent = '0';
                }
            }
        }

        // ==================== PROJECTS COUNT ====================

        // Load active projects count
        async function loadProjectsCount() {
            try {
                const response = await authenticatedFetch('/api/projects');
                if (!response) {
                    console.log('No response from projects API');
                    return;
                }

                const data = await response.json();

                if (data.success && data.projects) {
                    // Count projects that are in progress (not completed or cancelled)
                    const activeCount = data.projects.filter(p =>
                        p.status === 'pending' || p.status === 'in_progress'
                    ).length;

                    const countBadge = document.getElementById('projectsCount');
                    if (countBadge) {
                        countBadge.textContent = activeCount;
                        // Change color based on count
                        if (activeCount > 0) {
                            countBadge.style.background = '#7c3aed'; // Purple for active projects
                        } else {
                            countBadge.style.background = '#6b7280'; // Gray for no projects
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading projects count:', error);
                const countBadge = document.getElementById('projectsCount');
                if (countBadge) {
                    countBadge.textContent = '0';
                    countBadge.style.background = '#6b7280';
                }
            }
        }

        // Share referral link
        async function shareReferralLink() {
            try {
                if (!window.REFERRAL_LINK) {
                    const response = await authenticatedFetch(`/api/referral/${CLIENT_ID}/link`);

                    if (!response) {
                        alert(' Referral System Not Yet Activated\n\nThe referral system needs to be set up in production.\n\nPlease contact support at info@digit2ai.com to activate your referral link.');
                        return;
                    }

                    const data = await response.json();

                    if (!data.success) {
                        alert(' Referral System Not Yet Activated\n\nYour referral code has not been generated yet.\n\nPlease contact support at info@digit2ai.com to activate your referral link.');
                        return;
                    }

                    // Check if we actually got a referral link
                    if (!data.referralLink || data.referralLink.includes('null')) {
                        alert(' Referral Code Not Generated\n\nYour account does not have a referral code yet.\n\nPlease contact support at info@digit2ai.com to generate your referral code.');
                        return;
                    }

                    window.REFERRAL_LINK = data.referralLink;
                    window.REFERRAL_CODE = data.referralCode;
                }

                // Double-check we have a valid link before sharing
                if (!window.REFERRAL_LINK || window.REFERRAL_LINK.includes('null')) {
                    alert(' Referral Code Not Generated\n\nYour account does not have a referral code yet.\n\nPlease contact support at info@digit2ai.com to generate your referral code.');
                    return;
                }

                // Show token system explanation before sharing
                const explanation = confirm(
                    ' EARN TOKENS BY REFERRING FRIENDS!\n\n' +
                    'How it works:\n' +
                    ' They sign up with your link  You get 200 TOKENS ($10 value)\n' +
                    ' They make first purchase  You get 1,000 TOKENS ($50 value)\n\n' +
                    'Your friend gets:\n' +
                    ' 150 FREE tokens (100 base + 50 referral bonus)\n' +
                    ' Access to all AI features\n\n' +
                    'Bonus Tiers:\n' +
                    ' 5 referrals  Silver tier (300/1,500 tokens + 200/month)\n' +
                    ' 25 referrals  Gold tier (500/2,000 tokens + 500/month + 15% CASH!)\n\n' +
                    '\n\n' +
                    ' SERIOUS ABOUT EARNING?\n' +
                    ' Join our Partnership Program\n' +
                    ' Earn 50% PROFIT SHARE (not just tokens!)\n' +
                    ' Monthly recurring payments\n' +
                    ' Lifetime revenue from your referrals\n\n' +
                    ' Visit: aiagent.ringlypro.com/partnership-roadmap\n\n' +
                    '\n\n' +
                    'Your Referral Code: ' + window.REFERRAL_CODE + '\n\n' +
                    'Click OK to share your link now!'
                );

                if (!explanation) {
                    console.log('User canceled share');
                    return;
                }

                const shareData = {
                    title: 'Unlock your FREE AI assistant + 150 tokens!',
                    text: `Unlock your FREE AI assistant + 150 tokens!\n\nJoin RinglyPro with my referral link and instantly get 150 FREE tokens to power real AI that answers calls, sends emails, books appointments, and handles marketing 24/7  automatically.\n\n Proven to boost leads & conversions\n Works for ANY business\n No credit card needed\n Earn tokens just for joining  and you can cash them out for real money!`,
                    url: window.REFERRAL_LINK
                };

                // Try native share API (works on mobile)
                if (navigator.share) {
                    try {
                        await navigator.share(shareData);
                        console.log(' Referral link shared successfully');
                    } catch (shareError) {
                        // User canceled the share - this is normal, don't show error
                        if (shareError.name === 'AbortError') {
                            console.log('Share canceled by user');
                            return; // Exit gracefully
                        }
                        // For other errors, fall through to clipboard copy
                        throw shareError;
                    }
                } else {
                    // Fallback: Copy to clipboard
                    await navigator.clipboard.writeText(window.REFERRAL_LINK);

                    // Show custom alert with the link
                    alert(` Referral link copied to clipboard!\n\n${window.REFERRAL_LINK}\n\nYour referral code: ${window.REFERRAL_CODE}\n\n You earn 200 tokens ($10) when they sign up!\n You earn 1,000 tokens ($50) when they purchase!\n\nPaste and share this link anywhere!`);
                }
            } catch (error) {
                console.error('Error sharing referral link:', error);

                // Fallback: Just show the link if we have it
                if (window.REFERRAL_LINK && !window.REFERRAL_LINK.includes('null')) {
                    alert(`Your referral link:\n\n${window.REFERRAL_LINK}\n\nCode: ${window.REFERRAL_CODE}`);
                } else {
                    alert(' Referral System Error\n\nUnable to generate referral link at this time.\n\nPlease contact support at info@digit2ai.com');
                }
            }
        }

        // Load Dashboard Data
        async function loadDashboard() {
            try {
                // Client 15: Show Calendar header and calendar grid view
                // Other clients: Show Schedule header and use GHL Calendar Cards
                if (isClient15()) {
                    // Show Calendar header, hide Schedule header for Client 15
                    document.getElementById('calendarHeaderClient15').style.display = 'flex';
                    document.getElementById('scheduleHeaderOthers').style.display = 'none';
                    // Show refresh button for Client 15
                    document.getElementById('refreshAppointmentsBtn').style.display = 'flex';
                    // Load calendar grid view directly (no list view)
                    setAppointmentView('calendar');
                } else {
                    // Show Schedule header, hide Calendar header for other clients
                    document.getElementById('calendarHeaderClient15').style.display = 'none';
                    document.getElementById('scheduleHeaderOthers').style.display = 'flex';
                    // Hide refresh button for other clients
                    document.getElementById('refreshAppointmentsBtn').style.display = 'none';
                    // Load GHL Calendar Cards on initial load
                    loadGHLCards();
                }

                // Load communications data separately
                try {
                    const dashboardResponse = await authenticatedFetch(`/api/mobile/dashboard/today/${CLIENT_ID}`);
                    if (dashboardResponse) {
                        const data = await dashboardResponse.json();
                        if (data.success) {
                            dashboardData = data.data;
                            renderCommunications(data.data.communications);
                        }
                    }
                } catch (commError) {
                    console.warn('Error loading communications:', commError);
                    // Continue without communications - schedule still loaded
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Sync CRM Appointments
        async function syncCRMAppointments() {
            const syncBtn = document.getElementById('syncCrmBtn');
            const syncIcon = document.getElementById('syncCrmIcon');
            const syncText = document.getElementById('syncCrmText');
            const lastSyncSpan = document.getElementById('lastSyncTime');

            try {
                // Show loading state
                syncBtn.disabled = true;
                syncIcon.style.animation = 'spin 1s linear infinite';
                syncText.textContent = 'Syncing...';

                console.log(' Starting CRM sync...');

                const response = await authenticatedFetch('/api/appointments/sync-crm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!response) {
                    throw new Error('No response from sync API');
                }

                const result = await response.json();

                if (result.success) {
                    console.log(' CRM sync complete:', result);

                    // Show success notification
                    const totalSynced = result.syncResults.created + result.syncResults.updated;
                    const fetchedTotal = result.fetched.ghl + result.fetched.hubspot + result.fetched.vagaro;
                    const errorCount = result.syncErrors?.length || 0;

                    let message = 'CRM Sync Complete!\n\n';
                    message += `Fetched: ${fetchedTotal} appointments\n`;
                    message += `- GHL: ${result.fetched.ghl}\n`;
                    message += `- HubSpot: ${result.fetched.hubspot}\n`;
                    message += `- Vagaro: ${result.fetched.vagaro}\n\n`;
                    message += `Synced: ${result.syncResults.created} new, ${result.syncResults.updated} updated`;

                    if (errorCount > 0) {
                        message += `\n\n ${errorCount} error(s):\n`;
                        message += result.syncErrors.slice(0, 3).join('\n');
                        if (errorCount > 3) {
                            message += `\n...and ${errorCount - 3} more`;
                        }
                    }

                    if (fetchedTotal > 0 || errorCount > 0) {
                        alert(message);
                    } else {
                        alert('CRM Sync Complete!\n\nNo appointments found in connected CRMs.');
                    }

                    // Update last sync time
                    lastSyncSpan.textContent = 'Last sync: just now';
                    lastSyncSpan.style.display = 'inline';

                    // Reload dashboard to show new appointments
                    await loadDashboard();
                } else {
                    throw new Error(result.error || 'Sync failed');
                }
            } catch (error) {
                console.error(' CRM sync error:', error);
                alert(`CRM Sync Error: ${error.message}`);
            } finally {
                // Reset button state
                syncBtn.disabled = false;
                syncIcon.style.animation = '';
                syncText.textContent = 'Sync CRM';
            }
        }

        // Filter appointments by date range
        function filterAppointmentsByDays(days) {
            currentDaysFilter = days;

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-days') == days) {
                    tab.classList.add('active');
                }
            });

            // Filter and render
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + days);

            console.log(` Filtering for ${days} days:`, {
                today: today.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                totalAppointments: allAppointments.length
            });

            const filtered = allAppointments.filter(apt => {
                // Parse date in local timezone (avoid UTC conversion)
                const dateString = apt.appointmentDate; // "2025-10-28"
                const [year, month, day] = dateString.split('-').map(Number);
                const aptDate = new Date(year, month - 1, day); // month is 0-indexed
                aptDate.setHours(0, 0, 0, 0);

                const matches = aptDate >= today && aptDate <= endDate;

                // Debug log each appointment
                if (days === 30) {
                    console.log(`  Appointment: ${apt.customerName} on ${dateString}`, {
                        aptDate: aptDate.toISOString().split('T')[0],
                        daysFromToday: Math.floor((aptDate - today) / (1000 * 60 * 60 * 24)),
                        matches: matches
                    });
                }

                return matches;
            });

            console.log(` Found ${filtered.length} appointments in ${days}-day range`);

            renderFilteredAppointments(filtered);

            // Also refresh calendar view if it's currently active
            if (currentView === 'calendar') {
                renderCalendarView();
            }
        }

        // =====================================================
        // CALENDAR VIEW FUNCTIONS
        // =====================================================

        let currentView = 'ghlCards'; // 'ghlCards' is the default (Schedule view)
        let calendarWeekOffset = 0; // 0 = current week, -1 = last week, 1 = next week
        let ghlCardsData = null; // Cache for GHL cards data

        // Check if client uses RinglyPro Calendar View (Client 15 and 32)
        // These clients use the default RinglyPro calendar instead of GHL Cards
        function isClient15() {
            return CLIENT_ID === 15 || CLIENT_ID === 32;
        }

        // Set appointment view - Client 15 uses list/calendar, others use GHL Cards
        function setAppointmentView(view) {
            const listView = document.getElementById('appointmentsList');
            const calendarView = document.getElementById('calendarView');
            const ghlCardsView = document.getElementById('ghlCardsView');
            const listViewBtn = document.getElementById('listViewBtn');
            const calendarViewBtn = document.getElementById('calendarViewBtn');

            // Client 15 uses traditional list/calendar views
            if (isClient15()) {
                currentView = view || 'calendar';

                // Hide GHL Cards view
                ghlCardsView.style.display = 'none';

                if (currentView === 'list') {
                    listView.style.display = 'block';
                    listView.style.removeProperty('display'); // Remove !important
                    calendarView.style.display = 'none';
                    listViewBtn.style.background = '#3b82f6';
                    listViewBtn.style.color = 'white';
                    calendarViewBtn.style.background = 'transparent';
                    calendarViewBtn.style.color = '#6b7280';
                    loadAppointmentsForList();
                } else if (currentView === 'calendar') {
                    listView.style.display = 'none';
                    calendarView.style.display = 'block';
                    calendarView.style.removeProperty('display'); // Remove !important
                    listViewBtn.style.background = 'transparent';
                    listViewBtn.style.color = '#6b7280';
                    calendarViewBtn.style.background = '#3b82f6';
                    calendarViewBtn.style.color = 'white';
                    // Load appointments first, then render calendar
                    loadAppointmentsForCalendar();
                }
            } else {
                // All other clients use GHL Cards (Schedule) view
                currentView = 'ghlCards';
                listView.style.display = 'none';
                calendarView.style.display = 'none';
                ghlCardsView.style.display = 'block';
                loadGHLCards();
            }
        }

        // Load appointments for list view (Client 15)
        async function loadAppointmentsForList() {
            const container = document.getElementById('appointmentsList');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading appointments...</p>
                </div>
            `;

            try {
                const response = await authenticatedFetch('/api/appointments/dashboard?days=14&refresh=true');
                if (!response) throw new Error('No response');

                const data = await response.json();
                if (data.success && data.appointments) {
                    allAppointments = data.appointments;
                    renderFilteredAppointments(data.appointments);
                } else {
                    throw new Error(data.error || 'Failed to load appointments');
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Error loading appointments: ${error.message}</p>
                        <button onclick="loadAppointmentsForList()" class="btn-primary" style="margin-top: 1rem;">Retry</button>
                    </div>
                `;
            }
        }

        // Load appointments for calendar view (Client 15)
        async function loadAppointmentsForCalendar() {
            const calendarBody = document.getElementById('calendarBody');

            // Show loading state in calendar body
            if (calendarBody) {
                calendarBody.innerHTML = `
                    <div class="loading" style="padding: 2rem; text-align: center; grid-column: 1 / -1;">
                        <div class="spinner"></div>
                        <p>Loading appointments...</p>
                    </div>
                `;
            }

            try {
                const response = await authenticatedFetch('/api/appointments/dashboard?days=30&refresh=true');
                if (!response) throw new Error('No response');

                const data = await response.json();
                console.log(' Calendar API response:', data);

                if (data.success && data.appointments) {
                    allAppointments = data.appointments;
                    console.log(' Loaded appointments for calendar:', allAppointments.length);
                    console.log(' Appointments data:', JSON.stringify(allAppointments, null, 2));

                    // Render calendar with loaded appointments
                    renderCalendarView();
                } else {
                    throw new Error(data.error || 'Failed to load appointments');
                }
            } catch (error) {
                console.error('Error loading appointments for calendar:', error);
                if (calendarBody) {
                    calendarBody.innerHTML = `
                        <div class="empty-state" style="padding: 2rem; text-align: center; grid-column: 1 / -1;">
                            <p>Error loading appointments: ${error.message}</p>
                            <button onclick="loadAppointmentsForCalendar()" class="btn-primary" style="margin-top: 1rem;">Retry</button>
                        </div>
                    `;
                }
            }
        }

        // Refresh Client 15 appointments
        function refreshClient15Appointments() {
            if (currentView === 'list') {
                loadAppointmentsForList();
            } else if (currentView === 'calendar') {
                // Reload appointments and re-render calendar
                loadAppointmentsForCalendar();
            }
        }

        // Load GHL Calendar Cards data
        async function loadGHLCards() {
            const grid = document.getElementById('ghlCardsGrid');
            const lastUpdated = document.getElementById('ghlLastUpdated');

            // Show loading if no cached data
            if (!ghlCardsData) {
                grid.innerHTML = `
                    <div class="loading" style="grid-column: 1 / -1;">
                        <div class="spinner"></div>
                        <p>Loading GHL calendars...</p>
                    </div>
                `;
            }

            try {
                const response = await fetch('/api/appointments/ghl-calendar-slots?days=7', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch GHL slots');

                const data = await response.json();
                ghlCardsData = data;

                if (!data.success || !data.calendars || data.calendars.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #6b7280;">
                            <p>No GHL calendars configured for this client.</p>
                        </div>
                    `;
                    return;
                }

                renderGHLCards(data);
                lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error loading GHL cards:', error);
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #dc2626;">
                        <p>Error loading GHL calendars: ${error.message}</p>
                        <button onclick="loadGHLCards()" class="btn-primary" style="margin-top: 1rem;">Retry</button>
                    </div>
                `;
            }
        }

        // Render GHL Calendar Cards
        function renderGHLCards(data) {
            const grid = document.getElementById('ghlCardsGrid');
            const dates = Object.keys(data.calendars[0]?.slotsByDate || {}).sort();

            let html = '';

            for (const calendar of data.calendars) {
                // Determine card color class
                let colorClass = '';
                const nameLower = calendar.name.toLowerCase();
                if (nameLower.includes('hyperbaric')) colorClass = 'hyperbaric';
                else if (nameLower.includes('cryotherapy') || nameLower.includes('cryo')) colorClass = 'cryotherapy';
                else if (nameLower.includes('recovery')) colorClass = 'recovery';

                // Build open hours string
                let openHoursStr = '';
                if (calendar.openHours) {
                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const hours = {};
                    for (const [day, config] of Object.entries(calendar.openHours)) {
                        const key = `${config.openHour}:00-${config.closeHour}:00`;
                        if (!hours[key]) hours[key] = [];
                        hours[key].push(dayNames[day]);
                    }
                    openHoursStr = Object.entries(hours).map(([time, days]) => `${days.join(', ')}: ${time}`).join(' | ');
                }

                html += `
                    <div class="ghl-calendar-card ${colorClass}">
                        <div class="ghl-card-header">
                            <h3>${calendar.name}</h3>
                            <div class="calendar-id">ID: ${calendar.id}</div>
                            <div class="open-hours">${openHoursStr || 'No open hours configured'}</div>
                        </div>
                        <div class="ghl-card-body">
                `;

                // Add rows for each date
                for (const dateStr of dates) {
                    const dayData = calendar.slotsByDate[dateStr];
                    if (!dayData) continue;

                    const dateParts = dateStr.split('-');
                    const displayDate = `${dateParts[1]}/${dateParts[2]}`;

                    if (dayData.closed) {
                        html += `
                            <div class="ghl-date-row closed">
                                <div class="ghl-date-label">
                                    ${displayDate}
                                    <div class="day-name">${dayData.dayName}</div>
                                </div>
                                <div class="ghl-slots-container">
                                    <span class="ghl-closed-badge">CLOSED</span>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="ghl-date-row">
                                <div class="ghl-date-label">
                                    ${displayDate}
                                    <div class="day-name">${dayData.dayName}</div>
                                </div>
                                <div class="ghl-slots-container">
                                    <div class="ghl-slots-row free">
                                        <span class="label">FREE:</span>
                                        <div class="slots">
                                            ${dayData.freeSlots.length > 0
                                                ? dayData.freeSlots.map(s => `<span class="ghl-slot-badge free">${s}</span>`).join('')
                                                : '<span style="color: #9ca3af; font-size: 0.7rem;">None</span>'}
                                        </div>
                                    </div>
                                    <div class="ghl-slots-row busy">
                                        <span class="label">BUSY:</span>
                                        <div class="slots">
                                            ${dayData.busySlots.length > 0
                                                ? dayData.busySlots.map(s => `<span class="ghl-slot-badge busy">${s}</span>`).join('')
                                                : '<span style="color: #9ca3af; font-size: 0.7rem;">None</span>'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                html += `
                        </div>
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        // Refresh GHL Cards
        function refreshGHLCards() {
            ghlCardsData = null; // Clear cache
            loadGHLCards();
        }

        // Navigate calendar weeks
        function navigateCalendarWeek(direction) {
            if (direction === 0) {
                calendarWeekOffset = 0; // Go to today
            } else {
                calendarWeekOffset += direction;
            }
            renderCalendarView();
        }

        // Get the start of the week (Sunday) for a given date
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Format date for display
        function formatCalendarDate(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()}`;
        }

        // Render the calendar grid view
        function renderCalendarView() {
            const headerContainer = document.getElementById('calendarHeader');
            const bodyContainer = document.getElementById('calendarBody');
            const weekLabel = document.getElementById('currentWeekLabel');

            // Calculate week dates
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekStart = getWeekStart(today);
            weekStart.setDate(weekStart.getDate() + (calendarWeekOffset * 7));

            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            // Update week label
            weekLabel.textContent = `${formatCalendarDate(weekStart)} - ${formatCalendarDate(weekEnd)}`;

            // Generate header with day names and dates
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            let headerHtml = '<div class="calendar-header-cell"></div>'; // Empty cell for time column

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(dayDate.getDate() + i);
                const isToday = dayDate.toDateString() === today.toDateString();

                headerHtml += `
                    <div class="calendar-header-cell ${isToday ? 'today' : ''}">
                        <div class="day-name">${dayNames[i]}</div>
                        <div class="day-date">${dayDate.getDate()}</div>
                    </div>
                `;
            }
            headerContainer.innerHTML = headerHtml;

            // Generate time slots (8am to 9pm)
            const startHour = 8;
            const endHour = 21;

            // Create time column
            let timeColumnHtml = '<div class="time-column">';
            for (let hour = startHour; hour <= endHour; hour++) {
                const displayHour = hour > 12 ? hour - 12 : hour;
                const ampm = hour >= 12 ? 'PM' : 'AM';
                timeColumnHtml += `<div class="time-slot-label">${displayHour}${ampm}</div>`;
            }
            timeColumnHtml += '</div>';

            // Create day columns with time slots
            let dayColumnsHtml = '';
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                const dayDate = new Date(weekStart);
                dayDate.setDate(dayDate.getDate() + dayIndex);
                const dateString = dayDate.toISOString().split('T')[0]; // YYYY-MM-DD

                dayColumnsHtml += `<div class="day-column" data-date="${dateString}">`;
                for (let hour = startHour; hour <= endHour; hour++) {
                    dayColumnsHtml += `<div class="time-slot" data-hour="${hour}"></div>`;
                }
                dayColumnsHtml += '</div>';
            }

            bodyContainer.innerHTML = timeColumnHtml + dayColumnsHtml;

            // Place appointments on the calendar
            placeAppointmentsOnCalendar(weekStart);
        }

        // Place appointments on the calendar grid
        function placeAppointmentsOnCalendar(weekStart) {
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);

            console.log(' placeAppointmentsOnCalendar called');
            console.log(' weekStart:', weekStart.toISOString());
            console.log(' weekEnd:', weekEnd.toISOString());
            console.log(' allAppointments count:', allAppointments.length);
            console.log(' allAppointments sample:', allAppointments.slice(0, 3));

            // Filter appointments for this week
            const weekAppointments = allAppointments.filter(apt => {
                // Handle both snake_case (from DB) and camelCase field names
                const dateString = apt.appointmentDate || apt.appointment_date;
                if (!dateString) {
                    console.log(' Skipping appointment with no date:', apt);
                    return false;
                }
                const [year, month, day] = dateString.split('-').map(Number);
                const aptDate = new Date(year, month - 1, day);
                const matches = aptDate >= weekStart && aptDate < weekEnd;
                const name = apt.customerName || apt.customer_name || apt.title || 'Unknown';
                console.log(` Appointment ${name} on ${dateString}: ${matches ? 'IN RANGE' : 'out of range'}`);
                return matches;
            });

            console.log(' weekAppointments filtered:', weekAppointments.length);

            // Group by date (handle both snake_case and camelCase)
            const appointmentsByDate = {};
            weekAppointments.forEach(apt => {
                const dateKey = apt.appointmentDate || apt.appointment_date;
                if (!appointmentsByDate[dateKey]) {
                    appointmentsByDate[dateKey] = [];
                }
                appointmentsByDate[dateKey].push(apt);
            });

            console.log(' appointmentsByDate:', Object.keys(appointmentsByDate));

            // Place each appointment
            Object.keys(appointmentsByDate).forEach(dateKey => {
                const dayColumn = document.querySelector(`.day-column[data-date="${dateKey}"]`);
                console.log(` Looking for dayColumn with date ${dateKey}:`, dayColumn ? 'found' : 'NOT FOUND');
                if (!dayColumn) return;

                appointmentsByDate[dateKey].forEach(apt => {
                    // Handle both snake_case and camelCase field names
                    const timeString = apt.appointmentTime || apt.appointment_time || '09:00:00';
                    const [hours, minutes] = timeString.split(':').map(Number);

                    // Calculate position (8am = hour 8, offset from start)
                    const startHour = 8;
                    const slotHeight = 60; // pixels per hour
                    const topOffset = (hours - startHour) * slotHeight + (minutes / 60) * slotHeight;

                    // Determine event class based on source/status/calendar
                    const source = apt.source || 'voice_booking';
                    const depositStatus = apt.depositStatus || apt.deposit_status || 'not_required';
                    const aptStatus = apt.status || 'scheduled';
                    const purpose = (apt.purpose || '').toLowerCase();
                    const notes = (apt.notes || '').toLowerCase();
                    const ghlCalendarId = apt.ghlCalendarId || apt.ghl_calendar_id || '';
                    let eventClass = 'calendar-event';

                    // Get customer name (handle both formats)
                    const customerName = apt.customerName || apt.customer_name || '';

                    // Check if it's a busy/blocked slot from GHL
                    const isBusySlot = notes.includes('busy/blocked slot') || customerName.toLowerCase() === 'busy' || customerName.toLowerCase().startsWith('busy -');

                    if (isBusySlot && (source === 'ghl_sync' || source === 'manual')) {
                        // Color-code busy slots by calendar type
                        // Calendar IDs: Hyperbaric=lqwsBWMJip0wx6NGLeaG, Cryo=mV3NGEcqoXayzHtIEE97, Recovery=yHDUtxQWt9GzaPcdUnxs
                        if (purpose.includes('hyperbaric') || ghlCalendarId === 'lqwsBWMJip0wx6NGLeaG') {
                            eventClass += ' hyperbaric-busy';
                        } else if (purpose.includes('recovery') || ghlCalendarId === 'yHDUtxQWt9GzaPcdUnxs') {
                            eventClass += ' recovery-busy';
                        } else if (purpose.includes('cryotherapy') || purpose.includes('localized') || ghlCalendarId === 'mV3NGEcqoXayzHtIEE97') {
                            eventClass += ' cryotherapy-busy';
                        } else {
                            // Default busy slot color (orange)
                            eventClass += ' hyperbaric-busy';
                        }
                    } else if (source === 'ghl_sync') {
                        eventClass += ' ghl-sync';
                    } else if (source === 'voice_booking' || source === 'rachel_voice_ai') {
                        // AI Voice Booking - RED if pending, GREEN if confirmed
                        if (aptStatus === 'confirmed') {
                            eventClass += ' voice-booking-confirmed';
                        } else {
                            eventClass += ' voice-booking-pending';
                        }
                    } else {
                        // Other appointments (online, manual, etc.) - default blue
                        eventClass += ' voice-booking';
                    }

                    // Format time for display
                    const displayHour = hours > 12 ? hours - 12 : hours;
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    const displayTime = `${displayHour}:${minutes.toString().padStart(2, '0')} ${ampm}`;

                    const name = customerName || apt.name || 'Appointment';
                    const duration = apt.duration || 60;
                    const eventHeight = Math.max(30, (duration / 60) * slotHeight - 4);

                    console.log(` Placing appointment: ${name} at ${displayTime} (top: ${topOffset}px)`);

                    const eventHtml = `
                        <div class="${eventClass}"
                             style="top: ${topOffset}px; height: ${eventHeight}px;"
                             onclick="showAppointmentDetails(${apt.id})"
                             title="${name} at ${displayTime}">
                            <div class="event-title">${name}</div>
                            <div class="event-time">${displayTime}</div>
                        </div>
                    `;

                    dayColumn.insertAdjacentHTML('beforeend', eventHtml);
                });
            });
        }

        // Current appointment being viewed in details modal
        let currentAppointmentDetails = null;

        // Show appointment details modal (for calendar grid clicks)
        function showAppointmentDetails(appointmentId) {
            console.log('Appointment details requested:', appointmentId);

            // Find the appointment in allAppointments
            const apt = allAppointments.find(a => a.id === appointmentId);
            if (!apt) {
                console.error('Appointment not found:', appointmentId);
                return;
            }

            // Store current appointment for actions
            currentAppointmentDetails = apt;

            // Extract fields (handle both camelCase and snake_case)
            const name = apt.customerName || apt.customer_name || apt.name || 'Unknown';
            const phone = apt.customerPhone || apt.customer_phone || apt.phone || '';
            const date = apt.appointmentDate || apt.appointment_date || apt.date || '';
            const rawTime = apt.appointmentTime || apt.appointment_time || apt.time || '';
            const purpose = apt.purpose || apt.notes || 'Appointment';
            const source = apt.source || 'unknown';

            // Format time for display
            let displayTime = rawTime;
            if (rawTime) {
                const [hours, minutes] = rawTime.split(':').map(Number);
                const displayHour = hours > 12 ? hours - 12 : (hours === 0 ? 12 : hours);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                displayTime = `${displayHour}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            }

            // Format date for display
            let displayDate = date;
            if (date) {
                const [year, month, day] = date.split('-');
                const dateObj = new Date(year, month - 1, day);
                displayDate = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            }

            // Get source label
            const sourceLabels = {
                'ghl_sync': 'GHL Calendar',
                'whatsapp_ghl': 'WhatsApp (GHL)',
                'voice_booking': 'AI Voice Booking',
                'whatsapp': 'WhatsApp',
                'online': 'Online Booking',
                'manual': 'Manual Entry'
            };
            const sourceLabel = sourceLabels[source] || source;

            // Populate modal
            document.getElementById('aptDetailsName').textContent = name;
            document.getElementById('aptDetailsDate').textContent = displayDate;
            document.getElementById('aptDetailsTime').textContent = displayTime;
            document.getElementById('aptDetailsPhone').textContent = phone || 'No phone';
            document.getElementById('aptDetailsPurpose').textContent = purpose;
            document.getElementById('aptDetailsSource').textContent = sourceLabel;

            // Hide phone row if no phone
            document.getElementById('aptDetailsPhoneRow').style.display = phone ? 'block' : 'none';

            // Disable text/call buttons if no phone
            document.getElementById('aptDetailsTextBtn').disabled = !phone;
            document.getElementById('aptDetailsCallBtn').disabled = !phone;
            document.getElementById('aptDetailsTextBtn').style.opacity = phone ? '1' : '0.5';
            document.getElementById('aptDetailsCallBtn').style.opacity = phone ? '1' : '0.5';

            // Handle appointment status
            const aptStatus = apt.status || 'scheduled';
            const statusRow = document.getElementById('aptDetailsStatusRow');
            const statusSpan = document.getElementById('aptDetailsStatus');
            const confirmBtn = document.getElementById('aptDetailsConfirmBtn');

            // Status labels and colors
            const statusLabels = {
                'scheduled': { label: 'Pending', color: '#ef4444' },
                'confirmed': { label: 'Confirmed', color: '#22c55e' },
                'completed': { label: 'Completed', color: '#3b82f6' },
                'cancelled': { label: 'Cancelled', color: '#6b7280' },
                'no_show': { label: 'No Show', color: '#f59e0b' }
            };
            const statusInfo = statusLabels[aptStatus] || { label: aptStatus, color: '#6b7280' };
            statusSpan.innerHTML = `<span style="color: ${statusInfo.color}; font-weight: 600;">${statusInfo.label}</span>`;

            // Show confirm button for AI voice bookings that are not yet confirmed
            const isVoiceBooking = source === 'voice_booking' || source === 'rachel_voice_ai';
            if (isVoiceBooking && aptStatus !== 'confirmed') {
                confirmBtn.style.display = 'flex';
            } else {
                confirmBtn.style.display = 'none';
            }

            // Handle deposit status (for Client 32)
            const depositStatus = apt.depositStatus || apt.deposit_status || 'not_required';
            const depositRow = document.getElementById('aptDetailsDepositRow');
            const depositStatusSpan = document.getElementById('aptDetailsDepositStatus');
            const depositBtn = document.getElementById('aptDetailsDepositBtn');

            // Show deposit info only for Client 32
            if (CLIENT_ID === 32) {
                depositRow.style.display = 'block';
                if (depositStatus === 'pending') {
                    depositStatusSpan.innerHTML = '<span style="color: #f59e0b; font-weight: 600;">Pending</span>';
                    depositBtn.style.display = 'flex';
                } else if (depositStatus === 'confirmed') {
                    depositStatusSpan.innerHTML = '<span style="color: #10b981; font-weight: 600;">Confirmed</span>';
                    depositBtn.style.display = 'none';
                } else {
                    depositStatusSpan.innerHTML = '<span style="color: #6b7280;">Not Required</span>';
                    depositBtn.style.display = 'none';
                }
            } else {
                depositRow.style.display = 'none';
                depositBtn.style.display = 'none';
            }

            // Show modal
            document.getElementById('appointmentDetailsModal').classList.add('active');
        }

        // Close appointment details modal
        function closeAppointmentDetailsModal() {
            document.getElementById('appointmentDetailsModal').classList.remove('active');
            currentAppointmentDetails = null;
        }

        // Handle appointment details actions
        function aptDetailsAction(action) {
            if (!currentAppointmentDetails) return;

            const apt = currentAppointmentDetails;
            const name = apt.customerName || apt.customer_name || apt.name || 'Unknown';
            const phone = apt.customerPhone || apt.customer_phone || apt.phone || '';

            switch (action) {
                case 'text':
                    if (phone) {
                        sendSMS(phone, name);
                        closeAppointmentDetailsModal();
                    }
                    break;
                case 'call':
                    if (phone) {
                        makeCall(phone, name);
                        closeAppointmentDetailsModal();
                    }
                    break;
                case 'delete':
                    closeAppointmentDetailsModal();
                    deleteAppointment(apt.id, name);
                    break;
                case 'deposit':
                    // Open deposit confirmation modal
                    const date = apt.appointmentDate || apt.appointment_date || apt.date || '';
                    const rawTime = apt.appointmentTime || apt.appointment_time || apt.time || '';
                    const time = rawTime ? rawTime.substring(0, 5) : '';
                    closeAppointmentDetailsModal();
                    openDepositModal(apt.id, name, date, time);
                    break;
                case 'confirm':
                    // Confirm the appointment
                    confirmAppointment(apt.id, name);
                    break;
            }
        }

        // Confirm appointment (change status to confirmed)
        async function confirmAppointment(appointmentId, customerName) {
            try {
                const confirmBtn = document.getElementById('aptDetailsConfirmBtn');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<svg class="animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" opacity="0.25"></circle><path d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-width="4" stroke-linecap="round"></path></svg> Confirming...';

                const response = await fetch(`/api/appointments/${appointmentId}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ status: 'confirmed' })
                });

                const data = await response.json();

                if (data.success) {
                    // Update local appointment data
                    const apt = allAppointments.find(a => a.id === appointmentId);
                    if (apt) {
                        apt.status = 'confirmed';
                    }

                    // Close modal and refresh calendar
                    closeAppointmentDetailsModal();
                    showToast(`Appointment for ${customerName} confirmed!`, 'success');

                    // Refresh the calendar view
                    if (typeof loadAppointments === 'function') {
                        loadAppointments();
                    }
                } else {
                    throw new Error(data.error || 'Failed to confirm appointment');
                }
            } catch (error) {
                console.error('Error confirming appointment:', error);
                showToast('Failed to confirm appointment: ' + error.message, 'error');

                // Reset button
                const confirmBtn = document.getElementById('aptDetailsConfirmBtn');
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Confirm Appointment';
            }
        }

        // Render Appointments (kept for backward compatibility)
        function renderAppointments(appointments) {
            // Store all appointments (for any legacy code that might need it)
            allAppointments = appointments || [];
        }

        // Render filtered appointments
        function renderFilteredAppointments(appointments) {
            const container = document.getElementById('appointmentsList');

            if (!appointments || appointments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <p>No appointments scheduled in the next ${currentDaysFilter} days</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = appointments.map(apt => {
                // Map API fields to display fields (handle both camelCase and snake_case)
                const name = apt.customerName || apt.customer_name || apt.name || 'Unknown';
                const phone = apt.customerPhone || apt.customer_phone || apt.phone || '';
                const date = apt.appointmentDate || apt.appointment_date || apt.date || '';
                const rawTime = apt.appointmentTime || apt.appointment_time || apt.time || '';
                const time = rawTime ? rawTime.substring(0, 5) : ''; // HH:MM from HH:MM:SS
                const notes = apt.purpose || apt.notes || 'No notes';
                const status = apt.status || 'confirmed';
                const source = apt.source || 'voice_booking';
                const ghlAppointmentId = apt.ghlAppointmentId || apt.ghl_appointment_id;
                const hubspotMeetingId = apt.hubspotMeetingId || apt.hubspot_meeting_id;
                const vagaroAppointmentId = apt.vagaroAppointmentId || apt.vagaro_appointment_id;
                const depositStatus = apt.depositStatus || apt.deposit_status || 'not_required';
                const aptId = apt.id;

                // Get deposit badge if applicable
                const getDepositBadge = () => {
                    if (depositStatus === 'pending') {
                        return `<span class="deposit-badge deposit-pending" onclick="openDepositModal(${aptId}, '${name.replace(/'/g, "\\'")}', '${date}', '${time}')" title="Click to confirm deposit">Pending Deposit</span>`;
                    } else if (depositStatus === 'confirmed') {
                        return '<span class="deposit-badge deposit-confirmed">Deposit Confirmed</span>';
                    }
                    return '';
                };

                // Determine source tag based on appointment source or CRM-specific IDs
                const getSourceTag = () => {
                    // Use sourceBadge if available from API (new dashboard endpoint)
                    if (apt.sourceBadge) {
                        const badge = apt.sourceBadge;
                        return `<span style="background: ${badge.bgColor}; color: ${badge.color}; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">${badge.label}</span>`;
                    }

                    // GHL sources (green)
                    if (source === 'ghl_sync' || source === 'whatsapp_ghl' || ghlAppointmentId) {
                        return '<span style="background: #d1fae5; color: #10b981; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">GHL</span>';
                    }
                    // HubSpot sources (orange)
                    if (source === 'hubspot_sync' || source === 'whatsapp_hubspot' || hubspotMeetingId) {
                        return '<span style="background: #ffe8e2; color: #ff7a59; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">HubSpot</span>';
                    }
                    // Vagaro sources (purple)
                    if (source === 'vagaro_sync' || source === 'whatsapp_vagaro' || vagaroAppointmentId) {
                        return '<span style="background: #ede9fe; color: #8b5cf6; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">Vagaro</span>';
                    }
                    // WhatsApp (green)
                    if (source === 'whatsapp') {
                        return '<span style="background: #dcfce7; color: #25D366; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">WhatsApp</span>';
                    }
                    // Voice booking (blue)
                    if (source === 'voice_booking') {
                        return '<span style="background: #dbeafe; color: #3b82f6; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">Voice</span>';
                    }
                    // Online booking (cyan)
                    if (source === 'online') {
                        return '<span style="background: #e0f2fe; color: #0ea5e9; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">Online</span>';
                    }
                    // Manual entry (gray)
                    if (source === 'manual') {
                        return '<span style="background: #f3f4f6; color: #6b7280; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">Manual</span>';
                    }
                    // Walk-in (amber)
                    if (source === 'walk-in') {
                        return '<span style="background: #fef3c7; color: #f59e0b; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; margin-left: 0.5rem;">Walk-in</span>';
                    }
                    return '';
                };

                // Determine if appointment needs confirmation (not yet confirmed by client)
                // Only show Confirm button if not yet confirmed - hide completely once confirmed
                const needsConfirmation = status !== 'confirmed';
                const confirmButtonHtml = needsConfirmation
                    ? `<button class="btn-confirm-apt" onclick="confirmAppointment(${aptId}, '${name.replace(/'/g, "\\'")}')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Confirm
                        </button>`
                    : ''; // Don't show any button once confirmed

                // Delete button - always available
                const deleteButtonHtml = `<button class="btn-delete-apt" onclick="deleteAppointment(${aptId}, '${name.replace(/'/g, "\\'")}')">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Delete
                    </button>`;

                return `
                <div class="appointment-card" id="appointment-card-${aptId}">
                    <div class="appointment-main">
                        <div class="appointment-info">
                            <h3>
                                ${name}
                                ${getSourceTag()}
                            </h3>
                            <p style="font-weight: 600; color: #3b82f6; font-size: 0.875rem;">${date} at ${time}</p>
                            <p>${notes}</p>
                            <p style="font-size: 0.75rem;">${phone}</p>
                        </div>
                        <div class="appointment-time">
                            ${getDepositBadge()}
                        </div>
                    </div>
                    <div class="appointment-actions">
                        <button class="btn-text" onclick="sendSMS('${phone}', '${name.replace(/'/g, "\\'")}')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                            </svg>
                            Text
                        </button>
                        <button class="btn-call-apt" onclick="makeCall('${phone}', '${name.replace(/'/g, "\\'")}')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            Call
                        </button>
                        ${confirmButtonHtml}
                        ${deleteButtonHtml}
                    </div>
                </div>
                `;
            }).join('');
        }

        // Render Communications (DEPRECATED - section removed)
        function renderCommunications(communications) {
            const container = document.getElementById('communicationsList');

            // Container doesn't exist anymore (section was deprecated)
            if (!container) {
                console.log('Communications section deprecated - skipping render');
                return;
            }

            if (!communications || communications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        <p>No recent communications</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = communications.map(comm => `
                <div class="comm-card">
                    <div class="comm-card-content">
                        <div class="comm-icon ${comm.type}">
                            ${comm.type === 'sms' ?
                                '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>' :
                                '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>'
                            }
                        </div>
                        <div class="comm-info">
                            <div class="comm-header">
                                <h4>${comm.contact}</h4>
                                <span class="time">${comm.time}</span>
                            </div>
                            <p>${comm.type === 'sms' ? `"${comm.message}"` : `Call duration: ${comm.duration}`}</p>
                            <span class="comm-badge ${comm.direction}">${comm.direction === 'inbound' ? 'Received' : 'Sent'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Load Messages
        async function loadMessages() {
            try {
                const response = await authenticatedFetch(`/api/messages/client/${CLIENT_ID}?limit=20`);
                if (!response) return;

                const messages = await response.json();
                renderMessages(messages);
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesList').innerHTML = '<div class="empty-state"><p>Error loading messages</p></div>';
            }
        }

        // Render Messages (filtered to yesterday, today, tomorrow only)
        function renderMessages(messages) {
            const container = document.getElementById('messagesList');

            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        <p>No voicemail messages yet</p>
                    </div>
                `;
                updateMessagesBadge(0);
                return;
            }

            // Filter messages: only show yesterday, today, and tomorrow
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 2); // End of tomorrow

            const filteredMessages = messages.filter(msg => {
                const createdDate = new Date(msg.createdAt || msg.created_at);
                return createdDate >= yesterday && createdDate < tomorrow;
            });

            if (filteredMessages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        <p>No messages from yesterday, today, or tomorrow</p>
                    </div>
                `;
                updateMessagesBadge(0);
                return;
            }

            container.innerHTML = filteredMessages.map((msg, index) => {
                const createdDate = new Date(msg.createdAt || msg.created_at);
                const timeAgo = getTimeAgo(createdDate);
                const preview = msg.body.length > 100 ? msg.body.substring(0, 100) + '...' : msg.body;
                const isUnread = !msg.read;
                const unreadIndicator = isUnread ? '<span style="display: inline-block; width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 8px;"></span>' : '';

                // Extract recording SID from Twilio URL and use proxy endpoint
                let recordingProxyUrl = null;
                if (msg.recordingUrl || msg.recording_url) {
                    const twilioUrl = msg.recordingUrl || msg.recording_url;
                    const recordingSidMatch = twilioUrl.match(/RE[a-f0-9]{32}/i);
                    if (recordingSidMatch) {
                        recordingProxyUrl = '/api/messages/recording/' + recordingSidMatch[0];
                    }
                }

                // Format call duration
                const callDuration = msg.callDuration || msg.call_duration;
                let durationDisplay = '';
                if (callDuration) {
                    const mins = Math.floor(callDuration / 60);
                    const secs = callDuration % 60;
                    durationDisplay = mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : `0:${secs.toString().padStart(2, '0')}`;
                }

                // Format call time for display
                const callTime = createdDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                const callDate = createdDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                // Check if it's a voicemail
                const isVoicemail = (msg.messageType || msg.message_type) === 'voicemail' || recordingProxyUrl;
                const typeIcon = isVoicemail ? '' : '';
                const typeLabel = isVoicemail ? 'Voicemail' : 'Message';

                return `
                    <div class="message-card ${isUnread ? 'unread' : ''}" id="message-${index}" data-message-id="${msg.id}">
                        <div class="message-header" onclick="toggleMessage(${index}, ${msg.id}, ${isUnread})">
                            <div class="message-info">
                                <h3>${unreadIndicator}${typeIcon} ${msg.fromNumber || msg.from_number || 'Unknown'}</h3>
                                <p style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                    <span>${callDate} at ${callTime}</span>
                                    ${durationDisplay ? `<span style="background: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 500;">Duration: ${durationDisplay}</span>` : ''}
                                    ${isVoicemail ? `<span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 500;">${typeLabel}</span>` : ''}
                                </p>
                                <div class="message-preview">${preview}</div>
                            </div>
                            <svg class="message-toggle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </div>
                        <div class="message-body">
                            <div class="message-content">
                                ${msg.body}
                                ${recordingProxyUrl ? `
                                    <div style="margin-top: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" style="color: #3b82f6;">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/>
                                            </svg>
                                            <strong style="color: #1f2937;">Voicemail Recording${durationDisplay ? ` (${durationDisplay})` : ''}</strong>
                                        </div>
                                        <audio controls style="width: 100%; max-width: 400px;">
                                            <source src="${recordingProxyUrl}" type="audio/mpeg">
                                            Your browser does not support audio playback.
                                        </audio>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="message-actions">
                                <button class="btn-reply-sms" onclick="sendSMS('${msg.fromNumber || msg.from_number}', 'Caller')">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                    Reply
                                </button>
                                <button class="btn-call-back" onclick="makeCall('${msg.fromNumber || msg.from_number}', 'Caller')">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                    Call Back
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update badge counter - count only unread messages
            const unreadCount = filteredMessages.filter(msg => !msg.read).length;
            updateMessagesBadge(unreadCount);
        }

        // Toggle message expand/collapse
        async function toggleMessage(index, messageId, isUnread) {
            const messageCard = document.getElementById(`message-${index}`);
            const wasExpanded = messageCard.classList.contains('expanded');

            messageCard.classList.toggle('expanded');

            // Mark as read when expanding an unread message
            if (!wasExpanded && isUnread) {
                try {
                    const response = await authenticatedFetch(`/api/messages/${messageId}/mark-read`, {
                        method: 'PATCH'
                    });

                    if (response && response.ok) {
                        console.log(` Message ${messageId} marked as read`);

                        // Remove unread indicator
                        messageCard.classList.remove('unread');
                        const unreadDot = messageCard.querySelector('h3 span');
                        if (unreadDot) unreadDot.remove();

                        // Update badge counter (decrement by 1)
                        const badge = document.getElementById('messagesBadge');
                        if (badge && badge.textContent) {
                            const currentCount = parseInt(badge.textContent);
                            updateMessagesBadge(Math.max(0, currentCount - 1));
                        }
                    }
                } catch (error) {
                    console.error('Error marking message as read:', error);
                }
            }
        }

        // Update messages badge counter
        function updateMessagesBadge(count) {
            const badge = document.getElementById('messagesBadge');
            if (!badge) return;

            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';

                // Update favicon title
                document.title = `(${count}) RinglyPro CRM`;
            } else {
                badge.style.display = 'none';
                document.title = 'RinglyPro CRM';
            }
        }

        // Reply function is now using sendSMS() which opens device SMS app

        // Get time ago helper
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;

            return date.toLocaleDateString();
        }

        // Manual refresh messages
        async function refreshMessages() {
            const btn = document.getElementById('refreshMessagesBtn');
            const btnText = document.getElementById('refreshBtnText');

            // Visual feedback
            btn.classList.add('refreshing');
            btn.disabled = true;
            btnText.textContent = 'Refreshing...';

            try {
                await loadMessages();

                // Success feedback
                btnText.textContent = 'Updated!';
                setTimeout(() => {
                    btnText.textContent = 'Refresh';
                }, 2000);
            } catch (error) {
                console.error('Error refreshing messages:', error);
                btnText.textContent = 'Error';
                setTimeout(() => {
                    btnText.textContent = 'Refresh';
                }, 2000);
            } finally {
                btn.classList.remove('refreshing');
                btn.disabled = false;
            }
        }

        // Auto-refresh messages every 60 seconds
        let messagesAutoRefreshInterval;

        function startMessagesAutoRefresh() {
            // Clear any existing interval
            if (messagesAutoRefreshInterval) {
                clearInterval(messagesAutoRefreshInterval);
            }

            // Refresh every 60 seconds (1 minute)
            messagesAutoRefreshInterval = setInterval(async () => {
                console.log(' Auto-refreshing messages...');
                try {
                    await loadMessages();
                    console.log(' Messages auto-refreshed');
                } catch (error) {
                    console.error(' Auto-refresh failed:', error);
                }
            }, 60000); // 60 seconds

            console.log(' Messages auto-refresh enabled (every 60 seconds)');
        }

        function stopMessagesAutoRefresh() {
            if (messagesAutoRefreshInterval) {
                clearInterval(messagesAutoRefreshInterval);
                console.log(' Messages auto-refresh stopped');
            }
        }

        // SMS compose form removed - Reply button now uses device SMS app (sendSMS function)

        // ============= CONVERSATIONS (GHL SYNC) =============
        let currentMessagesView = 'voicemails';
        let currentConversationContact = null;

        // Switch between voicemails and conversations view
        function switchMessagesView(view) {
            currentMessagesView = view;

            const voicemailsBtn = document.getElementById('voicemailsViewBtn');
            const conversationsBtn = document.getElementById('conversationsViewBtn');
            const messagesList = document.getElementById('messagesList');
            const conversationsList = document.getElementById('conversationsList');

            if (view === 'voicemails') {
                voicemailsBtn.style.background = '#3b82f6';
                voicemailsBtn.style.color = 'white';
                conversationsBtn.style.background = 'transparent';
                conversationsBtn.style.color = '#6b7280';
                messagesList.style.display = 'block';
                conversationsList.style.display = 'none';
            } else {
                voicemailsBtn.style.background = 'transparent';
                voicemailsBtn.style.color = '#6b7280';
                conversationsBtn.style.background = '#3b82f6';
                conversationsBtn.style.color = 'white';
                messagesList.style.display = 'none';
                conversationsList.style.display = 'block';
                loadConversationsList();
            }
        }

        // Load conversations list
        async function loadConversationsList() {
            const container = document.getElementById('conversationsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading conversations...</p></div>';

            try {
                const response = await authenticatedFetch(`/api/mobile/conversations-list/${CLIENT_ID}?limit=30`);
                if (!response) return;

                const data = await response.json();
                if (!data.success || !data.conversations || data.conversations.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                            <p>No conversations yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.conversations.map(conv => {
                    const contactName = `${conv.contact.firstName || ''} ${conv.contact.lastName || ''}`.trim() || conv.contact.phone || 'Unknown';
                    const lastMsgPreview = conv.lastMessage.body ? (conv.lastMessage.body.length > 60 ? conv.lastMessage.body.substring(0, 60) + '...' : conv.lastMessage.body) : '';
                    const timeAgo = getTimeAgo(new Date(conv.lastMessage.createdAt));
                    const isUnread = conv.unreadCount > 0;
                    const ghlSynced = !!conv.contact.ghlContactId;

                    // Source badge
                    const sourceBadge = conv.lastMessage.messageSource === 'ghl'
                        ? '<span style="background: #3b82f6; color: white; padding: 0.1rem 0.3rem; border-radius: 0.2rem; font-size: 0.65rem; margin-left: 0.25rem;">GHL</span>'
                        : conv.lastMessage.messageSource === 'twilio'
                        ? '<span style="background: #ef4444; color: white; padding: 0.1rem 0.3rem; border-radius: 0.2rem; font-size: 0.65rem; margin-left: 0.25rem;">SMS</span>'
                        : '';

                    // Message type icon
                    const typeIcon = conv.lastMessage.messageType === 'voicemail' ? ''
                        : conv.lastMessage.messageType === 'call' ? ''
                        : conv.lastMessage.messageType === 'email' ? ''
                        : conv.lastMessage.messageType === 'whatsapp' ? ''
                        : '';

                    return `
                        <div class="conversation-card ${isUnread ? 'unread' : ''}" onclick="openConversation(${conv.contact.id}, '${contactName.replace(/'/g, "\\'")}', '${conv.contact.phone || ''}', ${ghlSynced})" style="padding: 1rem; border-bottom: 1px solid #e5e7eb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: ${isUnread ? '#eff6ff' : 'white'}; transition: background 0.2s;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    ${isUnread ? '<span style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%;"></span>' : ''}
                                    <strong style="color: #1f2937;">${contactName}</strong>
                                    ${ghlSynced ? '<span style="background: #10b981; color: white; padding: 0.1rem 0.3rem; border-radius: 0.2rem; font-size: 0.65rem;">GHL</span>' : ''}
                                </div>
                                <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">
                                    ${typeIcon} ${lastMsgPreview} ${sourceBadge}
                                </div>
                            </div>
                            <div style="text-align: right; font-size: 0.75rem; color: #9ca3af;">
                                <div>${timeAgo}</div>
                                ${conv.unreadCount > 0 ? `<span style="background: #3b82f6; color: white; padding: 0.2rem 0.5rem; border-radius: 9999px; font-size: 0.7rem;">${conv.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading conversations:', error);
                container.innerHTML = '<div class="empty-state"><p>Error loading conversations</p></div>';
            }
        }

        // Open conversation detail
        async function openConversation(contactId, contactName, contactPhone, ghlSynced) {
            currentConversationContact = { id: contactId, name: contactName, phone: contactPhone, ghlSynced };

            document.getElementById('conversationContactName').textContent = contactName;
            document.getElementById('conversationContactPhone').textContent = contactPhone;
            document.getElementById('ghlSyncIndicator').style.display = ghlSynced ? 'inline-block' : 'none';
            document.getElementById('conversationModal').style.display = 'flex';

            // Load conversation messages
            await loadConversationMessages(contactId);

            // Mark as read
            try {
                await authenticatedFetch(`/api/mobile/conversations/${contactId}/mark-read/${CLIENT_ID}`, { method: 'POST' });
            } catch (e) {
                console.error('Error marking conversation as read:', e);
            }
        }

        // Load messages for a conversation
        async function loadConversationMessages(contactId) {
            const container = document.getElementById('conversationMessages');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';

            try {
                const response = await authenticatedFetch(`/api/mobile/conversations/${contactId}/${CLIENT_ID}?limit=50`);
                if (!response) return;

                const data = await response.json();
                if (!data.success || !data.messages || data.messages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280;">No messages in this conversation</p>';
                    return;
                }

                // Sort messages oldest first for chat display
                const sortedMessages = [...data.messages].reverse();

                container.innerHTML = sortedMessages.map(msg => {
                    const isOutgoing = msg.direction === 'outgoing';
                    const timeStr = new Date(msg.createdAt).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, month: 'short', day: 'numeric' });

                    // Source indicator
                    const sourceIndicator = msg.ghlSynced
                        ? '<span style="font-size: 0.65rem; color: #10b981; margin-left: 0.25rem;">GHL</span>'
                        : '';

                    return `
                        <div style="display: flex; flex-direction: column; align-items: ${isOutgoing ? 'flex-end' : 'flex-start'};">
                            <div style="max-width: 80%; padding: 0.75rem 1rem; border-radius: ${isOutgoing ? '1rem 1rem 0.25rem 1rem' : '1rem 1rem 1rem 0.25rem'}; background: ${isOutgoing ? '#3b82f6' : '#f3f4f6'}; color: ${isOutgoing ? 'white' : '#1f2937'};">
                                ${msg.body}
                            </div>
                            <div style="font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem;">
                                ${timeStr} ${sourceIndicator}
                            </div>
                        </div>
                    `;
                }).join('');

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;

            } catch (error) {
                console.error('Error loading conversation messages:', error);
                container.innerHTML = '<p style="text-align: center; color: #ef4444;">Error loading messages</p>';
            }
        }

        // Close conversation modal
        function closeConversationModal() {
            document.getElementById('conversationModal').style.display = 'none';
            currentConversationContact = null;
            // Refresh conversations list to update read status
            if (currentMessagesView === 'conversations') {
                loadConversationsList();
            }
        }

        // Sync conversation with GHL
        async function syncConversationWithGHL() {
            if (!currentConversationContact) return;

            const btn = document.getElementById('syncGHLBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>Syncing...</span>';

            try {
                const response = await authenticatedFetch(`/api/mobile/conversations/${currentConversationContact.id}/sync/${CLIENT_ID}`, {
                    method: 'POST'
                });

                if (!response) {
                    throw new Error('No response');
                }

                const data = await response.json();

                if (data.success) {
                    // Show success
                    btn.innerHTML = '<span style="color: #10b981;">Synced!</span>';
                    document.getElementById('ghlSyncIndicator').style.display = 'inline-block';

                    // Reload messages
                    await loadConversationMessages(currentConversationContact.id);

                    setTimeout(() => {
                        btn.innerHTML = `
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                            Sync GHL
                        `;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Sync failed');
                }

            } catch (error) {
                console.error('Error syncing with GHL:', error);
                btn.innerHTML = '<span style="color: #ef4444;">Error</span>';
                setTimeout(() => {
                    btn.innerHTML = `
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Sync GHL
                    `;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Send reply in conversation
        async function sendConversationReply() {
            if (!currentConversationContact) return;

            const input = document.getElementById('conversationReplyInput');
            const message = input.value.trim();
            if (!message) return;

            // Clear input
            input.value = '';

            try {
                // Send via existing SMS endpoint
                const response = await authenticatedFetch(`/api/mobile/send-sms/${CLIENT_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: currentConversationContact.phone,
                        body: message
                    })
                });

                if (response && response.ok) {
                    // Reload messages to show the new one
                    await loadConversationMessages(currentConversationContact.id);
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending reply:', error);
                alert('Error sending message');
            }
        }

        // Handle enter key in reply input
        document.addEventListener('DOMContentLoaded', () => {
            const replyInput = document.getElementById('conversationReplyInput');
            if (replyInput) {
                replyInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendConversationReply();
                    }
                });
            }
        });

        // Tab Switching
        function setupTabSwitching() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

                    tab.classList.add('active');
                    const tabName = tab.dataset.tab;
                    document.getElementById(`${tabName}Section`).classList.add('active');

                    // Load user guide when tab is clicked
                    if (tabName === 'userguide') {
                        loadUserGuide();
                    }
                });
            });
        }

        // Load and render user guide
        let userGuideLoaded = false;
        async function loadUserGuide() {
            if (userGuideLoaded) return; // Only load once

            const container = document.getElementById('userGuideContent');

            try {
                const response = await fetch('/USER_GUIDE.md');
                if (!response.ok) throw new Error('Failed to load user guide');

                const markdown = await response.text();

                // Convert markdown to HTML (basic implementation)
                let html = markdown
                    // Headers
                    .replace(/^### (.*$)/gim, '<h3 id="$1">$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2 id="$1">$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1 id="$1">$1</h1>')
                    // Bold
                    .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                    // Italic
                    .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                    // Code blocks
                    .replace(/```(.*?)```/gims, '<pre><code>$1</code></pre>')
                    // Inline code
                    .replace(/`([^`]+)`/gim, '<code>$1</code>')
                    // Links
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" target="_blank">$1</a>')
                    // Blockquotes
                    .replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>')
                    // Horizontal rules
                    .replace(/^---$/gim, '<hr>')
                    // Line breaks
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');

                // Wrap in paragraphs
                html = '<div style="line-height: 1.6; color: #333;">' +
                       '<style>' +
                       '#userGuideContent h1 { font-size: 2rem; margin-top: 2rem; margin-bottom: 1rem; color: #1a202c; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }' +
                       '#userGuideContent h2 { font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #2d3748; }' +
                       '#userGuideContent h3 { font-size: 1.25rem; margin-top: 1rem; margin-bottom: 0.5rem; color: #4a5568; }' +
                       '#userGuideContent code { background: #f7fafc; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-family: monospace; color: #d53f8c; }' +
                       '#userGuideContent pre { background: #2d3748; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }' +
                       '#userGuideContent pre code { background: transparent; color: inherit; padding: 0; }' +
                       '#userGuideContent blockquote { border-left: 4px solid #4299e1; padding-left: 1rem; margin: 1rem 0; color: #4a5568; background: #ebf8ff; padding: 0.75rem 1rem; border-radius: 0.25rem; }' +
                       '#userGuideContent a { color: #4299e1; text-decoration: none; }' +
                       '#userGuideContent a:hover { text-decoration: underline; }' +
                       '#userGuideContent hr { border: none; border-top: 2px solid #e2e8f0; margin: 2rem 0; }' +
                       '#userGuideContent ul, #userGuideContent ol { margin-left: 1.5rem; margin-bottom: 1rem; }' +
                       '#userGuideContent li { margin-bottom: 0.5rem; }' +
                       '</style>' +
                       '<p>' + html + '</p>' +
                       '</div>';

                container.innerHTML = html;
                userGuideLoaded = true;

                console.log(' User guide loaded');

            } catch (error) {
                console.error(' Error loading user guide:', error);
                container.innerHTML = '<p style="color: #e53e3e; text-align: center; padding: 2rem;">Failed to load user guide. Please try refreshing the page.</p>';
            }
        }

        // Scroll to English section
        function scrollToEnglish() {
            const englishHeader = document.querySelector('#userGuideContent h1');
            if (englishHeader) {
                englishHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Scroll to Spanish section
        function scrollToSpanish() {
            const allH1s = document.querySelectorAll('#userGuideContent h1');
            if (allH1s.length > 1) {
                allH1s[1].scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Contact Search
        function openContactSearch(action) {
            currentAction = action;
            const modal = document.getElementById('contactModal');
            const title = document.getElementById('modalTitle');
            
            title.textContent = action === 'sms' ? 'Send Message To' : 'Call Contact';
            modal.classList.add('active');
            
            if (dashboardData && dashboardData.appointments) {
                renderContactList(dashboardData.appointments);
            }
            
            setTimeout(() => document.getElementById('contactSearch').focus(), 100);
        }

        function closeContactSearch() {
            document.getElementById('contactModal').classList.remove('active');
            document.getElementById('contactSearch').value = '';
        }

        function renderContactList(contacts) {
            const container = document.getElementById('contactResults');
            const html = '<p style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Recent Contacts</p>' +
                contacts.map(contact => `
                    <div class="contact-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer;">
                        <div style="display: flex; align-items: center; flex: 1;" onclick="selectContact('${contact.phone}', '${contact.name}')">
                            <div class="contact-avatar">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                            <div class="contact-details">
                                <h4>${contact.name}</h4>
                                <p>${contact.phone}</p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; margin-left: 12px;">
                            <button onclick="event.stopPropagation(); makeCall('${contact.phone}', '${contact.name}');" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                 Call
                            </button>
                            <button onclick="event.stopPropagation(); sendSMS('${contact.phone}', '${contact.name}');" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                 SMS
                            </button>
                        </div>
                    </div>
                `).join('');

            container.innerHTML = html;
        }

        async function searchContacts() {
            const query = document.getElementById('contactSearch').value;
            
            if (query.length < 2) {
                if (dashboardData && dashboardData.appointments) {
                    renderContactList(dashboardData.appointments);
                }
                return;
            }

            try {
                const response = await authenticatedFetch(`/api/mobile/contacts/smart-search/${CLIENT_ID}?q=${encodeURIComponent(query)}`);
                if (!response) return;
                
                const data = await response.json();
                
                if (data.success && data.contacts.length > 0) {
                    const container = document.getElementById('contactResults');
                    container.innerHTML = '<p style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Search Results</p>' +
                        data.contacts.map(contact => `
                            <div class="contact-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer;">
                                <div style="display: flex; align-items: center; flex: 1;" onclick="selectContact('${contact.phone}', '${contact.name}')">
                                    <div class="contact-avatar">
                                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    </div>
                                    <div class="contact-details">
                                        <h4>${contact.name}</h4>
                                        <p>${contact.display_details}</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; margin-left: 12px;">
                                    <button onclick="event.stopPropagation(); makeCall('${contact.phone}', '${contact.name}');" style="padding: 8px 12px; background: #10b981; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                         Call
                                    </button>
                                    <button onclick="event.stopPropagation(); sendSMS('${contact.phone}', '${contact.name}');" style="padding: 8px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                         SMS
                                    </button>
                                </div>
                            </div>
                        `).join('');
                }
            } catch (error) {
                console.error('Error searching contacts:', error);
            }
        }

        function selectContact(phone, name) {
            closeContactSearch();
            if (currentAction === 'sms') {
                sendSMS(phone, name);
            } else if (currentAction === 'call') {
                makeCall(phone, name);
            }
        }

        function sendSMS(phone, name) {
            // Open device SMS app with phone number pre-filled
            // Format: sms:+1234567890 (iOS/Android)
            const cleanPhone = phone.replace(/\D/g, ''); // Remove non-digits
            const formattedPhone = cleanPhone.startsWith('1') ? `+${cleanPhone}` : `+1${cleanPhone}`;

            // Check if running in iOS native app with bridge
            if (window.nativeApp && window.nativeApp.sendSMS) {
                // iOS app: use native bridge
                window.nativeApp.sendSMS(formattedPhone);
            } else {
                // Mobile browser: use standard sms: link
                const link = document.createElement('a');
                link.href = `sms:${formattedPhone}`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function makeCall(phone, name) {
            // Check if running in iOS native app with bridge
            if (window.nativeApp && window.nativeApp.makeCall) {
                // iOS app: use native bridge
                window.nativeApp.makeCall(phone);
            } else {
                // Mobile browser: use standard tel: link
                const link = document.createElement('a');
                link.href = `tel:${phone}`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Confirm an appointment (update status to confirmed)
        async function confirmAppointment(appointmentId, customerName) {
            if (!confirm(`Confirm appointment for ${customerName}?`)) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Please log in again');
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch(`/api/appointments/${appointmentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'confirmed'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Hide the confirm button after successful confirmation
                    const card = document.getElementById(`appointment-card-${appointmentId}`);
                    if (card) {
                        const confirmBtn = card.querySelector('.btn-confirm-apt');
                        if (confirmBtn) {
                            confirmBtn.remove(); // Remove the button completely
                        }
                    }
                    // Show success message
                    alert(`Appointment for ${customerName} has been confirmed!`);
                } else {
                    alert('Error confirming appointment: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error confirming appointment:', error);
                alert('Error confirming appointment. Please try again.');
            }
        }

        // Delete an appointment (cancel it)
        async function deleteAppointment(appointmentId, customerName) {
            if (!confirm(`Are you sure you want to delete the appointment for ${customerName}? This action cannot be undone.`)) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Please log in again');
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch(`/api/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Remove the appointment card from the DOM
                    const card = document.getElementById(`appointment-card-${appointmentId}`);
                    if (card) {
                        card.style.transition = 'opacity 0.3s, transform 0.3s';
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(-20px)';
                        setTimeout(() => card.remove(), 300);
                    }
                    // Show success message
                    alert(`Appointment for ${customerName} has been deleted.`);
                } else {
                    alert('Error deleting appointment: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting appointment:', error);
                alert('Error deleting appointment. Please try again.');
            }
        }

        // Open MCP Copilot with auto-loaded credentials
        function openMCPCopilot() {
            const mcpUrl = `${window.location.origin}/mcp-copilot/?client_id=${CLIENT_ID}`;
            // Use location.href for WebView compatibility (window.open doesn't work well in iOS WebViews)
            window.location.href = mcpUrl;
        }

        // =====================================================
        // SETTINGS MODAL FUNCTIONS (Integrations)
        // =====================================================

        let crmSettingsData = null;

        // Main Settings Modal Functions
        async function openSettings() {
            document.getElementById('calendarModal').classList.add('active');
            await loadCRMSettings();
        }

        function closeSettings() {
            document.getElementById('calendarModal').classList.remove('active');
        }

        // Legacy function names for backwards compatibility
        function openCalendarSettings() {
            openSettings();
        }

        function closeCalendarSettings() {
            closeSettings();
        }

        // Attach form submit handler
        document.addEventListener('DOMContentLoaded', () => {
            // CRM Settings form submit handler
            const crmForm = document.getElementById('crmSettingsForm');
            if (crmForm) {
                crmForm.addEventListener('submit', saveCRMSettings);
            }

            // Voicemail message character counter
            const voicemailTextarea = document.getElementById('outboundVoicemailMessage');
            if (voicemailTextarea) {
                voicemailTextarea.addEventListener('input', updateVoicemailCharCount);
            }
        });

        // =====================================================
        // CRM INTEGRATION SETTINGS FUNCTIONS
        // =====================================================

        // Update voicemail message character count
        function updateVoicemailCharCount() {
            const textarea = document.getElementById('outboundVoicemailMessage');
            const charCount = document.getElementById('voicemailCharCount');
            if (textarea && charCount) {
                const length = textarea.value.length;
                charCount.textContent = `${length} / 1000`;

                // Color code based on length
                if (length > 900) {
                    charCount.style.color = '#dc2626'; // Red
                } else if (length > 700) {
                    charCount.style.color = '#f59e0b'; // Orange
                } else {
                    charCount.style.color = '#6b7280'; // Gray
                }
            }
        }

        async function loadCRMSettings() {
            try {
                const response = await authenticatedFetch(`/api/client/crm-settings/${CLIENT_ID}`);
                if (!response) return;

                const data = await response.json();

                if (data.success) {
                    crmSettingsData = data.settings;
                    renderCRMSettings(data.settings);
                }
            } catch (error) {
                console.error('Error loading CRM settings:', error);
                alert('Failed to load CRM settings. Please try again.');
            }
        }

        function renderCRMSettings(settings) {
            // Note: GHL and SendGrid settings are now in separate settings pages
            // This function only handles the voicemail message now

            // Outbound voicemail message
            if (settings.outbound_voicemail_message) {
                const textarea = document.getElementById('outboundVoicemailMessage');
                textarea.value = settings.outbound_voicemail_message;
                updateVoicemailCharCount();
            }
        }

        async function saveCRMSettings(e) {
            e.preventDefault();

            const outboundVoicemailMessage = document.getElementById('outboundVoicemailMessage').value.trim();

            // Validate outbound voicemail message length
            if (outboundVoicemailMessage && outboundVoicemailMessage.length > 1000) {
                alert('Outbound voicemail message must be 1000 characters or less');
                return;
            }

            // TCPA Compliance: Validate mandatory disclaimer for custom voicemail messages
            if (outboundVoicemailMessage && outboundVoicemailMessage.trim() !== '') {
                const requiredPhrase = 'This message is for informational purposes only';
                const lowerCaseMessage = outboundVoicemailMessage.toLowerCase();
                const lowerCaseRequired = requiredPhrase.toLowerCase();

                if (!lowerCaseMessage.includes(lowerCaseRequired)) {
                    alert(' TCPA Compliance Required\n\n' +
                          'Your custom voicemail message MUST include the phrase:\n' +
                          '"This message is for informational purposes only"\n\n' +
                          'This is required by the Telephone Consumer Protection Act (TCPA) for cold calling compliance.\n\n' +
                          'Without this phrase, your message cannot be saved and the default RinglyPro message will be used instead.');
                    return;
                }
            }

            // Prepare data - only voicemail message now (GHL and SendGrid are in separate settings pages)
            const updateData = {
                // Always include voicemail message (even if empty, to allow clearing it)
                outbound_voicemail_message: outboundVoicemailMessage || null
            };

            const saveBtn = document.getElementById('saveCrmBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await authenticatedFetch(`/api/client/crm-settings/${CLIENT_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (!response) {
                    throw new Error('No response from server');
                }

                const data = await response.json();

                if (data.success) {
                    alert('CRM integration settings saved successfully! \n\nYour credentials will now auto-load in MCP Copilot.');
                    closeSettings();
                    // Reload settings to show updated status
                    await loadCRMSettings();
                } else {
                    throw new Error(data.error || 'Failed to save CRM settings');
                }
            } catch (error) {
                console.error('Error saving CRM settings:', error);
                alert(`Failed to save CRM settings: ${error.message}`);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save CRM Settings';
            }
        }

        // =====================================================
        // IVR SETTINGS FUNCTIONS
        // =====================================================

        let ivrSettingsData = null;

        async function openIVRSettings() {
            document.getElementById('ivrModal').classList.add('active');
            await loadIVRSettings();
        }

        function closeIVRSettings() {
            document.getElementById('ivrModal').classList.remove('active');
        }

        async function loadIVRSettings() {
            try {
                const response = await authenticatedFetch(`/api/client/ivr-settings/${CLIENT_ID}`);

                if (!response) {
                    console.error('No response from IVR settings API');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    ivrSettingsData = data.settings;

                    // Set IVR enabled toggle
                    document.getElementById('ivrEnabled').checked = ivrSettingsData.ivr_enabled || false;

                    // Load department settings
                    const ivrOptions = ivrSettingsData.ivr_options || [];

                    for (let i = 0; i < 3; i++) {
                        const dept = ivrOptions[i] || { name: '', phone: '', enabled: false };
                        const index = i + 1;

                        document.getElementById(`dept${index}Name`).value = dept.name || '';
                        document.getElementById(`dept${index}Phone`).value = dept.phone || '';
                        document.getElementById(`dept${index}Enabled`).checked = dept.enabled || false;
                    }

                    // Update IVR status badge
                    updateIVRStatusBadge(ivrSettingsData.ivr_enabled);
                } else {
                    console.error('Failed to load IVR settings:', data.error);
                }
            } catch (error) {
                console.error('Error loading IVR settings:', error);
            }
        }

        function updateIVRStatusBadge(enabled) {
            const badge = document.getElementById('ivrStatus');
            if (enabled) {
                badge.textContent = 'ON';
                badge.style.background = '#10b981';
            } else {
                badge.textContent = 'OFF';
                badge.style.background = '#6b7280';
            }
        }

        async function saveIVRSettings(e) {
            e.preventDefault();

            const ivrEnabled = document.getElementById('ivrEnabled').checked;

            // Collect department settings
            const ivrOptions = [];
            for (let i = 1; i <= 3; i++) {
                const name = document.getElementById(`dept${i}Name`).value.trim();
                const phone = document.getElementById(`dept${i}Phone`).value.trim();
                const enabled = document.getElementById(`dept${i}Enabled`).checked;

                if (name && phone) {
                    ivrOptions.push({ name, phone, enabled });
                }
            }

            // Save to API
            const saveBtn = document.getElementById('saveIVRBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const response = await authenticatedFetch(`/api/client/ivr-settings/${CLIENT_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ivr_enabled: ivrEnabled,
                        ivr_options: ivrOptions
                    })
                });

                if (!response) {
                    throw new Error('No response from server');
                }

                const data = await response.json();

                if (data.success) {
                    alert('IVR settings saved successfully!');
                    updateIVRStatusBadge(ivrEnabled);
                    closeIVRSettings();
                } else {
                    alert('Error saving IVR settings: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving IVR settings:', error);
                alert('Failed to save IVR settings. Please try again.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save IVR Settings';
            }
        }

        // Initialize IVR form handler
        document.addEventListener('DOMContentLoaded', () => {
            const ivrForm = document.getElementById('ivrSettingsForm');
            if (ivrForm) {
                ivrForm.addEventListener('submit', saveIVRSettings);
            }

            // Load initial IVR status
            loadIVRSettings().catch(err => console.error('Error loading initial IVR status:', err));
        });

        // =====================================================
        // APPOINTMENT MODAL FUNCTIONS
        // =====================================================

        // Store available slots globally
        let availableSlots = [];

        // Open appointment modal
        function openAppointmentModal() {
            const modal = document.getElementById('appointmentModal');
            modal.classList.add('active');

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').setAttribute('min', today);

            // Reset form
            document.getElementById('appointmentForm').reset();
            document.getElementById('appointmentStartTime').disabled = true;
            document.getElementById('appointmentStartTime').innerHTML = '<option value="">Select a date first</option>';
            document.getElementById('appointmentEndTime').disabled = true;
            document.getElementById('appointmentEndTime').innerHTML = '<option value="">Select start time first</option>';
            document.getElementById('appointmentError').style.display = 'none';
            document.getElementById('appointmentSuccess').style.display = 'none';
        }

        // Close appointment modal
        function closeAppointmentModal() {
            const modal = document.getElementById('appointmentModal');
            modal.classList.remove('active');
            document.getElementById('appointmentForm').reset();
        }

        // Load available time slots when date is selected
        async function loadAvailableTimeSlots() {
            const dateInput = document.getElementById('appointmentDate');
            const startTimeSelect = document.getElementById('appointmentStartTime');
            const endTimeSelect = document.getElementById('appointmentEndTime');
            const loading = document.getElementById('appointmentLoadingSlots');
            const errorDiv = document.getElementById('appointmentError');

            const selectedDate = dateInput.value;
            if (!selectedDate) {
                startTimeSelect.disabled = true;
                startTimeSelect.innerHTML = '<option value="">Select a date first</option>';
                endTimeSelect.disabled = true;
                endTimeSelect.innerHTML = '<option value="">Select start time first</option>';
                return;
            }

            // Show loading
            loading.style.display = 'block';
            startTimeSelect.disabled = true;
            endTimeSelect.disabled = true;
            errorDiv.style.display = 'none';

            try {
                const response = await authenticatedFetch(`/api/appointments/availability/${CLIENT_ID}/${selectedDate}`);

                if (!response) {
                    throw new Error('Failed to fetch availability');
                }

                const data = await response.json();

                if (data.success && data.available_slots && data.available_slots.length > 0) {
                    // Store available slots globally
                    availableSlots = data.available_slots;

                    // Populate start time slots
                    startTimeSelect.innerHTML = '<option value="">Select start time</option>' +
                        data.available_slots.map(slot => {
                            return `<option value="${slot}">${formatTimeSlot(slot)}</option>`;
                        }).join('');

                    startTimeSelect.disabled = false;
                } else {
                    startTimeSelect.innerHTML = '<option value="">No available slots for this date</option>';
                    startTimeSelect.disabled = true;
                }
            } catch (error) {
                console.error('Error loading time slots:', error);
                errorDiv.textContent = 'Error loading available time slots. Please try again.';
                errorDiv.style.display = 'block';
                startTimeSelect.innerHTML = '<option value="">Error loading slots</option>';
                startTimeSelect.disabled = true;
            } finally {
                loading.style.display = 'none';
            }
        }

        // Update end time options based on start time selection
        function updateEndTimeOptions() {
            const startTimeSelect = document.getElementById('appointmentStartTime');
            const endTimeSelect = document.getElementById('appointmentEndTime');

            const startTime = startTimeSelect.value;

            if (!startTime || availableSlots.length === 0) {
                endTimeSelect.disabled = true;
                endTimeSelect.innerHTML = '<option value="">Select start time first</option>';
                return;
            }

            // Find the index of the selected start time
            const startIndex = availableSlots.indexOf(startTime);

            // Get all slots after the start time
            const endSlots = availableSlots.slice(startIndex + 1);

            // Add one more option after the last available slot for appointments that go beyond business hours
            endSlots.push(addTimeToSlot(availableSlots[availableSlots.length - 1], 30));

            if (endSlots.length === 0) {
                endTimeSelect.innerHTML = '<option value="">No end time available</option>';
                endTimeSelect.disabled = true;
                return;
            }

            // Populate end time options
            endTimeSelect.innerHTML = '<option value="">Select end time</option>' +
                endSlots.map(slot => {
                    return `<option value="${slot}">${formatTimeSlot(slot)}</option>`;
                }).join('');

            endTimeSelect.disabled = false;
        }

        // Helper function to add minutes to a time string
        function addTimeToSlot(timeSlot, minutes) {
            const [hours, mins] = timeSlot.split(':').map(Number);
            const totalMinutes = hours * 60 + mins + minutes;
            const newHours = Math.floor(totalMinutes / 60);
            const newMins = totalMinutes % 60;
            return `${newHours.toString().padStart(2, '0')}:${newMins.toString().padStart(2, '0')}:00`;
        }

        // Format time slot for display (e.g., "09:00" -> "9:00 AM")
        function formatTimeSlot(time) {
            const [hours, minutes] = time.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Handle appointment form submission
        document.addEventListener('DOMContentLoaded', () => {
            const appointmentForm = document.getElementById('appointmentForm');
            if (appointmentForm) {
                appointmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const submitBtn = document.getElementById('createAppointmentBtn');
                    const errorDiv = document.getElementById('appointmentError');
                    const successDiv = document.getElementById('appointmentSuccess');

                    // Hide messages
                    errorDiv.style.display = 'none';
                    successDiv.style.display = 'none';

                    // Get form data
                    const customerName = document.getElementById('customerName').value.trim();
                    const customerPhone = document.getElementById('customerPhone').value.trim();
                    const customerEmail = document.getElementById('customerEmail').value.trim() || null;
                    const appointmentDate = document.getElementById('appointmentDate').value;
                    const startTime = document.getElementById('appointmentStartTime').value;
                    const endTime = document.getElementById('appointmentEndTime').value;
                    const notes = document.getElementById('appointmentNotes').value.trim() || null;

                    // Validate
                    if (!customerName || !customerPhone || !appointmentDate || !startTime || !endTime) {
                        errorDiv.textContent = 'Please fill in all required fields.';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    // Calculate duration in minutes between start and end time
                    const [startHours, startMins] = startTime.split(':').map(Number);
                    const [endHours, endMins] = endTime.split(':').map(Number);
                    const startTotalMins = startHours * 60 + startMins;
                    const endTotalMins = endHours * 60 + endMins;
                    const duration = endTotalMins - startTotalMins;

                    if (duration <= 0) {
                        errorDiv.textContent = 'End time must be after start time.';
                        errorDiv.style.display = 'block';
                        return;
                    }

                    // Disable submit button
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="loading-spinner"></span> Creating...';

                    try {
                        // Create a single appointment with the calculated duration
                        const response = await authenticatedFetch('/api/appointments/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                customerName,
                                customerPhone,
                                customerEmail,
                                appointmentDate,
                                appointmentTime: startTime,
                                duration: duration,
                                notes
                            })
                        });

                        if (response && response.ok) {
                            // Show success message
                            successDiv.textContent = `Successfully created appointment from ${formatTimeSlot(startTime)} to ${formatTimeSlot(endTime)} (${duration} minutes)`;
                            successDiv.style.display = 'block';

                            // Reload dashboard to show new appointment
                            await loadDashboard();

                            // Close modal after 2 seconds
                            setTimeout(() => {
                                closeAppointmentModal();
                                submitBtn.disabled = false;
                                submitBtn.textContent = 'Create Appointment';
                            }, 2000);
                        } else {
                            throw new Error('Failed to create appointment');
                        }
                    } catch (error) {
                        console.error('Error creating appointments:', error);
                        errorDiv.textContent = error.message || 'Error creating appointments. Please try again.';
                        errorDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Create Appointment';
                    }
                });
            }
        });
    </script>

    <!-- Stripe Library - loaded dynamically when needed to prevent WebView redirect issues -->
    <!-- Credits Modal JavaScript -->
    <script>
        // Stripe Configuration - PRODUCTION LIVE KEY
        const STRIPE_PUBLISHABLE_KEY = 'pk_live_51RHs2aF3QBlDrgxx4L6FasMQjDPEPWh4WL3MYFQQAleDBeFdQxb52gCoGrSdSEuMEE6Ls3Em02xqfxNErg05Dk9100MR9XAlHI';

        // Defer Stripe initialization until needed
        let stripe = null;
        let elements = null;
        let cardElement = null;
        let stripeInitialized = false;
        let stripeScriptLoaded = false;

        // Load Stripe script dynamically
        function loadStripeScript() {
            return new Promise((resolve, reject) => {
                if (stripeScriptLoaded) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://js.stripe.com/v3/';
                script.onload = () => {
                    stripeScriptLoaded = true;
                    resolve();
                };
                script.onerror = () => reject(new Error('Failed to load Stripe'));
                document.head.appendChild(script);
            });
        }

        function initializeStripe() {
            if (stripeInitialized || typeof Stripe === 'undefined') return false;

            stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
            elements = stripe.elements();

            // Create card element
            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#1f2937',
                        '::placeholder': {
                            color: '#9ca3af'
                        }
                    },
                    invalid: {
                        color: '#ef4444'
                    }
                }
            });

            stripeInitialized = true;
            return true;
        }

        // State
        let selectedAmount = null;
        let cardMounted = false;

        // Mount card element when modal opens
        async function mountCardElement() {
            // Load Stripe script first if not loaded
            if (!stripeScriptLoaded) {
                try {
                    await loadStripeScript();
                } catch (error) {
                    console.error('Failed to load Stripe:', error);
                    return;
                }
            }

            // Initialize Stripe on first use
            if (!stripeInitialized) {
                if (!initializeStripe()) {
                    console.error('Stripe not initialized');
                    return;
                }
            }

            if (!cardMounted && cardElement) {
                cardElement.mount('#card-element');
                cardMounted = true;

                // Handle card errors
                cardElement.on('change', function(event) {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
            }
        }

        // Redirect to dedicated purchase page instead of modal
        function showCreditsInfo() {
            // Navigate to dedicated token purchase page
            // This avoids all Stripe loading issues in iOS WebView
            window.location.href = '/purchase-tokens';
        }

        // Close credits modal
        function closeCreditsModal() {
            const modal = document.getElementById('creditsModal');
            modal.classList.remove('active');
            
            // Reset card element errors
            document.getElementById('card-errors').textContent = '';
        }

        // Load balance data into modal
        async function loadModalBalance() {
            try {
                const token = localStorage.getItem('token');

                // Fetch token balance
                const balanceResponse = await fetch('/api/tokens/balance', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Fetch referral stats
                const referralResponse = await fetch('/api/referrals/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (balanceResponse.ok) {
                    const balanceData = await balanceResponse.json();
                    const tokensBalance = balanceData.balance || 0;
                    const tokensUsed = balanceData.usedThisMonth || 0;
                    const monthlyAllocation = balanceData.monthlyAllocation || 100;

                    // Calculate referral tokens if available
                    let referralTokens = 0;
                    if (referralResponse.ok) {
                        const referralData = await referralResponse.json();
                        referralTokens = referralData.stats?.tokensEarned || 0;
                    }

                    // Calculate purchased tokens (balance - monthly free - referral)
                    const purchasedTokens = Math.max(0, tokensBalance - monthlyAllocation - referralTokens);

                    // Display breakdown
                    document.getElementById('modalBalance').textContent = `${tokensBalance.toLocaleString()} tokens`;
                    document.getElementById('modalFreeMinutes').textContent = `${referralTokens.toLocaleString()} referral tokens`;
                    document.getElementById('modalPaidMinutes').textContent = `${purchasedTokens.toLocaleString()} purchased`;
                }
            } catch (error) {
                console.error('Error loading balance:', error);
            }
        }

        // Select package
        function selectPackage(amount) {
            selectedAmount = amount;
            
            // Update UI
            document.querySelectorAll('.package-option').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-amount="${amount}"]`).classList.add('selected');
            
            // Enable pay button
            const payButton = document.getElementById('payButton');
            payButton.disabled = false;
            payButton.textContent = `Pay $${amount}`;
        }

        // Process payment
        async function processPayment() {
            if (!selectedAmount) {
                alert('Please select a package');
                return;
            }

            const payButton = document.getElementById('payButton');
            const originalText = payButton.textContent;

            try {
                // Disable button and show loading
                payButton.disabled = true;
                payButton.innerHTML = '<span class="loading-spinner"></span>Processing...';

                // Step 1: Create payment intent
                const token = localStorage.getItem('token');
                const response = await fetch('/api/credits/reload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ amount: selectedAmount })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create payment intent');
                }

                const { clientSecret, transactionId } = await response.json();

                // Step 2: Confirm payment with Stripe
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement
                    }
                });

                if (error) {
                    throw new Error(error.message);
                }

                // Step 3: Payment successful
                if (paymentIntent.status === 'succeeded') {
                    // Show success message
                    document.getElementById('successMessage').classList.add('show');

                    // Wait for webhook to process (give it 2 seconds)
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Refresh balance
                    await loadCreditsBalance();
                    await loadModalBalance();

                    // Clear card
                    cardElement.clear();

                    // Reset UI after 2 seconds
                    setTimeout(() => {
                        closeCreditsModal();
                    }, 2000);
                }

            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('card-errors').textContent = error.message;
                payButton.disabled = false;
                payButton.textContent = originalText;
            }
        }

        // Close modal when clicking outside
        document.getElementById('creditsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCreditsModal();
            }
        });

        // Handle Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCreditsModal();
                closeDepositModal();
            }
        });

        // =====================================================
        // Deposit Confirmation Modal Functions
        // =====================================================
        let currentDepositAppointmentId = null;

        function openDepositModal(appointmentId, customerName, date, time) {
            currentDepositAppointmentId = appointmentId;
            document.getElementById('depositCustomerName').textContent = customerName;
            document.getElementById('depositDateTime').textContent = `${date} at ${time}`;
            document.getElementById('depositMethod').value = 'manual';
            document.getElementById('depositNotes').value = '';
            document.getElementById('depositModal').classList.add('active');
        }

        function closeDepositModal() {
            document.getElementById('depositModal').classList.remove('active');
            currentDepositAppointmentId = null;
        }

        async function confirmDeposit() {
            if (!currentDepositAppointmentId) {
                alert('No appointment selected');
                return;
            }

            const method = document.getElementById('depositMethod').value;
            const notes = document.getElementById('depositNotes').value;
            const confirmBtn = document.querySelector('#depositModal .btn-confirm-deposit');
            const originalText = confirmBtn.textContent;
            const token = localStorage.getItem('token');

            try {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Confirming...';

                const response = await fetch(`/api/appointments/${currentDepositAppointmentId}/deposit-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        status: 'confirmed',
                        method: method,
                        notes: notes
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show success message
                    alert('Deposit confirmed! Customer has been notified via SMS and Email.');
                    closeDepositModal();
                    // Refresh appointments to show updated status
                    loadDashboard();
                } else {
                    alert('Error confirming deposit: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Deposit confirmation error:', error);
                alert('Error confirming deposit: ' + error.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
            }
        }

        // Close deposit modal when clicking outside
        document.getElementById('depositModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDepositModal();
            }
        });
    </script>

    <!-- Deposit Confirmation Modal -->
    <div id="depositModal" class="modal">
        <div class="modal-overlay" onclick="closeDepositModal()"></div>
        <div class="modal-content" style="width: 100%; max-width: 450px;">
            <div class="modal-header">
                <h2>Confirm Deposit</h2>
                <button class="modal-close" onclick="closeDepositModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.5rem; height: 1.5rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #166534;">Appointment Details</p>
                    <p style="margin: 0; color: #15803d;">Customer: <strong id="depositCustomerName"></strong></p>
                    <p style="margin: 0; color: #15803d;">Date/Time: <strong id="depositDateTime"></strong></p>
                </div>

                <div class="form-group">
                    <label for="depositMethod">Confirmation Method</label>
                    <select id="depositMethod" class="form-input">
                        <option value="manual">Manual Verification</option>
                        <option value="zelle">Zelle Receipt</option>
                        <option value="venmo">Venmo Receipt</option>
                        <option value="cash_app">Cash App Receipt</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="cash">Cash Payment</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="depositNotes">Notes (optional)</label>
                    <textarea id="depositNotes" class="form-input" rows="3" placeholder="Any additional notes about the deposit..."></textarea>
                </div>

                <div style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                    <p style="margin: 0; font-size: 0.875rem; color: #1e40af;">
                        <strong>Note:</strong> The customer will receive both SMS and Email confirmation when you confirm this deposit.
                    </p>
                </div>

                <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                    <button type="button" onclick="closeDepositModal()" style="padding: 0.625rem 1.25rem; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 0.5rem; font-weight: 500; cursor: pointer;">
                        Cancel
                    </button>
                    <button type="button" class="btn-confirm-deposit" onclick="confirmDeposit()" style="padding: 0.625rem 1.25rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer;">
                        Confirm Deposit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Details Modal (for calendar grid click) -->
    <div id="appointmentDetailsModal" class="modal">
        <div class="modal-overlay" onclick="closeAppointmentDetailsModal()"></div>
        <div class="modal-content" style="width: 100%; max-width: 400px;">
            <div class="modal-header">
                <h2 id="aptDetailsTitle">Appointment Details</h2>
                <button class="modal-close" onclick="closeAppointmentDetailsModal()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.5rem; height: 1.5rem;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div style="background: #f0f9ff; border: 1px solid #7dd3fc; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0 0 0.5rem 0; font-weight: 600; color: #0369a1; font-size: 1.1rem;" id="aptDetailsName"></p>
                    <p style="margin: 0 0 0.25rem 0; color: #0284c7;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span id="aptDetailsDate"></span>
                    </p>
                    <p style="margin: 0 0 0.25rem 0; color: #0284c7;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="aptDetailsTime"></span>
                    </p>
                    <p style="margin: 0; color: #0284c7;" id="aptDetailsPhoneRow">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        <span id="aptDetailsPhone"></span>
                    </p>
                </div>
                <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem;">
                    <p style="margin: 0; font-size: 0.875rem; color: #6b7280;">
                        <strong>Purpose:</strong> <span id="aptDetailsPurpose"></span>
                    </p>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #6b7280;" id="aptDetailsSourceRow">
                        <strong>Source:</strong> <span id="aptDetailsSource"></span>
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;" id="aptDetailsStatusRow">
                        <strong>Status:</strong> <span id="aptDetailsStatus"></span>
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #6b7280;" id="aptDetailsDepositRow">
                        <strong>Deposit:</strong> <span id="aptDetailsDepositStatus"></span>
                    </p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Confirm Appointment Button (for AI voice bookings that need confirmation) -->
                    <button type="button" id="aptDetailsConfirmBtn" onclick="aptDetailsAction('confirm')" style="padding: 0.75rem 1rem; background: #22c55e; color: white; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; display: none; align-items: center; justify-content: center; gap: 0.5rem;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Confirm Appointment
                    </button>
                    <button type="button" id="aptDetailsDepositBtn" onclick="aptDetailsAction('deposit')" style="padding: 0.75rem 1rem; background: #f59e0b; color: white; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; display: none; align-items: center; justify-content: center; gap: 0.5rem;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Confirm Deposit
                    </button>
                    <button type="button" id="aptDetailsTextBtn" onclick="aptDetailsAction('text')" style="padding: 0.75rem 1rem; background: #10b981; color: white; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                        Send Text Message
                    </button>
                    <button type="button" id="aptDetailsCallBtn" onclick="aptDetailsAction('call')" style="padding: 0.75rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        Call Customer
                    </button>
                    <button type="button" id="aptDetailsDeleteBtn" onclick="aptDetailsAction('delete')" style="padding: 0.75rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 1.25rem; height: 1.25rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Delete Appointment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ElevenLabs User Training AI Widget - helps clients learn to use RinglyPro -->
    <style>
        #elevenlabs-widget-wrapper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        #elevenlabs-widget-wrapper.hidden {
            display: none;
        }
        #widget-close-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 10000;
            transition: all 0.2s;
        }
        #widget-close-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        #widget-reopen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            z-index: 9998;
            transition: all 0.2s;
        }
        #widget-reopen-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
        }
        #widget-reopen-btn.show {
            display: flex;
        }
    </style>
    <!-- ElevenLabs Voice AI Widget - starts minimized -->
    <div id="elevenlabs-widget-wrapper" class="hidden">
        <button id="widget-close-btn" onclick="closeVoiceWidget()" title="Close widget"></button>
        <div id="elevenlabs-widget-container">
            <elevenlabs-convai agent-id="agent_4801kd9a0495frvbjxz6dyrnbz1j"></elevenlabs-convai>
        </div>
    </div>
    <button id="widget-reopen-btn" class="show" onclick="reopenVoiceWidget()" title="Open Voice Assistant">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/>
        </svg>
    </button>
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
    <script>
        // ElevenLabs User Training AI Widget - available for all clients
        // Agent: agent_4801kd9a0495frvbjxz6dyrnbz1j (RinglyPro user training assistant)

        function openVoiceAssistant() {
            // Find the ElevenLabs widget and click its call button
            const widget = document.querySelector('elevenlabs-convai');
            if (widget && widget.shadowRoot) {
                const callButton = widget.shadowRoot.querySelector('button');
                if (callButton) {
                    callButton.click();
                }
            }
        }

        function closeVoiceWidget() {
            const wrapper = document.getElementById('elevenlabs-widget-wrapper');
            const reopenBtn = document.getElementById('widget-reopen-btn');
            wrapper.classList.add('hidden');
            reopenBtn.classList.add('show');
        }

        function reopenVoiceWidget() {
            const wrapper = document.getElementById('elevenlabs-widget-wrapper');
            const reopenBtn = document.getElementById('widget-reopen-btn');
            wrapper.classList.remove('hidden');
            reopenBtn.classList.remove('show');
        }

        // ============================================
        // CONTACTS MODAL FUNCTIONS
        // ============================================
        let allContacts = [];
        let contactsGhlConfig = null;

        async function openContactsModal() {
            const modal = document.getElementById('contactsModal');
            modal.classList.add('active');

            // Reset states
            document.getElementById('contactsLoading').style.display = 'block';
            document.getElementById('contactsList').style.display = 'none';
            document.getElementById('contactsEmpty').style.display = 'none';
            document.getElementById('contactsError').style.display = 'none';
            document.getElementById('contactSearchInput').value = '';
            document.getElementById('contactSourceFilter').value = 'all';

            await loadContacts();
        }

        function closeContactsModal() {
            const modal = document.getElementById('contactsModal');
            modal.classList.remove('active');
        }

        async function loadContacts() {
            try {
                console.log(' Loading contacts for client:', CLIENT_ID);

                // Fetch GHL credentials for this specific client (multi-tenant secure)
                const credsResponse = await authenticatedFetch(`/api/client/ghl-credentials/${CLIENT_ID}`);
                const credsData = await credsResponse.json();

                if (!credsData.success || !credsData.credentials) {
                    console.log(' No GHL integration configured for this client');
                    document.getElementById('contactsLoading').style.display = 'none';
                    document.getElementById('contactsError').style.display = 'block';
                    document.getElementById('contactsError').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p style="font-weight: 600; margin-bottom: 0.5rem;">GoHighLevel Not Connected</p>
                            <p style="font-size: 0.875rem;">Please configure your GHL integration in Settings to view contacts.</p>
                        </div>
                    `;
                    return;
                }

                const ghlCreds = credsData.credentials;
                console.log(' Using GHL credentials for client:', CLIENT_ID);

                // Store GHL config for later use (call, SMS, edit operations)
                contactsGhlConfig = {
                    apiKey: ghlCreds.api_key,
                    locationId: ghlCreds.location_id
                };

                // Fetch contacts from GHL via our API (mounted at /api/ghl)
                console.log(' Calling /api/ghl/contacts/search...');
                const response = await authenticatedFetch('/api/ghl/contacts/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-ghl-api-key': ghlCreds.api_key,
                        'x-ghl-location-id': ghlCreds.location_id
                    },
                    body: JSON.stringify({ limit: 500 })
                });

                console.log(' Response status:', response.status);
                const data = await response.json();
                console.log(' Response data:', data);

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load contacts');
                }

                allContacts = data.data?.contacts || [];
                console.log(' Loaded contacts:', allContacts.length);

                // Update contacts count in header
                const countEl = document.getElementById('contactsCount');
                if (countEl) {
                    countEl.textContent = allContacts.length;
                }

                document.getElementById('contactsLoading').style.display = 'none';

                if (allContacts.length === 0) {
                    document.getElementById('contactsEmpty').style.display = 'block';
                } else {
                    renderContacts(allContacts);
                    document.getElementById('contactsList').style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading contacts:', error);
                document.getElementById('contactsLoading').style.display = 'none';
                document.getElementById('contactsError').textContent = error.message;
                document.getElementById('contactsError').style.display = 'block';
            }
        }

        function renderContacts(contacts) {
            const grid = document.getElementById('contactsGrid');
            const showingEl = document.getElementById('contactsShowing');
            const totalEl = document.getElementById('contactsTotal');

            showingEl.textContent = contacts.length;
            totalEl.textContent = allContacts.length;

            if (contacts.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No contacts match your search</div>';
                return;
            }

            grid.innerHTML = contacts.map(contact => {
                const name = [contact.firstName, contact.lastName].filter(Boolean).join(' ') || 'Unknown';
                const tags = contact.tags || [];
                const isRinglyPro = tags.some(t => t.toLowerCase().includes('ringlypro') || t.toLowerCase().includes('ringly'));
                const sourceTag = isRinglyPro ? 'RinglyPro' : 'GHL';
                const sourceColor = isRinglyPro ? '#10b981' : '#3b82f6';
                const escapedName = escapeHtml(name).replace(/'/g, "\\'");
                const escapedPhone = (contact.phone || '').replace(/'/g, "\\'");
                const contactDataAttr = encodeURIComponent(JSON.stringify(contact));

                return `
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <strong style="font-size: 0.95rem; color: #1f2937;">${escapeHtml(name)}</strong>
                                    <span style="background: ${sourceColor}; color: white; font-size: 0.65rem; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-weight: 600;">${sourceTag}</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #6b7280;">
                                    ${contact.phone ? `<span style="margin-right: 1rem;"> ${escapeHtml(contact.phone)}</span>` : ''}
                                    ${contact.email ? `<span> ${escapeHtml(contact.email)}</span>` : ''}
                                </div>
                                ${tags.length > 0 ? `
                                    <div style="margin-top: 0.5rem; display: flex; gap: 0.25rem; flex-wrap: wrap;">
                                        ${tags.slice(0, 5).map(tag => `<span style="background: #e5e7eb; color: #4b5563; font-size: 0.65rem; padding: 0.1rem 0.35rem; border-radius: 0.2rem;">${escapeHtml(tag)}</span>`).join('')}
                                        ${tags.length > 5 ? `<span style="color: #9ca3af; font-size: 0.65rem;">+${tags.length - 5} more</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="color: #9ca3af; font-size: 0.7rem; text-align: right; white-space: nowrap;">
                                ${contact.dateAdded ? new Date(contact.dateAdded).toLocaleDateString() : ''}
                            </div>
                        </div>
                        <!-- Action buttons -->
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap;">
                            ${contact.phone ? `
                                <button onclick="makeCall('${escapedPhone}', '${escapedName}')"
                                    style="padding: 0.4rem 0.75rem; background: #10b981; color: white; border: none; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                                     Call
                                </button>
                                <button onclick="sendSMS('${escapedPhone}', '${escapedName}')"
                                    style="padding: 0.4rem 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                                     SMS
                                </button>
                            ` : ''}
                            <button onclick="openContactConversation('${contactDataAttr}')"
                                style="padding: 0.4rem 0.75rem; background: #8b5cf6; color: white; border: none; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                                 History
                            </button>
                            <button onclick="openEditContact('${contactDataAttr}')"
                                style="padding: 0.4rem 0.75rem; background: #6b7280; color: white; border: none; border-radius: 0.375rem; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.25rem;">
                                 Edit
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterContacts() {
            const searchTerm = document.getElementById('contactSearchInput').value.toLowerCase();
            const sourceFilter = document.getElementById('contactSourceFilter').value;

            let filtered = allContacts;

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(contact => {
                    const name = [contact.firstName, contact.lastName].filter(Boolean).join(' ').toLowerCase();
                    const phone = (contact.phone || '').toLowerCase();
                    const email = (contact.email || '').toLowerCase();
                    return name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm);
                });
            }

            // Filter by source
            if (sourceFilter !== 'all') {
                filtered = filtered.filter(contact => {
                    const tags = contact.tags || [];
                    const isRinglyPro = tags.some(t => t.toLowerCase().includes('ringlypro') || t.toLowerCase().includes('ringly'));
                    if (sourceFilter === 'ringlypro') return isRinglyPro;
                    if (sourceFilter === 'ghl') return !isRinglyPro;
                    return true;
                });
            }

            renderContacts(filtered);
        }

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Edit Contact Modal Functions
        let currentEditingContact = null;

        function openEditContact(encodedContactData) {
            try {
                const contact = JSON.parse(decodeURIComponent(encodedContactData));
                currentEditingContact = contact;

                // Populate form fields
                document.getElementById('editContactId').value = contact.id;
                document.getElementById('editFirstName').value = contact.firstName || contact.firstNameRaw || '';
                document.getElementById('editLastName').value = contact.lastName || contact.lastNameRaw || '';
                document.getElementById('editPhone').value = contact.phone || '';
                document.getElementById('editEmail').value = contact.email || '';
                document.getElementById('editTags').value = (contact.tags || []).join(', ');

                // Clear messages
                document.getElementById('editContactError').style.display = 'none';
                document.getElementById('editContactSuccess').style.display = 'none';

                // Show modal
                document.getElementById('editContactModal').classList.add('active');
            } catch (error) {
                console.error('Error opening edit contact modal:', error);
                alert('Failed to open contact editor');
            }
        }

        function closeEditContact() {
            document.getElementById('editContactModal').classList.remove('active');
            currentEditingContact = null;
        }

        async function saveContact(event) {
            event.preventDefault();

            const contactId = document.getElementById('editContactId').value;
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const tagsInput = document.getElementById('editTags').value;
            const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);

            // Validate
            if (!firstName && !lastName) {
                showEditContactError('Please enter at least a first or last name');
                return;
            }

            const submitBtn = document.getElementById('editContactSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                // Use stored GHL config from loadContacts (multi-tenant secure)
                if (!contactsGhlConfig) {
                    throw new Error('GHL configuration not loaded. Please refresh the contacts list.');
                }

                const response = await authenticatedFetch(`/api/ghl/contacts/${contactId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-ghl-api-key': contactsGhlConfig.apiKey,
                        'x-ghl-location-id': contactsGhlConfig.locationId
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        phone,
                        email,
                        tags
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showEditContactSuccess('Contact updated successfully! Changes synced to GoHighLevel.');

                    // Update local contact data
                    const contactIndex = allContacts.findIndex(c => c.id === contactId);
                    if (contactIndex !== -1) {
                        allContacts[contactIndex] = {
                            ...allContacts[contactIndex],
                            firstName,
                            lastName,
                            phone,
                            email,
                            tags
                        };
                    }

                    // Re-render contacts after a short delay
                    setTimeout(() => {
                        filterContacts();
                        closeEditContact();
                    }, 1500);
                } else {
                    showEditContactError(data.error || 'Failed to update contact');
                }
            } catch (error) {
                console.error('Error saving contact:', error);
                showEditContactError('Failed to save contact: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        }

        function showEditContactError(message) {
            const errorEl = document.getElementById('editContactError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            document.getElementById('editContactSuccess').style.display = 'none';
        }

        function showEditContactSuccess(message) {
            const successEl = document.getElementById('editContactSuccess');
            successEl.textContent = message;
            successEl.style.display = 'block';
            document.getElementById('editContactError').style.display = 'none';
        }

        // ============= CONTACT CONVERSATION HISTORY =============
        let currentContactConversation = null;

        async function openContactConversation(encodedContactData) {
            try {
                const contact = JSON.parse(decodeURIComponent(encodedContactData));
                currentContactConversation = contact;

                const contactName = [contact.firstName, contact.lastName].filter(Boolean).join(' ') || 'Unknown';
                const tags = contact.tags || [];
                const isRinglyPro = tags.some(t => t.toLowerCase().includes('ringlypro') || t.toLowerCase().includes('ringly'));

                // Populate modal header
                document.getElementById('contactConvName').textContent = contactName;
                document.getElementById('contactConvPhone').textContent = contact.phone || 'No phone';

                // Contact info summary
                document.getElementById('contactConvEmail').textContent = contact.email ? ` ${contact.email}` : '';
                document.getElementById('contactConvTags').textContent = tags.length > 0 ? ` ${tags.slice(0, 3).join(', ')}${tags.length > 3 ? '...' : ''}` : '';
                document.getElementById('contactConvSource').textContent = isRinglyPro ? ' RinglyPro' : ' GHL';

                // GHL badge
                const ghlBadge = document.getElementById('contactGhlBadge');
                ghlBadge.style.display = contact.id ? 'inline-block' : 'none';

                // Show modal
                document.getElementById('contactConversationModal').classList.add('active');

                // Load conversation history
                await loadContactConversationHistory(contact);

            } catch (error) {
                console.error('Error opening contact conversation:', error);
                alert('Failed to load conversation history');
            }
        }

        function closeContactConversation() {
            document.getElementById('contactConversationModal').classList.remove('active');
            currentContactConversation = null;
        }

        async function loadContactConversationHistory(contact) {
            const container = document.getElementById('contactConvMessages');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading conversation history...</p></div>';

            try {
                // Try to find local contact by phone number first
                const phone = contact.phone;
                if (!phone) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;"><p>No phone number - cannot load conversation history</p></div>';
                    return;
                }

                // Fetch messages by phone number from our messages API
                const response = await authenticatedFetch(`/api/messages/phone/${encodeURIComponent(phone)}?client_id=${CLIENT_ID}&limit=50`);

                if (!response || !response.ok) {
                    // Try alternate endpoint - search by GHL contact ID
                    if (contact.id) {
                        await loadConversationByGHLContact(contact, container);
                        return;
                    }
                    throw new Error('Failed to load messages');
                }

                const messages = await response.json();

                if (!messages || messages.length === 0) {
                    // No messages found by phone, try GHL contact lookup
                    if (contact.id) {
                        await loadConversationByGHLContact(contact, container);
                        return;
                    }

                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem; opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                            <p>No conversation history with this contact</p>
                            <p style="font-size: 0.8rem; margin-top: 0.5rem;">Send an SMS to start a conversation</p>
                        </div>
                    `;
                    return;
                }

                renderContactConversationMessages(messages, container);

            } catch (error) {
                console.error('Error loading contact conversation:', error);

                // Try GHL contact lookup as fallback
                if (contact.id) {
                    await loadConversationByGHLContact(contact, container);
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <p>No conversation history found</p>
                        </div>
                    `;
                }
            }
        }

        async function loadConversationByGHLContact(contact, container) {
            try {
                // Use stored GHL config from loadContacts (multi-tenant secure)
                if (!contactsGhlConfig) {
                    throw new Error('GHL configuration not loaded');
                }

                const ghlResponse = await authenticatedFetch(`/api/ghl/conversations/${contact.id}/messages?limit=50`, {
                    headers: {
                        'x-ghl-api-key': contactsGhlConfig.apiKey,
                        'x-ghl-location-id': contactsGhlConfig.locationId
                    }
                });

                if (ghlResponse && ghlResponse.ok) {
                    const ghlData = await ghlResponse.json();
                    if (ghlData.success && ghlData.data?.messages?.length > 0) {
                        renderGHLConversationMessages(ghlData.data.messages, container);
                        return;
                    }
                }

                // No messages found
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6b7280;">
                        <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin: 0 auto 1rem; opacity: 0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <p>No conversation history with this contact</p>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem;">Send an SMS to start a conversation</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading GHL conversation:', error);
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #ef4444;"><p>Error loading conversation</p></div>';
            }
        }

        function renderContactConversationMessages(messages, container) {
            // Sort messages oldest first for chat display
            const sortedMessages = [...messages].sort((a, b) =>
                new Date(a.createdAt || a.created_at) - new Date(b.createdAt || b.created_at)
            );

            container.innerHTML = sortedMessages.map(msg => {
                const isOutgoing = msg.direction === 'outgoing';
                const createdAt = new Date(msg.createdAt || msg.created_at);
                const timeStr = createdAt.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, month: 'short', day: 'numeric' });

                // Message type indicator
                const msgType = msg.messageType || msg.message_type || 'sms';
                const typeIcon = msgType === 'voicemail' ? ' '
                    : msgType === 'call' ? ' '
                    : msgType === 'email' ? ' '
                    : '';

                // Source indicator
                const msgSource = msg.messageSource || msg.message_source || 'twilio';
                const sourceIndicator = msg.syncedToGhl || msg.synced_to_ghl
                    ? '<span style="font-size: 0.65rem; color: #10b981; margin-left: 0.25rem;">GHL</span>'
                    : msgSource === 'ghl'
                    ? '<span style="font-size: 0.65rem; color: #3b82f6; margin-left: 0.25rem;">GHL</span>'
                    : '';

                return `
                    <div style="display: flex; flex-direction: column; align-items: ${isOutgoing ? 'flex-end' : 'flex-start'};">
                        <div style="max-width: 80%; padding: 0.75rem 1rem; border-radius: ${isOutgoing ? '1rem 1rem 0.25rem 1rem' : '1rem 1rem 1rem 0.25rem'}; background: ${isOutgoing ? '#3b82f6' : '#f3f4f6'}; color: ${isOutgoing ? 'white' : '#1f2937'};">
                            ${typeIcon}${msg.body || '(No content)'}
                        </div>
                        <div style="font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem;">
                            ${timeStr} ${sourceIndicator}
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function renderGHLConversationMessages(messages, container) {
            // Sort messages oldest first
            const sortedMessages = [...messages].sort((a, b) =>
                new Date(a.dateAdded || a.createdAt) - new Date(b.dateAdded || b.createdAt)
            );

            container.innerHTML = sortedMessages.map(msg => {
                const isOutgoing = msg.direction === 'outbound';
                const createdAt = new Date(msg.dateAdded || msg.createdAt);
                const timeStr = createdAt.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true, month: 'short', day: 'numeric' });

                // Message type indicator
                const msgType = (msg.type || 'SMS').toUpperCase();
                const typeIcon = msgType === 'EMAIL' ? ' '
                    : msgType === 'CALL' ? ' '
                    : msgType === 'WHATSAPP' ? ' '
                    : '';

                return `
                    <div style="display: flex; flex-direction: column; align-items: ${isOutgoing ? 'flex-end' : 'flex-start'};">
                        <div style="max-width: 80%; padding: 0.75rem 1rem; border-radius: ${isOutgoing ? '1rem 1rem 0.25rem 1rem' : '1rem 1rem 1rem 0.25rem'}; background: ${isOutgoing ? '#3b82f6' : '#f3f4f6'}; color: ${isOutgoing ? 'white' : '#1f2937'};">
                            ${typeIcon}${msg.body || msg.message || '(No content)'}
                        </div>
                        <div style="font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem;">
                            ${timeStr} <span style="font-size: 0.65rem; color: #3b82f6; margin-left: 0.25rem;">GHL</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        async function syncContactConversationWithGHL() {
            if (!currentContactConversation) return;

            const btn = document.getElementById('contactSyncGHLBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>Syncing...</span>';

            try {
                // Use stored GHL config from loadContacts (multi-tenant secure)
                if (!contactsGhlConfig) {
                    throw new Error('GHL configuration not loaded');
                }

                // Fetch latest messages from GHL
                const response = await authenticatedFetch(`/api/ghl/conversations/${currentContactConversation.id}/messages?limit=50`, {
                    headers: {
                        'x-ghl-api-key': contactsGhlConfig.apiKey,
                        'x-ghl-location-id': contactsGhlConfig.locationId
                    }
                });

                if (response && response.ok) {
                    btn.innerHTML = '<span style="color: #10b981;">Synced!</span>';

                    // Reload conversation
                    await loadContactConversationHistory(currentContactConversation);

                    setTimeout(() => {
                        btn.innerHTML = `
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                            </svg>
                            Sync GHL
                        `;
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('Sync failed');
                }

            } catch (error) {
                console.error('Error syncing with GHL:', error);
                btn.innerHTML = '<span style="color: #ef4444;">Error</span>';
                setTimeout(() => {
                    btn.innerHTML = `
                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                        </svg>
                        Sync GHL
                    `;
                    btn.disabled = false;
                }, 2000);
            }
        }

        async function sendContactConvReply() {
            if (!currentContactConversation || !currentContactConversation.phone) {
                alert('No phone number available');
                return;
            }

            const input = document.getElementById('contactConvReplyInput');
            const message = input.value.trim();
            if (!message) return;

            // Clear input
            input.value = '';

            try {
                // Send via SMS endpoint
                const response = await authenticatedFetch(`/api/mobile/send-sms/${CLIENT_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: currentContactConversation.phone,
                        body: message
                    })
                });

                if (response && response.ok) {
                    // Reload conversation to show the new message
                    await loadContactConversationHistory(currentContactConversation);
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Error sending reply:', error);
                alert('Error sending message');
            }
        }

        // Handle enter key in contact conversation reply input
        document.addEventListener('DOMContentLoaded', () => {
            const contactConvInput = document.getElementById('contactConvReplyInput');
            if (contactConvInput) {
                contactConvInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendContactConvReply();
                    }
                });
            }
        });

        // Analytics Modal Functions
        let currentAnalyticsPeriod = 'today';

        function openAnalyticsModal() {
            document.getElementById('analyticsModal').classList.add('active');
            loadAnalytics('today');
        }

        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').classList.remove('active');
        }

        async function loadAnalytics(period) {
            currentAnalyticsPeriod = period;

            // Update button styles
            document.querySelectorAll('.analytics-period-btn').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#374151';
            });
            const activeBtn = document.getElementById(`analyticsBtn-${period}`);
            if (activeBtn) {
                activeBtn.style.background = '#f59e0b';
                activeBtn.style.color = 'white';
            }

            // Show loading
            document.getElementById('analyticsLoading').style.display = 'block';
            document.getElementById('analyticsContent').style.display = 'none';

            try {
                // Calculate date range
                const now = new Date();
                let startDate = new Date();

                if (period === 'today') {
                    startDate.setHours(0, 0, 0, 0);
                } else if (period === 'week') {
                    startDate.setDate(now.getDate() - 7);
                } else if (period === 'month') {
                    startDate.setDate(now.getDate() - 30);
                }

                // Fetch analytics data from multiple endpoints
                const [callsResponse, appointmentsResponse, messagesResponse, extendedResponse] = await Promise.all([
                    authenticatedFetch(`/api/mobile/analytics/calls/${CLIENT_ID}?start=${startDate.toISOString()}&end=${now.toISOString()}`).catch(() => null),
                    authenticatedFetch(`/api/mobile/analytics/appointments/${CLIENT_ID}?start=${startDate.toISOString()}&end=${now.toISOString()}`).catch(() => null),
                    authenticatedFetch(`/api/mobile/analytics/messages/${CLIENT_ID}?start=${startDate.toISOString()}&end=${now.toISOString()}`).catch(() => null),
                    authenticatedFetch(`/api/mobile/analytics/extended/${CLIENT_ID}?start=${startDate.toISOString()}&end=${now.toISOString()}`).catch(() => null)
                ]);

                let callsData = { total: 0, answered: 0, missed: 0, incoming: 0, outgoing: 0, duration: 0 };
                let appointmentsCount = 0;
                let messagesData = { incoming: 0, outgoing: 0 };
                let extendedData = { afterHoursCalls: 0, afterHoursBookings: 0, tokensAvailable: 0, tokenAvgRate: 0, avgConversationTime: 0 };

                // Process calls data
                if (callsResponse && callsResponse.ok) {
                    const data = await callsResponse.json();
                    if (data.success) {
                        callsData = data.stats || callsData;
                    }
                }

                // Process appointments data
                if (appointmentsResponse && appointmentsResponse.ok) {
                    const data = await appointmentsResponse.json();
                    if (data.success) {
                        appointmentsCount = data.count || 0;
                    }
                }

                // Process messages data
                if (messagesResponse && messagesResponse.ok) {
                    const data = await messagesResponse.json();
                    if (data.success) {
                        messagesData = data.stats || messagesData;
                    }
                }

                // Process extended analytics data
                if (extendedResponse && extendedResponse.ok) {
                    const data = await extendedResponse.json();
                    if (data.success) {
                        extendedData = data.extended || extendedData;
                    }
                }

                // Update UI
                updateAnalyticsUI(callsData, appointmentsCount, messagesData, extendedData);

            } catch (error) {
                console.error('Error loading analytics:', error);
                // Show content with zeros if error
                updateAnalyticsUI(
                    { total: 0, answered: 0, missed: 0, incoming: 0, outgoing: 0, duration: 0 },
                    0,
                    { incoming: 0, outgoing: 0 },
                    { afterHoursCalls: 0, afterHoursBookings: 0, tokensAvailable: 0, tokenAvgRate: 0, avgConversationTime: 0 }
                );
            }
        }

        function updateAnalyticsUI(calls, appointments, messages, extended = {}) {
            // Summary cards
            document.getElementById('statTotalCalls').textContent = calls.total || 0;
            document.getElementById('statAnsweredCalls').textContent = calls.answered || 0;
            document.getElementById('statMissedCalls').textContent = calls.missed || 0;
            document.getElementById('statAppointments').textContent = appointments || 0;

            // Extended metrics - After-hours
            document.getElementById('statAfterHoursCalls').textContent = extended.afterHoursCalls || 0;
            document.getElementById('statAfterHoursBookings').textContent = extended.afterHoursBookings || 0;

            // Extended metrics - Tokens
            const tokensAvailable = extended.tokensAvailable || 0;
            document.getElementById('statTokensAvailable').textContent = tokensAvailable >= 1000
                ? `${(tokensAvailable / 1000).toFixed(1)}k`
                : tokensAvailable.toFixed(0);
            document.getElementById('statTokenAvgRate').textContent = `${extended.tokenAvgRate || 0} min`;

            // Extended metrics - Average Conversation Time (convert seconds to mm:ss)
            const avgConvSeconds = extended.avgConversationTime || 0;
            const avgConvMinutes = Math.floor(avgConvSeconds / 60);
            const avgConvSecs = avgConvSeconds % 60;
            document.getElementById('statAvgConvTime').textContent = `${avgConvMinutes}:${avgConvSecs.toString().padStart(2, '0')}`;

            // Call details
            document.getElementById('statIncoming').textContent = calls.incoming || 0;
            document.getElementById('statOutgoing').textContent = calls.outgoing || 0;

            // Duration formatting
            const totalMinutes = Math.round((calls.duration || 0) / 60);
            document.getElementById('statDuration').textContent = totalMinutes > 60
                ? `${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m`
                : `${totalMinutes} min`;

            const avgDuration = calls.total > 0 ? Math.round((calls.duration || 0) / calls.total / 60) : 0;
            document.getElementById('statAvgDuration').textContent = `${avgDuration} min`;

            // Messages
            document.getElementById('statMessagesIn').textContent = messages.incoming || 0;
            document.getElementById('statMessagesOut').textContent = messages.outgoing || 0;

            // Answer rate
            const answerRate = calls.total > 0 ? Math.round((calls.answered / calls.total) * 100) : 0;
            document.getElementById('statAnswerRate').textContent = `${answerRate}%`;
            document.getElementById('answerRateBar').style.width = `${answerRate}%`;

            // Show content
            document.getElementById('analyticsLoading').style.display = 'none';
            document.getElementById('analyticsContent').style.display = 'block';
        }

        // Load contacts count on page load (multi-tenant secure)
        async function loadContactsCount() {
            try {
                // Fetch GHL credentials for this specific client
                const credsResponse = await authenticatedFetch(`/api/client/ghl-credentials/${CLIENT_ID}`);
                const credsData = await credsResponse.json();

                if (!credsData.success || !credsData.credentials) {
                    console.log(' No GHL integration - contacts count unavailable');
                    return;
                }

                const ghlCreds = credsData.credentials;

                const response = await authenticatedFetch('/api/ghl/contacts/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-ghl-api-key': ghlCreds.api_key,
                        'x-ghl-location-id': ghlCreds.location_id
                    },
                    body: JSON.stringify({ limit: 100 })
                });

                const data = await response.json();
                if (data.success && data.data?.total) {
                    const countEl = document.getElementById('contactsCount');
                    if (countEl) {
                        countEl.textContent = data.data.total;
                    }
                }
            } catch (error) {
                console.error('Error loading contacts count:', error);
            }
        }

        // Add to DOMContentLoaded - delay slightly to ensure CLIENT_ID is set
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(loadContactsCount, 1000);
        });
    </script>

</body>
</html>
